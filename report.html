<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çœŸç  | æ——è‰¦ç´šå‚™æ–™çµ±è¨ˆä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --p-green: #004d40; --p-gold: #b89150; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; text-align: left; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .print-container { width: 100% !important; max-width: none !important; }
            .print-card { border: 1px solid #ddd !important; box-shadow: none !important; break-inside: avoid; }
        }
    </style>
</head>
<body class="p-4 md:p-8 text-slate-700">

    <div class="max-w-[1400px] mx-auto print-container">
        <div class="flex justify-between items-end mb-8 border-b-2 border-p-green pb-4">
            <div class="text-left">
                <h1 class="text-4xl font-black text-p-green font-serif tracking-tighter">ç‡Ÿé‹å ±è¡¨ & å‚™æ–™çµ±è¨ˆ</h1>
                <p id="report-period-display" class="text-stone-400 text-sm mt-1 font-bold">è¼‰å…¥ä¸­...</p>
            </div>
            <div class="flex gap-3 no-print">
                <button onclick="window.print()" class="bg-white border border-stone-200 px-5 py-2.5 rounded-xl font-bold hover:bg-stone-50 transition shadow-sm">ğŸ–¨ï¸ åˆ—å°è¡¨å–®</button>
                <button onclick="exportFullData()" class="bg-p-green text-white px-5 py-2.5 rounded-xl font-bold shadow-lg hover:opacity-90 transition">ğŸ“Š åŒ¯å‡º Excel</button>
            </div>
        </div>

        <div class="bg-white p-8 rounded-[2rem] shadow-xl border mb-8 no-print text-left">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div class="md:col-span-2 space-y-4">
                    <label class="block text-xs font-black text-stone-400 uppercase tracking-widest">æ—¥æœŸç¯©é¸ç¶­åº¦ Date Range</label>
                    <div class="flex gap-2">
                        <button onclick="setDateRange('today')" class="flex-1 py-2 bg-stone-100 rounded-lg text-xs font-bold hover:bg-p-gold hover:text-white transition">ä»Šæ—¥</button>
                        <button onclick="setDateRange('month')" class="flex-1 py-2 bg-stone-100 rounded-lg text-xs font-bold hover:bg-p-gold hover:text-white transition">ç•¶æœˆ</button>
                    </div>
                    <div class="flex items-center gap-2 mt-2">
                        <input type="date" id="start-date" class="flex-1 border p-2.5 rounded-xl text-sm outline-none focus:border-p-gold">
                        <span class="text-stone-300">~</span>
                        <input type="date" id="end-date" class="flex-1 border p-2.5 rounded-xl text-sm outline-none focus:border-p-gold">
                    </div>
                </div>
                <div class="space-y-4">
                    <label class="block text-xs font-black text-stone-400 uppercase tracking-widest">æŒ‡å®šæ´»å‹•ä»£è™Ÿ Campaign</label>
                    <select id="report-campaign" class="w-full border p-2.5 rounded-xl bg-stone-50 outline-none focus:border-p-gold text-sm font-bold">
                        <option value="all">é¡¯ç¤ºå…¨éƒ¨ä¾†æº</option>
                        <option value="none">åƒ…é™ä¸€èˆ¬è¨‚å–® (ç„¡æ´»å‹•ä»£è™Ÿ)</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="fetchData()" class="w-full bg-stone-800 text-white py-4 rounded-2xl font-black shadow-lg hover:bg-black transition active:scale-95 tracking-widest">ç”Ÿæˆçµ±è¨ˆå ±è¡¨</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-5 space-y-6">
                <div class="bg-white rounded-[2.5rem] shadow-sm border overflow-hidden print-card">
                    <div class="bg-stone-800 p-6 flex justify-between items-center text-white">
                        <h3 class="font-bold font-serif tracking-widest italic">å»šæˆ¿å‚™æ–™ç¸½æ¸…å–®</h3>
                        <div id="total-dishes" class="text-xs bg-p-gold px-3 py-1 rounded-full font-bold">0 å“é …</div>
                    </div>
                    <div class="p-2 overflow-y-auto max-h-[80vh] custom-scrollbar">
                        <table class="w-full text-left">
                            <thead class="text-[10px] text-stone-400 uppercase border-b">
                                <tr>
                                    <th class="p-4">é£Ÿæ/èœè‰²åç¨±</th>
                                    <th class="p-4 text-right">éœ€æ±‚ç¸½é‡</th>
                                </tr>
                            </thead>
                            <tbody id="summary-body" class="divide-y text-left">
                                </tbody>
                        </table>
                    </div>
                    <div class="bg-stone-50 p-4 text-[10px] text-stone-400 text-center font-bold">
                        * çµ±è¨ˆå·²åŒ…å«å–®é»é …ç›®åŠå¥—é¤å…§å«èœè‰²
                    </div>
                </div>
            </div>

            <div class="lg:col-span-7 space-y-6">
                <div class="bg-white rounded-[2.5rem] shadow-sm border overflow-hidden print-card">
                    <div class="bg-p-green p-6 flex justify-between items-center text-white">
                        <h3 class="font-bold font-serif tracking-widest italic">é€å–®æ ¸å°æµæ°´å¸³</h3>
                        <div id="total-orders" class="text-xs bg-emerald-900 px-3 py-1 rounded-full font-bold text-emerald-100">0 ç­†</div>
                    </div>
                    <div id="detail-container" class="p-6 space-y-8 overflow-y-auto max-h-[80vh] custom-scrollbar">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
        const _s = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function init() {
            setDateRange('today');
            const { data } = await _s.from('campaign_settings').select('*');
            if(data) {
                const select = document.getElementById('report-campaign');
                data.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = opt.innerText = c.code_name;
                    select.appendChild(opt);
                });
            }
            fetchData();
        }

        function setDateRange(type) {
            const startInput = document.getElementById('start-date');
            const endInput = document.getElementById('end-date');
            const now = new Date();
            if(type === 'today') {
                const todayStr = now.toISOString().split('T')[0];
                startInput.value = endInput.value = todayStr;
            } else if(type === 'month') {
                startInput.value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                endInput.value = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
            }
        }

        async function fetchData() {
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            const campaign = document.getElementById('report-campaign').value;
            document.getElementById('report-period-display').innerText = `æœŸé–“ï¼š${start} è‡³ ${end}`;

            let query = _s.from('orders').select('*').order('created_at', {ascending: true});
            if(start && end) query = query.gte('created_at', `${start}T00:00:00`).lte('created_at', `${end}T23:59:59`);
            if(campaign === 'none') query = query.is('campaign_code', null);
            else if(campaign !== 'all') query = query.eq('campaign_code', campaign);

            const { data: orders, error } = await query;
            if(error) return alert("è¼‰å…¥å¤±æ•—");
            renderReports(orders || []);
        }

        function renderReports(orders) {
            const dishSummary = {};
            let orderHtml = "";

            orders.forEach((o, idx) => {
                o.order_content.forEach(item => {
                    // 1. å–å¾—è©²é …ç›®çš„åŸºæœ¬æ•¸é‡ (ä¾‹å¦‚ç´…ç³Ÿè‚‰ x2 -> 2)
                    const qtyMatch = item.name.match(/ x(\d+)/);
                    const baseQty = qtyMatch ? parseInt(qtyMatch[1]) : 1;

                    // 2. æ ¸å¿ƒé‚è¼¯ï¼šæ‹†è§£å¥—é¤å…§å®¹
                    // æª¢æŸ¥å“åä¸­æ˜¯å¦æœ‰æ‹¬è™Ÿ (å…§å®¹ç‰©)
                    const contentMatch = item.name.match(/\((.*?)\)/);
                    
                    if (contentMatch) {
                        // å¦‚æœæ˜¯å¥—é¤ï¼Œå°‡å…§å®¹æ‹†é–‹ (ä¾‹å¦‚: èœè‰²Aã€èœè‰²B)
                        const subItems = contentMatch[1].split('ã€');
                        subItems.forEach(subName => {
                            // å»é™¤å£å‘³æ¨™ç±¤å¦‚ [å°‘é¹½]
                            const cleanSubName = subName.split(' [')[0].trim();
                            if(!dishSummary[cleanSubName]) dishSummary[cleanSubName] = 0;
                            dishSummary[cleanSubName] += baseQty;
                        });
                    } else {
                        // å¦‚æœæ˜¯å–®é»ï¼Œç›´æ¥è¨ˆç®—å“å (å»é™¤æ•¸é‡èˆ‡å£å‘³æ¨™ç±¤)
                        const cleanName = item.name.split(' [')[0].replace(/ x\d+/g, "").trim();
                        if(!dishSummary[cleanName]) dishSummary[cleanName] = 0;
                        dishSummary[cleanName] += baseQty;
                    }
                });

                orderHtml += `
                <div class="pb-8 border-b border-stone-100 last:border-0 text-left">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="text-2xl font-black text-p-green font-serif">#${idx + 1} ${o.customer_name}</span>
                            <span class="ml-4 text-sm font-bold text-p-gold tracking-tighter">${o.phone}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-[10px] bg-stone-800 text-white px-3 py-1 rounded-full font-bold uppercase">${o.campaign_code || 'ä¸€èˆ¬é å®š'}</span>
                        </div>
                    </div>
                    <div class="flex gap-4 text-xs font-bold text-stone-400 mb-4 bg-stone-50 p-3 rounded-2xl">
                        <span>ğŸª‘ æ¡Œè™Ÿï¼š${o.table_no || 'æœªå¡«'}</span>
                        <span>ğŸ‘¥ äººæ•¸ï¼š${o.adult_count||0}å¤§ / ${o.kid_count||0}å°</span>
                        <span>ğŸ•’ è¨‚ä½ï¼š${o.booking_date ? new Date(o.booking_date).toLocaleString() : 'æœªå¡«'}</span>
                    </div>
                    <div class="space-y-1">
                        ${o.order_content.map(i => `<div class="flex justify-between text-sm py-1 border-b border-stone-50"><span class="text-slate-600 font-medium">â€¢ ${i.name}</span><span class="font-serif font-bold text-p-green">$${i.price}</span></div>`).join('')}
                    </div>
                    ${o.note ? `<div class="mt-4 p-4 bg-amber-50 border-l-4 border-p-gold rounded-r-xl text-xs text-amber-800 font-bold">å‚™è¨»ï¼š${o.note}</div>` : ''}
                </div>`;
            });

            const sortedDishes = Object.entries(dishSummary).sort((a,b) => b[1] - a[1]);
            document.getElementById('summary-body').innerHTML = sortedDishes.map(([name, count]) => `
                <tr class="hover:bg-stone-50 transition">
                    <td class="p-4 text-sm font-bold text-slate-700">${name}</td>
                    <td class="p-4 text-right"><span class="text-xl font-black text-p-green font-serif">${count}</span><span class="text-[10px] text-stone-300 font-bold ml-1">ä»½</span></td>
                </tr>`).join('');

            document.getElementById('detail-container').innerHTML = orders.length ? orderHtml : '<div class="py-20 text-center text-stone-300 font-bold">ç„¡è³‡æ–™</div>';
            document.getElementById('total-dishes').innerText = `${sortedDishes.length} å“é …`;
            document.getElementById('total-orders').innerText = `${orders.length} ç­†è¨‚å–®`;
            window.lastData = { dishSummary: sortedDishes, orders: orders };
        }

        function exportFullData() {
            if(!window.lastData) return alert("è«‹å…ˆæŸ¥è©¢");
            const { dishSummary, orders } = window.lastData;
            const start = document.getElementById('start-date').value;
            const ws1 = XLSX.utils.json_to_sheet(dishSummary.map(d => ({ "èœè‰²åç¨±": d[0], "å‚™æ–™ç¸½é‡": d[1] })));
            const ws2 = XLSX.utils.json_to_sheet(orders.map(o => ({
                "è¨‚ä½æ—¥æœŸ/æ™‚é–“": o.booking_date ? new Date(o.booking_date).toLocaleString() : "æœªå¡«",
                "é¡§å®¢å§“å": o.customer_name, "è¯çµ¡é›»è©±": o.phone, "æ´»å‹•ä»£è™Ÿ": o.campaign_code || "ä¸€èˆ¬",
                "æ¡Œè™Ÿ": o.table_no, "äººæ•¸": `${o.adult_count}å¤§${o.kid_count}å°`,
                "é»é¤å…§å®¹": o.order_content.map(i => i.name).join(' / '), "ç‰¹åˆ¥å‚™è¨»": o.note
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws1, "å‚™æ–™çµ±è¨ˆ");
            XLSX.utils.book_append_sheet(wb, ws2, "è¨‚å–®æ˜ç´°");
            XLSX.writeFile(wb, `çœŸç çµ±è¨ˆå ±è¡¨_${start}.xlsx`);
        }

        init();
    </script>
</body>
</html>
