<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœŸç  | ç²¾ç¢ºå‚™æ–™çµ±è¨ˆä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --green:#004d40; --green2:#00695c; --gold:#b89150; --gold2:#d4a85a; --cream:#f9f5f0; --ink:#1a2420; }
        * { box-sizing: border-box; margin:0; padding:0; }
        body { font-family:'Noto Sans TC',sans-serif; background:var(--cream); color:var(--ink); min-height:100vh; }
        .serif { font-family:'Noto Serif TC',serif; }

        /* â”€â”€ é ‚éƒ¨ç¯©é¸åˆ— â”€â”€ */
        #filter-panel {
            background: linear-gradient(135deg, var(--green) 0%, var(--green2) 100%);
            padding: 24px 32px 20px;
            box-shadow: 0 4px 24px rgba(0,77,64,.3);
        }
        .filter-label { font-size:9px; font-weight:700; letter-spacing:.18em; text-transform:uppercase; color:rgba(255,255,255,.45); display:block; margin-bottom:5px; }
        .f-input {
            background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.18);
            color:white; border-radius:10px; padding:9px 13px; font-size:13px; font-weight:600;
            outline:none; width:100%; transition:border .2s; font-family:'Noto Sans TC',sans-serif;
        }
        .f-input:focus { border-color:var(--gold2); }
        .f-input option { background:#1a2e2b; }
        .preset-btn {
            padding:6px 14px; border-radius:999px; font-size:11px; font-weight:700; cursor:pointer;
            border:1px solid rgba(255,255,255,.2); color:rgba(255,255,255,.55); background:transparent;
            transition:all .15s; white-space:nowrap; font-family:'Noto Sans TC',sans-serif;
        }
        .preset-btn:hover,.preset-btn.on { background:var(--gold); border-color:var(--gold); color:white; }
        .query-btn {
            background:var(--gold); color:white; border:none; border-radius:12px; padding:12px 32px;
            font-weight:700; font-size:14px; cursor:pointer; transition:all .2s; letter-spacing:.06em;
            font-family:'Noto Sans TC',sans-serif; box-shadow:0 4px 16px rgba(184,145,80,.4);
            white-space:nowrap;
        }
        .query-btn:hover { background:var(--gold2); transform:translateY(-1px); }
        .query-btn:active { transform:scale(.97); }
        .query-btn:disabled { opacity:.6; cursor:not-allowed; transform:none; }

        /* â”€â”€ KPI å¡ç‰‡ â”€â”€ */
        .kpi-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:12px; margin-bottom:28px; }
        .kpi { background:white; border-radius:16px; padding:18px 20px; border:1px solid rgba(0,0,0,.05); box-shadow:0 2px 10px rgba(0,0,0,.04); position:relative; overflow:hidden; }
        .kpi::after { content:''; position:absolute; top:0; left:0; right:0; height:3px; background:var(--gold); border-radius:3px 3px 0 0; }
        .kpi.g::after { background:var(--green); }
        .kpi.r::after { background:#f43f5e; }
        .kpi.b::after { background:#3b82f6; }
        .kpi-lbl { font-size:9px; font-weight:700; color:#94a3b8; letter-spacing:.12em; text-transform:uppercase; margin-bottom:6px; }
        .kpi-val { font-size:1.9rem; font-weight:900; color:var(--green); line-height:1; font-family:'Noto Serif TC',serif; }
        .kpi-sub { font-size:11px; color:#94a3b8; font-weight:600; margin-top:4px; }

        /* â”€â”€ åˆ†é  Tab â”€â”€ */
        .tabs { display:flex; gap:4px; background:#f1f5f9; border-radius:14px; padding:4px; margin-bottom:20px; }
        .tab { flex:1; padding:10px 6px; border-radius:10px; font-size:12px; font-weight:700; border:none; background:transparent; color:#94a3b8; cursor:pointer; transition:all .15s; font-family:'Noto Sans TC',sans-serif; white-space:nowrap; }
        .tab.on { background:white; color:var(--green); box-shadow:0 1px 8px rgba(0,0,0,.08); }

        /* â”€â”€ å¡ç‰‡å®¹å™¨ â”€â”€ */
        .panel { background:white; border-radius:20px; border:1px solid rgba(184,145,80,.12); box-shadow:0 4px 20px rgba(0,0,0,.05); overflow:hidden; }
        .panel-head { padding:16px 22px; display:flex; justify-content:space-between; align-items:center; }
        .panel-title { font-weight:700; font-family:'Noto Serif TC',serif; letter-spacing:.06em; font-size:15px; }
        .badge { border-radius:999px; font-size:11px; font-weight:700; padding:4px 14px; }

        /* â”€â”€ å‚™æ–™è¡¨æ ¼ â”€â”€ */
        .prep-table { width:100%; border-collapse:collapse; font-size:13px; }
        .prep-table thead th { background:#f8fafc; color:#94a3b8; font-size:9px; font-weight:700; letter-spacing:.12em; text-transform:uppercase; padding:10px 18px; text-align:left; border-bottom:1px solid #f1f5f9; }
        .prep-table tbody td { padding:12px 18px; border-bottom:1px solid #fafaf8; vertical-align:middle; }
        .prep-table tbody tr:last-child td { border-bottom:none; }
        .prep-table tbody tr:hover td { background:#fafaf8; }
        .bar-wrap { background:#f1f5f9; border-radius:999px; height:5px; overflow:hidden; }
        .bar-fill { background:var(--gold); height:100%; border-radius:999px; transition:width .5s ease; }

        /* â”€â”€ å¥—é¤å¡ç‰‡ â”€â”€ */
        .set-card { display:flex; justify-content:space-between; align-items:center; padding:14px 18px; background:#f9f5f0; border-radius:14px; border:1px solid rgba(184,145,80,.15); }
        .set-name { font-weight:700; color:var(--green); font-size:14px; }
        .set-count { font-family:'Noto Serif TC',serif; font-weight:900; color:var(--gold); font-size:26px; line-height:1; }

        /* â”€â”€ è¨‚å–®å¡ç‰‡ â”€â”€ */
        .order-card { border-radius:18px; border:1px solid #f1f5f9; overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,.04); }
        .order-head { background:linear-gradient(135deg,var(--green),var(--green2)); padding:14px 20px; display:flex; justify-content:space-between; align-items:flex-start; }
        .order-idx { color:rgba(255,255,255,.4); font-size:10px; font-weight:700; }
        .order-name { color:white; font-size:18px; font-weight:900; font-family:'Noto Serif TC',serif; }
        .order-phone { color:var(--gold2); font-size:12px; font-weight:700; margin-top:2px; }
        .order-meta { display:flex; gap:8px; flex-wrap:wrap; padding:12px 18px; border-bottom:1px solid #f8fafc; }
        .meta-pip { background:#f8fafc; border-radius:8px; padding:5px 12px; font-size:11px; font-weight:700; color:#64748b; }
        .meta-pip span { color:var(--green); }
        .order-lines { padding:10px 18px; }
        .order-line { display:flex; justify-content:space-between; padding:7px 0; border-bottom:1px solid #f8fafc; font-size:12px; }
        .order-line:last-child { border-bottom:none; }
        .order-foot { padding:10px 18px; background:#fafaf8; display:flex; justify-content:flex-end; align-items:center; gap:8px; }
        .order-note-bar { margin:0 18px 14px; padding:10px 14px; background:#f0fdf4; border-left:3px solid var(--green); border-radius:0 8px 8px 0; font-size:12px; color:var(--green); font-weight:600; }

        /* â”€â”€ åŒ¯å‡ºæŒ‰éˆ• â”€â”€ */
        .exp-btn { display:flex; align-items:center; gap:6px; padding:10px 20px; border-radius:10px; font-weight:700; font-size:13px; cursor:pointer; border:none; font-family:'Noto Sans TC',sans-serif; transition:all .15s; }
        .exp-pdf   { background:#fee2e2; color:#dc2626; }
        .exp-pdf:hover   { background:#fecaca; }
        .exp-excel { background:#dcfce7; color:#16a34a; }
        .exp-excel:hover { background:#bbf7d0; }

        /* â”€â”€ æ²å‹• â”€â”€ */
        .scroll-z { overflow-y:auto; }
        .scroll-z::-webkit-scrollbar { width:4px; }
        .scroll-z::-webkit-scrollbar-thumb { background:var(--gold); border-radius:4px; }

        /* â”€â”€ ç©ºç™½ â”€â”€ */
        .empty { padding:40px; text-align:center; color:#cbd5e1; font-weight:700; font-size:13px; }

        /* â”€â”€ Spinner â”€â”€ */
        .spin { display:inline-block; width:16px; height:16px; border:2px solid rgba(255,255,255,.3); border-top-color:white; border-radius:50%; animation:rot .6s linear infinite; }
        @keyframes rot { to { transform:rotate(360deg); } }

        /* â”€â”€ åˆ—å° â”€â”€ */
        @media print {
            #filter-panel, .tabs, .no-print { display:none !important; }
            body { background:white !important; }
            .print-show { display:block !important; }
            .panel { box-shadow:none !important; border:1px solid #ddd !important; break-inside:avoid; }
            .order-card { box-shadow:none !important; border:1px solid #ddd !important; break-inside:avoid; }
            .kpi { box-shadow:none !important; border:1px solid #ddd !important; }
            #tab-prepare,#tab-setmenu,#tab-orders { display:block !important; margin-bottom:28px; }
            .scroll-z { max-height:none !important; overflow:visible !important; }
            .print-header { display:flex !important; }
        }
        .print-header { display:none; justify-content:space-between; align-items:flex-end; margin-bottom:20px; border-bottom:2px solid var(--green); padding-bottom:12px; }
    </style>
</head>
<body>

<!-- â•â•â•â•â•â•â• ç¯©é¸åˆ— â•â•â•â•â•â•â• -->
<div id="filter-panel" class="no-print">
    <div class="max-w-[1400px] mx-auto">

        <!-- æ¨™é¡Œè¡Œ -->
        <div class="flex justify-between items-center mb-5">
            <div class="flex items-center gap-3">
                <div class="w-1 h-7 rounded-full" style="background:var(--gold)"></div>
                <h1 class="serif text-white text-xl font-black tracking-widest">å‚™æ–™çµ±è¨ˆä¸­å¿ƒ</h1>
                <span id="period-tag" class="text-xs font-bold px-3 py-1 rounded-full" style="background:rgba(184,145,80,.2);color:var(--gold2)">å°šæœªæŸ¥è©¢</span>
            </div>
            <div class="flex gap-3">
                <button onclick="doPrint()" class="exp-btn exp-pdf no-print">ğŸ–¨ åˆ—å° PDF</button>
                <button onclick="exportExcel()" class="exp-btn exp-excel no-print">ğŸ“Š åŒ¯å‡º Excel</button>
            </div>
        </div>

        <!-- ç¯©é¸æ§ä»¶ -->
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-7 gap-4 items-end">
            <div class="sm:col-span-1">
                <span class="filter-label">å¿«é€Ÿé¸æ“‡</span>
                <div class="flex flex-wrap gap-1.5">
                    <button class="preset-btn" onclick="setPreset('today')">ä»Šæ—¥</button>
                    <button class="preset-btn" onclick="setPreset('yesterday')">æ˜¨æ—¥</button>
                    <button class="preset-btn" onclick="setPreset('week')">æœ¬é€±</button>
                    <button class="preset-btn" onclick="setPreset('month')">æœ¬æœˆ</button>
                </div>
            </div>
            <div>
                <span class="filter-label">é–‹å§‹æ—¥æœŸ</span>
                <input type="date" id="f-s-date" class="f-input">
            </div>
            <div>
                <span class="filter-label">çµæŸæ—¥æœŸ</span>
                <input type="date" id="f-e-date" class="f-input">
            </div>
            <div>
                <span class="filter-label">é–‹å§‹æ™‚é–“</span>
                <input type="time" id="f-s-time" value="00:00" class="f-input">
            </div>
            <div>
                <span class="filter-label">çµæŸæ™‚é–“</span>
                <input type="time" id="f-e-time" value="23:59" class="f-input">
            </div>
            <div>
                <span class="filter-label">æ´»å‹•ä»£è™Ÿ</span>
                <select id="f-campaign" class="f-input">
                    <option value="all">å…¨éƒ¨ä¾†æº</option>
                    <option value="none">ä¸€èˆ¬è¨‚å–®</option>
                </select>
            </div>
            <div class="flex items-end">
                <button id="run-btn" onclick="runReport()" class="query-btn w-full">
                    <span id="run-lbl">â–¶ æŸ¥è©¢çµ±è¨ˆ</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â• ä¸»å…§å®¹ â•â•â•â•â•â•â• -->
<div class="max-w-[1400px] mx-auto px-4 md:px-8 py-8">

    <!-- åˆ—å°æ¨™é ­ -->
    <div class="print-header">
        <div>
            <div style="font-size:24px;font-weight:900;color:var(--green);font-family:'Noto Serif TC',serif;letter-spacing:.1em">çœŸç  å‚™æ–™çµ±è¨ˆå ±è¡¨</div>
            <div id="print-period" style="color:var(--gold);font-size:13px;font-weight:700;margin-top:4px"></div>
        </div>
        <div style="font-size:11px;color:#94a3b8;font-weight:700">åˆ—å°æ™‚é–“ï¼š<span id="print-time"></span></div>
    </div>

    <!-- KPI ç¸½è¦½ -->
    <div class="kpi-row">
        <div class="kpi g"><div class="kpi-lbl">è¨‚å–®æ•¸</div><div class="kpi-val" id="kpi-orders">â€”</div><div class="kpi-sub">ç­†è¨‚å–®</div></div>
        <div class="kpi"><div class="kpi-lbl">å¤§äºº</div><div class="kpi-val" id="kpi-adult">â€”</div><div class="kpi-sub">ä½å¤§äºº</div></div>
        <div class="kpi"><div class="kpi-lbl">å°å­©</div><div class="kpi-val" id="kpi-kid">â€”</div><div class="kpi-sub">ä½å°å­©</div></div>
        <div class="kpi" style="border-top-color:#fb923c!important"><div class="kpi-lbl">å…’ç«¥</div><div class="kpi-val" id="kpi-child">â€”</div><div class="kpi-sub">ä½å…’ç«¥</div></div>
        <div class="kpi b"><div class="kpi-lbl">ç¸½äººæ•¸</div><div class="kpi-val" id="kpi-total-people">â€”</div><div class="kpi-sub">ä½ç”¨é¤</div></div>
        <div class="kpi"><div class="kpi-lbl">å¥—é¤çµ„æ•¸</div><div class="kpi-val" id="kpi-sets">â€”</div><div class="kpi-sub">çµ„å¥—é¤</div></div>
        <div class="kpi"><div class="kpi-lbl">å‚™æ–™å“é …</div><div class="kpi-val" id="kpi-items">â€”</div><div class="kpi-sub">ç¨®å“é …</div></div>
        <div class="kpi r"><div class="kpi-lbl">é ä¼°ç‡Ÿæ”¶</div><div class="kpi-val" id="kpi-rev" style="font-size:1.4rem">â€”</div><div class="kpi-sub">å…ƒï¼ˆæœªå«æœå‹™è²»ï¼‰</div></div>
    </div>

    <!-- Tab åˆ— -->
    <div class="tabs no-print">
        <button class="tab on" onclick="switchTab('prepare')">ğŸ³ å‚™æ–™ç¸½è¡¨</button>
        <button class="tab"    onclick="switchTab('setmenu')">ğŸ± å¥—é¤æ˜ç´°</button>
        <button class="tab"    onclick="switchTab('orders')">ğŸ“‹ è¨‚å–®æµæ°´å¸³</button>
    </div>

    <!-- Tab: å‚™æ–™ç¸½è¡¨ -->
    <div id="tab-prepare">
        <div class="panel">
            <div class="panel-head" style="background:var(--ink)">
                <div class="flex items-center gap-2">
                    <span style="font-size:18px">ğŸ³</span>
                    <span class="panel-title" style="color:white">å…¨å“é …å‚™æ–™ç¸½é‡ï¼ˆå«å¥—é¤æ‹†è§£ã€å–®é»ã€åŠ è³¼ï¼‰</span>
                </div>
                <span id="badge-items" class="badge" style="background:rgba(255,255,255,.12);color:rgba(255,255,255,.7)">0 é …</span>
            </div>
            <div class="scroll-z" style="max-height:65vh">
                <table class="prep-table">
                    <thead>
                        <tr>
                            <th style="width:44px">#</th>
                            <th>å“å</th>
                            <th style="text-align:right;width:110px">å‚™æ–™æ•¸</th>
                            <th style="width:180px" class="no-print">ä½”æ¯”</th>
                        </tr>
                    </thead>
                    <tbody id="prep-body">
                        <tr><td colspan="4" class="empty">å°šæœªæŸ¥è©¢ï¼Œè«‹å…ˆè¨­å®šç¯©é¸æ¢ä»¶</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tab: å¥—é¤æ˜ç´° -->
    <div id="tab-setmenu" class="hidden">
        <div class="panel">
            <div class="panel-head" style="background:var(--green)">
                <div class="flex items-center gap-2">
                    <span style="font-size:18px">ğŸ±</span>
                    <span class="panel-title" style="color:white">å¥—é¤éŠ·å”®æ˜ç´°</span>
                </div>
                <span id="badge-sets" class="badge" style="background:rgba(255,255,255,.12);color:rgba(255,255,255,.7)">0 å¥—</span>
            </div>
            <div class="p-6 space-y-3" id="setmenu-body">
                <div class="empty">å°šæœªæŸ¥è©¢</div>
            </div>
        </div>
    </div>

    <!-- Tab: è¨‚å–®æµæ°´å¸³ -->
    <div id="tab-orders" class="hidden">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-2">
                <div style="width:4px;height:22px;background:var(--gold);border-radius:2px"></div>
                <h3 class="serif font-bold text-base" style="color:var(--green)">è¨‚å–®è©³ç´°æµæ°´å¸³</h3>
            </div>
            <span id="badge-orders" class="badge" style="background:var(--green);color:white">0 ç­†</span>
        </div>
        <div id="orders-body" class="space-y-4">
            <div class="empty bg-white rounded-2xl">å°šæœªæŸ¥è©¢</div>
        </div>
    </div>

</div>

<script>
const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
const _s = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let cache = null;

// â”€â”€ åˆå§‹åŒ– â”€â”€
async function init() {
    setPreset('today');
    const { data } = await _s.from('campaign_settings').select('*');
    if (data) {
        const sel = document.getElementById('f-campaign');
        data.forEach(c => {
            const o = document.createElement('option');
            o.value = o.innerText = c.code_name;
            sel.appendChild(o);
        });
    }
}
init();

// â”€â”€ å¿«é€Ÿæ—¥æœŸé è¨­ â”€â”€
function setPreset(type) {
    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('on'));
    const b = document.querySelector(`.preset-btn[onclick="setPreset('${type}')"]`);
    if (b) b.classList.add('on');
    const now   = new Date();
    const today = now.toISOString().split('T')[0];
    const sd    = document.getElementById('f-s-date');
    const ed    = document.getElementById('f-e-date');
    if (type === 'today') {
        sd.value = ed.value = today;
    } else if (type === 'yesterday') {
        const y = new Date(now); y.setDate(y.getDate() - 1);
        sd.value = ed.value = y.toISOString().split('T')[0];
    } else if (type === 'week') {
        const mon = new Date(now);
        mon.setDate(now.getDate() - ((now.getDay() + 6) % 7));
        sd.value = mon.toISOString().split('T')[0];
        ed.value = today;
    } else if (type === 'month') {
        sd.value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        ed.value = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
    }
}

// â”€â”€ åŸ·è¡ŒæŸ¥è©¢ â”€â”€
async function runReport() {
    const sd  = document.getElementById('f-s-date').value;
    const ed  = document.getElementById('f-e-date').value;
    const st  = document.getElementById('f-s-time').value || '00:00';
    const et  = document.getElementById('f-e-time').value || '23:59';
    const cam = document.getElementById('f-campaign').value;
    if (!sd || !ed) return alert('è«‹é¸æ“‡æ—¥æœŸå€é–“');

    const btn = document.getElementById('run-btn');
    const lbl = document.getElementById('run-lbl');
    btn.disabled = true;
    lbl.innerHTML = '<span class="spin"></span>';

    let q = _s.from('orders').select('*')
        .gte('created_at', `${sd}T${st}:00`)
        .lte('created_at', `${ed}T${et}:59`)
        .order('created_at', { ascending: true });
    if (cam === 'none')     q = q.is('campaign_code', null);
    else if (cam !== 'all') q = q.eq('campaign_code', cam);

    const { data: orders, error } = await q;
    btn.disabled = false;
    lbl.innerText = 'â–¶ æŸ¥è©¢çµ±è¨ˆ';

    if (error) { alert('æŸ¥è©¢å¤±æ•—ï¼š' + error.message); return; }

    const camLabel = cam === 'all' ? 'å…¨éƒ¨' : cam === 'none' ? 'ä¸€èˆ¬è¨‚å–®' : cam;
    const periodStr = `${sd} ${st} ï½ ${ed} ${et}ã€€ï½œã€€${camLabel}`;
    document.getElementById('period-tag').innerText = periodStr;
    document.getElementById('print-period').innerText = periodStr;
    document.getElementById('print-time').innerText = new Date().toLocaleString('zh-TW');

    processAndRender(orders || []);
}

// â”€â”€ è³‡æ–™è™•ç† & æ¸²æŸ“ â”€â”€
function processAndRender(orders) {
    const dishCount    = {};
    const setMenuCount = {};
    let totalAdult = 0, totalKid = 0, totalChild = 0, totalRev = 0;

    orders.forEach(o => {
        totalAdult  += (o.adult_count  || 0);
        totalKid    += (o.kid_count    || 0);
        totalChild  += (o.child_count  || 0);
        totalRev    += (o.total_price  || 0);

        (o.order_content || []).forEach(item => {
            const qtyM = item.name.match(/ x(\d+)/);
            const qty  = qtyM ? parseInt(qtyM[1]) : 1;

            // âœ… ä¿®æ­£ï¼šå…ˆå»æ‰å£å‘³æ¨™ç±¤ [xxx] åŠæ•¸é‡æ¨™è¨˜ï¼Œå®Œæ•´ä¿ç•™å“å
            let cleanName = item.name.replace(/\s*\[.*?\]/g, '').replace(/ x\d+/g, '').trim();

            // âœ… ä¿®æ­£ï¼šå¥—é¤åˆ¤æ–·å¿…é ˆç¬¦åˆã€Œå¥—é¤å ç©ºæ ¼( å“é …Aã€å“é …B )ã€æ ¼å¼
            // æ‹¬è™Ÿå…§å«ã€Œã€ã€æ‰è¦–ç‚ºå¥—é¤æ‹†è§£ï¼Œé¿å…ã€ŒåŠ è³¼ xxxã€è¢«èª¤åˆ¤æˆªæ–·
            const setMatch = cleanName.match(/^(.+?)\s+\((.+)\)$/);
            const isSet    = setMatch && setMatch[2].includes('ã€');

            if (isSet) {
                const brand = setMatch[1].trim();
                setMenuCount[brand] = (setMenuCount[brand] || 0) + qty;
                setMatch[2].split('ã€').forEach(sub => {
                    const s = sub.replace(/\s*\[.*?\]/g, '').trim();
                    if (s) dishCount[s] = (dishCount[s] || 0) + qty;
                });
            } else {
                // éå¥—é¤ï¼šå®Œæ•´ä¿ç•™å“åï¼ˆå«ã€ŒåŠ è³¼ xxxã€ã€Œé™„é¤ xxxã€ç­‰æ‹¬è™Ÿèªªæ˜ï¼‰
                dishCount[cleanName] = (dishCount[cleanName] || 0) + qty;
            }
        });
    });

    const sorted   = Object.entries(dishCount).sort((a, b) => b[1] - a[1]);
    const totalSets= Object.values(setMenuCount).reduce((a, b) => a + b, 0);
    const maxQty   = sorted[0]?.[1] || 1;

    cache = { orders, dishCount, setMenuCount, sorted, totalAdult, totalKid, totalChild, totalRev, totalSets };

    // â”€â”€ KPI â”€â”€
    document.getElementById('kpi-orders').innerText       = orders.length;
    document.getElementById('kpi-adult').innerText        = totalAdult;
    document.getElementById('kpi-kid').innerText          = totalKid;
    document.getElementById('kpi-child').innerText        = totalChild;
    document.getElementById('kpi-total-people').innerText = totalAdult + totalKid + totalChild;
    document.getElementById('kpi-sets').innerText         = totalSets;
    document.getElementById('kpi-items').innerText        = sorted.length;
    document.getElementById('kpi-rev').innerText          = '$' + totalRev.toLocaleString();

    // â”€â”€ Badge â”€â”€
    document.getElementById('badge-items').innerText  = `${sorted.length} é …`;
    document.getElementById('badge-sets').innerText   = `${totalSets} å¥—`;
    document.getElementById('badge-orders').innerText = `${orders.length} ç­†`;

    // â”€â”€ å‚™æ–™è¡¨ â”€â”€
    document.getElementById('prep-body').innerHTML = sorted.length === 0
        ? `<tr><td colspan="4" class="empty">æŸ¥ç„¡è³‡æ–™</td></tr>`
        : sorted.map(([name, count], i) => `
            <tr>
                <td class="text-xs font-bold" style="color:#cbd5e1">${i + 1}</td>
                <td class="font-bold" style="color:var(--ink)">${name}</td>
                <td style="text-align:right">
                    <span class="serif font-black text-2xl" style="color:var(--green)">${count}</span>
                    <span class="text-xs ml-1" style="color:#cbd5e1">ä»½</span>
                </td>
                <td class="no-print" style="padding-right:22px">
                    <div class="bar-wrap"><div class="bar-fill" style="width:${Math.round(count / maxQty * 100)}%"></div></div>
                </td>
            </tr>`).join('');

    // â”€â”€ å¥—é¤æ˜ç´° â”€â”€
    document.getElementById('setmenu-body').innerHTML = Object.keys(setMenuCount).length === 0
        ? `<div class="empty">æŸ¥ç„¡å¥—é¤è¨‚å–®</div>`
        : Object.entries(setMenuCount).sort((a, b) => b[1] - a[1]).map(([name, count]) => `
            <div class="set-card">
                <div>
                    <div class="set-name">${name}</div>
                    <div class="text-xs font-semibold mt-0.5" style="color:#94a3b8">å¥—é¤çµ„åˆ</div>
                </div>
                <div class="flex items-baseline gap-1">
                    <span class="set-count">${count}</span>
                    <span class="text-xs font-bold" style="color:#94a3b8">çµ„</span>
                </div>
            </div>`).join('');

    // â”€â”€ è¨‚å–®æµæ°´å¸³ â”€â”€
    document.getElementById('orders-body').innerHTML = orders.length === 0
        ? `<div class="empty bg-white rounded-2xl">æŸ¥ç„¡è¨‚å–®</div>`
        : orders.map((o, idx) => `
            <div class="order-card">
                <div class="order-head">
                    <div>
                        <div class="order-idx"># ${String(idx + 1).padStart(3, '0')}</div>
                        <div class="order-name">${o.customer_name || 'â€”'}</div>
                        <div class="order-phone">${o.phone || 'â€”'}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="color:rgba(255,255,255,.4);font-size:10px;font-weight:700">
                            ${new Date(o.created_at).toLocaleString('zh-TW', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' })}
                        </div>
                        ${o.campaign_code ? `<span style="background:rgba(184,145,80,.3);color:var(--gold2);font-size:10px;font-weight:700;padding:3px 10px;border-radius:999px;display:inline-block;margin-top:4px">${o.campaign_code}</span>` : ''}
                    </div>
                </div>
                <div class="order-meta">
                    ${o.table_no ? `<div class="meta-pip">æ¡Œè™Ÿ <span>${o.table_no}</span></div>` : ''}
                    <div class="meta-pip">å¤§äºº <span>${o.adult_count || 0}</span> ä½</div>
                    <div class="meta-pip">å°å­© <span>${o.kid_count || 0}</span> ä½</div>
                    <div class="meta-pip">å…’ç«¥ <span>${o.child_count || 0}</span> ä½</div>
                    <div class="meta-pip">åˆè¨ˆ <span style="color:var(--gold);font-size:13px">$${o.total_price || 0}</span></div>
                </div>
                <div class="order-lines">
                    ${(o.order_content || []).map(item => `
                        <div class="order-line">
                            <span style="color:#475569;font-weight:500">â€¢ ${item.name}</span>
                            <span style="color:var(--gold);font-weight:700;white-space:nowrap;margin-left:8px">$${item.price}</span>
                        </div>`).join('')}
                </div>
                <div class="order-foot">
                    <span style="font-size:11px;color:#94a3b8;font-weight:700">è¨‚å–®åˆè¨ˆ</span>
                    <span class="serif font-black text-lg" style="color:var(--green)">$${o.total_price || 0}</span>
                </div>
                ${o.note ? `<div class="order-note-bar">ğŸ“ ${o.note}</div>` : ''}
            </div>`).join('');
}

// â”€â”€ Tab åˆ‡æ› â”€â”€
function switchTab(name) {
    ['prepare', 'setmenu', 'orders'].forEach(t => {
        document.getElementById(`tab-${t}`).classList.toggle('hidden', t !== name);
    });
    document.querySelectorAll('.tab').forEach((b, i) => {
        b.classList.toggle('on', ['prepare', 'setmenu', 'orders'][i] === name);
    });
}

// â”€â”€ åˆ—å° â”€â”€
function doPrint() {
    ['prepare', 'setmenu', 'orders'].forEach(t =>
        document.getElementById(`tab-${t}`).classList.remove('hidden'));
    window.print();
    setTimeout(() => switchTab('prepare'), 500);
}

// â”€â”€ åŒ¯å‡º Excelï¼ˆç¾åŒ–ç‰ˆï¼‰â”€â”€
function exportExcel() {
    if (!cache) return alert('è«‹å…ˆåŸ·è¡ŒæŸ¥è©¢');
    const { orders, setMenuCount, sorted, totalAdult, totalKid, totalChild, totalRev, totalSets } = cache;
    const wb = XLSX.utils.book_new();

    // â•â• è‰²ç¥¨ â•â•
    const C_GREEN  = '004D40';
    const C_GOLD   = 'B89150';
    const C_WHITE  = 'FFFFFF';
    const C_STRIPE = 'F0FDF9';  // æ·¡ç¶ äº¤æ›¿åˆ—
    const C_TEXT   = '1A2420';
    const C_GRAY   = '94A3B8';

    // â”€â”€ é€šç”¨æ¨£å¼å·¥å»  â”€â”€
    const headStyle = (bg = C_GREEN) => ({
        font:      { bold: true, color: { rgb: C_WHITE }, sz: 11, name: 'Noto Sans TC' },
        fill:      { patternType: 'solid', fgColor: { rgb: bg } },
        alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
        border: {
            bottom: { style: 'medium', color: { rgb: C_GOLD } },
            right:  { style: 'thin',   color: { rgb: C_GOLD } },
        }
    });
    const cellStyle = (isEvenRow, align = 'center', bold = false, color = C_TEXT) => ({
        font:      { sz: 10, bold, color: { rgb: color }, name: 'Noto Sans TC' },
        fill:      { patternType: 'solid', fgColor: { rgb: isEvenRow ? C_STRIPE : C_WHITE } },
        alignment: { horizontal: align, vertical: 'center', wrapText: true },
        border: {
            bottom: { style: 'hair', color: { rgb: 'E2E8F0' } },
            right:  { style: 'hair', color: { rgb: 'E2E8F0' } },
        }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // åˆ†é  1ï¼šé€æ¡Œæ˜ç´°ï¼ˆæ¯é“èœä¸€åˆ—ï¼Œæ¨£å¼ç¾åŒ–ï¼‰
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const aoa = [['æ¡Œè™Ÿ','å§“å','æ‰‹æ©Ÿ','å¤§äºº','å°å­©','å…’ç«¥','æ´»å‹•','åº','èœè‰²åç¨±','å–®åƒ¹','è¨‚å–®åˆè¨ˆ','æ™‚é–“','å‚™è¨»']];

    const sorted_orders = [...orders].sort((a, b) =>
        (a.table_no || 'zzz').localeCompare(b.table_no || 'zzz', 'zh-TW', { numeric: true })
    );

    sorted_orders.forEach(o => {
        const items   = o.order_content || [];
        const timeStr = new Date(o.created_at).toLocaleString('zh-TW', {
            month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12: false
        });
        items.forEach((item, i) => {
            aoa.push([
                i === 0 ? (o.table_no || 'â€”')        : '',
                i === 0 ? (o.customer_name || 'â€”')   : '',
                i === 0 ? (o.phone || 'â€”')            : '',
                i === 0 ? (o.adult_count  || 0)       : '',
                i === 0 ? (o.kid_count    || 0)       : '',
                i === 0 ? (o.child_count  || 0)       : '',
                i === 0 ? (o.campaign_code || 'â€”')    : '',
                i + 1,                                     // åºï¼ˆç¬¬å¹¾é“ï¼‰
                item.name,                                 // èœè‰²åç¨± â€” æ¯é“ä¸€æ ¼
                item.price ?? '',
                i === 0 ? (o.total_price || 0)        : '',
                i === 0 ? timeStr                     : '',
                i === 0 ? (o.note || '')              : '',
            ]);
        });
        aoa.push(new Array(13).fill(''));  // è¨‚å–®é–“ç©ºç™½åˆ—
    });

    const ws1 = XLSX.utils.aoa_to_sheet(aoa);

    // æ¬„å¯¬
    ws1['!cols'] = [
        {wch:8},{wch:12},{wch:14},{wch:5},{wch:5},{wch:5},
        {wch:10},{wch:4},{wch:38},{wch:8},{wch:10},{wch:16},{wch:22}
    ];

    // å¥—ç”¨æ¨™é¡Œåˆ—æ¨£å¼
    const COLS = ['A','B','C','D','E','F','G','H','I','J','K','L','M'];
    COLS.forEach(c => {
        const cell = ws1[c + '1'];
        if (cell) cell.s = headStyle();
    });

    // å¥—ç”¨è³‡æ–™åˆ—æ¨£å¼
    let rowIdx = 2;
    sorted_orders.forEach((o, oi) => {
        const items    = o.order_content || [];
        const isEven   = oi % 2 === 0;
        items.forEach(() => {
            COLS.forEach((c, ci) => {
                const addr = c + rowIdx;
                if (!ws1[addr]) ws1[addr] = { v: '', t: 's' };
                const isNameCol  = ci === 8;   // èœè‰²åç¨±æ¬„
                const isTopInfo  = ci < 2;     // æ¡Œè™Ÿ/å§“å
                ws1[addr].s = cellStyle(
                    isEven,
                    isNameCol ? 'left' : 'center',
                    isTopInfo,
                    isNameCol ? C_GREEN : C_TEXT
                );
            });
            rowIdx++;
        });
        rowIdx++; // ç©ºç™½åˆ—
    });

    // å‡çµé¦–åˆ—
    ws1['!freeze'] = { xSplit: 0, ySplit: 1 };

    XLSX.utils.book_append_sheet(wb, ws1, 'ğŸª‘ é€æ¡Œæ˜ç´°');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // åˆ†é  2ï¼šæ‘˜è¦
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const summaryAoa = [
        ['é …ç›®', 'æ•¸å€¼'],
        ['è¨‚å–®æ•¸',    orders.length],
        ['å¤§äººäººæ•¸',  totalAdult],
        ['å°å­©äººæ•¸',  totalKid],
        ['å…’ç«¥äººæ•¸',  totalChild],
        ['ç¸½äººæ•¸',    totalAdult + totalKid + totalChild],
        ['å¥—é¤çµ„æ•¸',  totalSets],
        ['å‚™æ–™å“é …æ•¸',sorted.length],
        ['é ä¼°ç‡Ÿæ”¶',  totalRev],
    ];
    const ws2 = XLSX.utils.aoa_to_sheet(summaryAoa);
    ws2['!cols'] = [{wch:16},{wch:14}];
    ['A','B'].forEach(c => { if (ws2[c+'1']) ws2[c+'1'].s = headStyle(); });
    for (let r = 2; r <= summaryAoa.length; r++) {
        const isEven = r % 2 === 0;
        if (ws2['A'+r]) ws2['A'+r].s = cellStyle(isEven, 'left', true, C_GREEN);
        if (ws2['B'+r]) ws2['B'+r].s = cellStyle(isEven, 'center', false, C_TEXT);
    }
    XLSX.utils.book_append_sheet(wb, ws2, 'ğŸ“Š æ‘˜è¦');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // åˆ†é  3ï¼šå‚™æ–™ç¸½è¡¨
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const prepAoa = [['æ’å','å“å','å‚™æ–™æ•¸é‡']];
    sorted.forEach(([name, count], i) => prepAoa.push([i + 1, name, count]));
    const ws3 = XLSX.utils.aoa_to_sheet(prepAoa);
    ws3['!cols'] = [{wch:6},{wch:36},{wch:12}];
    ['A','B','C'].forEach(c => { if (ws3[c+'1']) ws3[c+'1'].s = headStyle(); });
    for (let r = 2; r <= prepAoa.length; r++) {
        const isEven = r % 2 === 0;
        if (ws3['A'+r]) ws3['A'+r].s = cellStyle(isEven,'center',false,C_GRAY);
        if (ws3['B'+r]) ws3['B'+r].s = cellStyle(isEven,'left',  true, C_GREEN);
        if (ws3['C'+r]) ws3['C'+r].s = { ...cellStyle(isEven,'center',true,C_GREEN),
            font: { sz:14, bold:true, color:{ rgb:C_GREEN }, name:'Noto Serif TC' } };
    }
    XLSX.utils.book_append_sheet(wb, ws3, 'ğŸ³ å‚™æ–™ç¸½è¡¨');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // åˆ†é  4ï¼šå¥—é¤æ˜ç´°
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const setAoa = [['å¥—é¤åç¨±','éŠ·å”®çµ„æ•¸']];
    Object.entries(setMenuCount).sort((a,b)=>b[1]-a[1]).forEach(([name,count]) => setAoa.push([name,count]));
    const ws4 = XLSX.utils.aoa_to_sheet(setAoa);
    ws4['!cols'] = [{wch:30},{wch:12}];
    ['A','B'].forEach(c => { if (ws4[c+'1']) ws4[c+'1'].s = headStyle(); });
    for (let r = 2; r <= setAoa.length; r++) {
        const isEven = r % 2 === 0;
        if (ws4['A'+r]) ws4['A'+r].s = cellStyle(isEven,'left',true,C_GREEN);
        if (ws4['B'+r]) ws4['B'+r].s = { ...cellStyle(isEven,'center',true,C_GOLD),
            font: { sz:14, bold:true, color:{ rgb:C_GOLD }, name:'Noto Serif TC' } };
    }
    XLSX.utils.book_append_sheet(wb, ws4, 'ğŸ± å¥—é¤æ˜ç´°');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // åˆ†é  5ï¼šè¨‚å–®æµæ°´å¸³ï¼ˆæ¯é“èœæ‹†è¡Œï¼‰
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const ledgerAoa = [['åºè™Ÿ','æ™‚é–“','å§“å','é›»è©±','æ¡Œè™Ÿ','å¤§äºº','å°å­©','å…’ç«¥','æ´»å‹•ä»£è™Ÿ','å“é …åç¨±','å“é …é‡‘é¡','è¨‚å–®åˆè¨ˆ','å‚™è¨»']];
    orders.forEach((o, idx) => {
        (o.order_content || []).forEach((item, li) => {
            ledgerAoa.push([
                li === 0 ? idx + 1                              : '',
                li === 0 ? new Date(o.created_at).toLocaleString('zh-TW') : '',
                li === 0 ? (o.customer_name || '')              : '',
                li === 0 ? (o.phone || '')                      : '',
                li === 0 ? (o.table_no || '')                   : '',
                li === 0 ? (o.adult_count  || 0)                : '',
                li === 0 ? (o.kid_count    || 0)                : '',
                li === 0 ? (o.child_count  || 0)                : '',
                li === 0 ? (o.campaign_code || 'ä¸€èˆ¬')          : '',
                item.name,
                item.price,
                li === 0 ? (o.total_price || 0)                 : '',
                li === 0 ? (o.note || '')                       : '',
            ]);
        });
    });
    const ws5 = XLSX.utils.aoa_to_sheet(ledgerAoa);
    ws5['!cols'] = [
        {wch:6},{wch:18},{wch:12},{wch:14},{wch:8},
        {wch:5},{wch:5},{wch:5},{wch:10},{wch:38},{wch:10},{wch:10},{wch:22}
    ];
    ['A','B','C','D','E','F','G','H','I','J','K','L','M'].forEach(c => {
        if (ws5[c+'1']) ws5[c+'1'].s = headStyle(C_GREEN);
    });
    XLSX.utils.book_append_sheet(wb, ws5, 'ğŸ“‹ è¨‚å–®æµæ°´å¸³');

    const d = new Date().toLocaleDateString('zh-TW').replace(/\//g,'-');
    XLSX.writeFile(wb, `çœŸç å‚™æ–™çµ±è¨ˆ_${d}.xlsx`);
}
</script>
</body>
</html>
