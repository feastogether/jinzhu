<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çœŸç  ADMIN - æ——è‰¦ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --p-green: #004d40; --p-gold: #b89150; } 
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .bg-p-green { background-color: var(--p-green); }
        .text-p-green { color: var(--p-green); }
        .sidebar-btn-active { background-color: var(--p-green); color: white !important; border-left: 4px solid var(--p-gold); }
        .order-card-completed { opacity: 0.5; filter: grayscale(1); background-color: #f1f5f9 !important; border-color: #e2e8f0 !important; }
        .input-mini { font-size: 11px; padding: 4px 8px; border-radius: 6px; border: 1px solid #e2e8f0; width: 100%; outline: none; }
        .input-mini:focus { border-color: var(--p-gold); }
    </style>
</head>
<body class="min-h-screen flex text-slate-700">

    <aside class="w-64 bg-emerald-950 text-white p-6 sticky top-0 h-screen shadow-2xl flex flex-col">
        <h2 class="text-2xl font-bold mb-10 border-b border-emerald-700 pb-4 text-center tracking-widest font-serif">çœŸç  ADMIN</h2>
        <nav class="space-y-2 flex-1">
            <button id="btn-orders" onclick="switchTab('orders')" class="w-full text-left p-3 rounded-lg hover:bg-emerald-800 transition flex items-center gap-2">ğŸ“‹ è¨‚å–®ç›£æ§</button>
            <button id="btn-campaigns" onclick="switchTab('campaigns')" class="w-full text-left p-3 rounded-lg hover:bg-emerald-800 transition flex items-center gap-2">ğŸ—ï¸ æ´»å‹•ä»£è™Ÿ</button>
            <button id="btn-categories" onclick="switchTab('categories')" class="w-full text-left p-3 rounded-lg hover:bg-emerald-800 transition flex items-center gap-2">ğŸ—‚ï¸ åˆ†é¡ç®¡ç†</button>
            <button id="btn-menu" onclick="switchTab('menu')" class="w-full text-left p-3 rounded-lg hover:bg-emerald-800 transition flex items-center gap-2">ğŸ± èœå–®ç·¨è¼¯</button>
            <button id="btn-flavors" onclick="switchTab('flavors')" class="w-full text-left p-3 rounded-lg hover:bg-emerald-800 transition flex items-center gap-2">ğŸŒ¶ï¸ å£å‘³å®šç¾©</button>
            <button id="btn-settings" onclick="switchTab('settings')" class="w-full text-left p-3 rounded-lg hover:bg-emerald-800 transition flex items-center gap-2">âš™ï¸ ç³»çµ±è¨­å®š</button>
        </nav>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <section id="sec-orders" class="space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-3xl font-bold text-p-green font-serif">è¨‚å–®ç›£æ§</h2><button onclick="exportXls()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold shadow-lg">ğŸ“Š å°å‡º Excel</button></div>
            
            <div class="bg-white p-6 rounded-2xl shadow-sm border space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                        <label class="block text-xs font-bold text-stone-400 mb-1">å¿«é€Ÿæ—¥æœŸ</label>
                        <select id="filter-date-preset" onchange="setQuickDate(this.value)" class="w-full border p-2 rounded-lg text-sm">
                            <option value="all">ä¸é™æ—¥æœŸ</option>
                            <option value="today">ä»Šæ—¥è¨‚å–®</option>
                            <option value="week">æœ¬é€±è¨‚å–®</option>
                            <option value="custom">è‡ªé¸æ—¥æœŸ</option>
                        </select>
                    </div>
                    <div id="custom-date-box" class="hidden">
                        <label class="block text-xs font-bold text-stone-400 mb-1">è‡ªé¸æ—¥æœŸ</label>
                        <input type="date" id="filter-date" class="w-full border p-2 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-stone-400 mb-1">æ´»å‹•ä»£è™Ÿ</label>
                        <select id="filter-campaign" class="w-full border p-2 rounded-lg text-sm"><option value="all">å…¨éƒ¨æ´»å‹•</option></select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-stone-400 mb-1">ç‹€æ…‹</label>
                        <select id="filter-status" class="w-full border p-2 rounded-lg text-sm"><option value="all">å…¨éƒ¨</option><option value="pending">æœªå®Œæˆ</option><option value="synced">å·²å®Œæˆ</option></select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="md:col-span-3">
                        <label class="block text-xs font-bold text-stone-400 mb-1">é—œéµå­—æœå°‹ (å§“å/é›»è©±)</label>
                        <input type="text" id="filter-search" class="w-full border p-2 rounded-lg text-sm" placeholder="è¼¸å…¥é¡§å®¢è³‡è¨Š...">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadOrders()" class="flex-1 bg-p-green text-white py-2 rounded-lg font-bold">åŸ·è¡Œç¯©é¸</button>
                        <button onclick="resetFilters()" class="px-4 border py-2 rounded-lg text-stone-400">é‡ç½®</button>
                    </div>
                </div>
            </div>

            <div id="order-list" class="grid grid-cols-1 xl:grid-cols-2 gap-6"></div>
        </section>

        <section id="sec-campaigns" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-p-green font-serif">æ´»å‹•ä»£è™Ÿç®¡ç†</h2>
            <div class="bg-white p-6 rounded-2xl shadow-sm border max-w-md">
                <div class="flex gap-2 mb-6">
                    <input id="new-campaign" class="border flex-1 p-3 rounded-xl bg-stone-50" placeholder="ä¾‹å¦‚ï¼šæ¯è¦ªç¯€">
                    <button onclick="addCampaign()" class="bg-p-green text-white px-6 rounded-xl font-bold">æ–°å¢</button>
                </div>
                <div id="campaign-list" class="space-y-2"></div>
            </div>
        </section>

        <section id="sec-categories" class="hidden space-y-6">...</section>
        <section id="sec-menu" class="hidden space-y-6">...</section>
        <section id="sec-flavors" class="hidden space-y-6">...</section>
        <section id="sec-settings" class="hidden space-y-6">...</section>
    </main>

    <script>
        const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
        const _s = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let allCampaigns = [];

        async function switchTab(t) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('sidebar-btn-active'));
            document.getElementById(`sec-${t}`).classList.remove('hidden');
            document.getElementById(`btn-${t}`).classList.add('sidebar-btn-active');
            if(t==='orders') { await loadCampaignOptions(); loadOrders(); }
            if(t==='campaigns') loadCampaigns();
            // ... (å…¶é¤˜åŸæœ‰çš„ Tab åˆå§‹åŒ–)
        }

        // --- è¨‚å–®ç®¡ç†å„ªåŒ– ---
        function setQuickDate(val) {
            const dateBox = document.getElementById('custom-date-box');
            dateBox.classList.toggle('hidden', val !== 'custom');
        }

        async function loadCampaignOptions() {
            const { data } = await _s.from('campaign_settings').select('*');
            allCampaigns = data;
            const filter = document.getElementById('filter-campaign');
            filter.innerHTML = '<option value="all">å…¨éƒ¨æ´»å‹•</option>' + 
                data.map(c => `<option value="${c.code_name}">${c.code_name}</option>`).join('');
        }

        async function loadOrders() {
            const search = document.getElementById('filter-search').value;
            const status = document.getElementById('filter-status').value;
            const preset = document.getElementById('filter-date-preset').value;
            const campaign = document.getElementById('filter-campaign').value;

            let query = _s.from('orders').select('*').order('created_at', {ascending:false});

            if(search) query = query.or(`customer_name.ilike.%${search}%,phone.ilike.%${search}%`);
            if(status !== 'all') query = query.eq('status', status);
            if(campaign !== 'all') query = query.eq('campaign_code', campaign);

            // æ—¥æœŸç¯©é¸é‚è¼¯
            if(preset === 'today') {
                const today = new Date().toISOString().split('T')[0];
                query = query.gte('created_at', `${today}T00:00:00`).lte('created_at', `${today}T23:59:59`);
            } else if(preset === 'week') {
                const now = new Date();
                const lastWeek = new Date(now.setDate(now.getDate() - 7)).toISOString();
                query = query.gte('created_at', lastWeek);
            } else if(preset === 'custom') {
                const d = document.getElementById('filter-date').value;
                if(d) query = query.gte('created_at', `${d}T00:00:00`).lte('created_at', `${d}T23:59:59`);
            }

            const { data } = await query;
            window.ordersRef = data;
            
            document.getElementById('order-list').innerHTML = data.map(o => `
                <div class="bg-white p-6 rounded-3xl shadow-sm border transition ${o.status==='synced'?'order-card-completed':'border-emerald-200'}">
                    <div class="flex justify-between font-bold text-xl mb-2">
                        <span class="text-p-green font-serif">${o.customer_name}</span>
                        <span class="text-p-gold">$${o.total_price}</span>
                    </div>
                    <div class="text-[10px] text-stone-400 mb-4">${new Date(o.created_at).toLocaleString()} | ${o.phone}</div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-4 bg-stone-50 p-3 rounded-xl">
                        <div><label class="text-[9px] font-bold text-stone-400">è¨‚ä½æ—¥æœŸ</label>
                             <input type="date" value="${o.booking_date || ''}" onchange="updateOrderData('${o.id}', 'booking_date', this.value)" class="input-mini"></div>
                        <div><label class="text-[9px] font-bold text-stone-400">æ¡Œè™Ÿ</label>
                             <input type="text" value="${o.table_no || ''}" onchange="updateOrderData('${o.id}', 'table_no', this.value)" placeholder="è¼¸å…¥æ¡Œè™Ÿ" class="input-mini"></div>
                        <div class="col-span-2">
                             <label class="text-[9px] font-bold text-stone-400">äººæ•¸ (å¤§/å°/å¹¼)</label>
                             <div class="flex gap-1">
                                <input type="number" value="${o.adult_count || 0}" onchange="updateOrderData('${o.id}', 'adult_count', this.value)" class="input-mini text-center">
                                <input type="number" value="${o.kid_count || 0}" onchange="updateOrderData('${o.id}', 'kid_count', this.value)" class="input-mini text-center">
                                <input type="number" value="${o.toddler_count || 0}" onchange="updateOrderData('${o.id}', 'toddler_count', this.value)" class="input-mini text-center">
                             </div>
                        </div>
                        <div class="col-span-2">
                             <label class="text-[9px] font-bold text-stone-400">æ´»å‹•ä»£è™Ÿ</label>
                             <select onchange="updateOrderData('${o.id}', 'campaign_code', this.value)" class="input-mini">
                                <option value="">ç„¡æ´»å‹•</option>
                                ${allCampaigns.map(c => `<option value="${c.code_name}" ${o.campaign_code === c.code_name ? 'selected' : ''}>${c.code_name}</option>`).join('')}
                             </select>
                        </div>
                    </div>

                    <div class="space-y-1 mb-6 text-sm text-stone-500 border-l-2 border-stone-200 pl-4">${o.order_content.map(i => `â€¢ ${i.name}`).join('<br>')}</div>
                    
                    <div class="flex gap-3">
                        <button onclick="openEditOrder('${o.id}')" class="flex-1 bg-stone-100 py-3 rounded-xl font-bold text-xs hover:bg-stone-200 transition">ä¿®æ”¹ç´°é …</button>
                        <button onclick="toggleSync('${o.id}', '${o.status}')" class="flex-[1.5] ${o.status==='synced'?'bg-stone-400':'bg-emerald-600'} text-white py-3 rounded-xl text-xs font-bold shadow-md transition">
                            ${o.status==='synced' ? 'âœ“ å·²å®Œæˆ (é»æ“Šå–æ¶ˆ)' : 'æœªå®Œæˆ (é»æ“Šé»æ”¶)'}
                        </button>
                    </div>
                    <button onclick="delOrder('${o.id}')" class="w-full mt-3 py-2 text-red-300 text-[9px] font-bold border border-red-50 rounded-lg hover:bg-red-50 transition">æ°¸ä¹…åˆªé™¤è¨‚å–®</button>
                </div>`).join('');
        }

        async function updateOrderData(id, field, val) {
            const updateObj = {};
            updateObj[field] = val;
            await _s.from('orders').update(updateObj).eq('id', id);
            // ä¸åˆ·æ–°é é¢ä»¥ä¿æŒè¼¸å…¥ç„¦é»ï¼Œä½†èƒŒæ™¯å·²æ›´æ–°
        }

        async function toggleSync(id, currentStatus) {
            const newStatus = currentStatus === 'synced' ? 'pending' : 'synced';
            await _s.from('orders').update({ status: newStatus }).eq('id', id);
            loadOrders();
        }

        // --- æ´»å‹•ä»£è™Ÿç®¡ç† ---
        async function loadCampaigns() {
            const { data } = await _s.from('campaign_settings').select('*').order('created_at', {ascending: false});
            document.getElementById('campaign-list').innerHTML = data.map(c => `
                <div class="flex justify-between items-center p-3 bg-stone-50 rounded-xl border">
                    <span class="font-bold text-p-green">${c.code_name}</span>
                    <button onclick="delCampaign(${c.id})" class="text-red-300 hover:text-red-500">âœ•</button>
                </div>
            `).join('');
        }

        async function addCampaign() {
            const name = document.getElementById('new-campaign').value.trim();
            if(!name) return;
            await _s.from('campaign_settings').insert([{ code_name: name }]);
            document.getElementById('new-campaign').value = "";
            loadCampaigns();
        }

        async function delCampaign(id) {
            if(confirm('ç¢ºå®šåˆªé™¤æ­¤æ´»å‹•ä»£è™Ÿï¼Ÿ')) {
                await _s.from('campaign_settings').delete().eq('id', id);
                loadCampaigns();
            }
        }

        // (å…¶é¤˜åŸæœ‰ Javascript å‡½æ•¸ä¿æŒä¸è®Šï¼šopenEditOrder, loadCats, loadMenu, saveItem, uploadLogo ç­‰)
        // ... 
    </script>
</body>
</html>
