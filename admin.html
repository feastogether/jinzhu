<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çœŸç ç®¡ç†å¾Œå° - æ——è‰¦ç´”æ·¨ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>:root { --p-green: #004d40; } .bg-p-green { background-color: var(--p-green); }</style>
</head>
<body class="bg-slate-100 min-h-screen flex font-sans">
    <aside class="w-64 bg-emerald-900 text-white p-6 sticky top-0 h-screen shadow-xl">
        <h2 class="text-xl font-bold mb-10 border-b border-emerald-700 pb-4 text-center">çœŸç  ADMIN</h2>
        <nav class="space-y-4">
            <button onclick="switchTab('orders')" class="w-full text-left p-3 rounded hover:bg-emerald-800">ğŸ“‹ è¨‚å–®ç›£æ§</button>
            <button onclick="switchTab('categories')" class="w-full text-left p-3 rounded hover:bg-emerald-800">ğŸ—‚ï¸ åˆ†é¡ç®¡ç†</button>
            <button onclick="switchTab('menu')" class="w-full text-left p-3 rounded hover:bg-emerald-800">ğŸ± èœå–®/ä»‹ç´¹ç·¨è¼¯</button>
            <button onclick="switchTab('flavors')" class="w-full text-left p-3 rounded hover:bg-emerald-800">ğŸŒ¶ï¸ å£å‘³èª¿æ•´è¨­å®š</button>
            <button onclick="switchTab('settings')" class="w-full text-left p-3 rounded hover:bg-emerald-800">âš™ï¸ ç³»çµ±è¨­å®š</button>
        </nav>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <section id="sec-orders" class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">è¨‚å–®ç›£æ§</h2>
                <button onclick="exportXls()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">ğŸ“Š å°å‡º Excel</button>
            </div>
            <div id="order-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>

        <section id="sec-categories" class="hidden space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-bold">åˆ†é¡ç®¡ç†</h2><div class="flex gap-2"><input id="new-cat" class="border p-2 rounded" placeholder="æ–°åˆ†é¡"><button onclick="addCat()" class="bg-p-green text-white px-4 py-2 rounded">æ–°å¢</button></div></div>
            <div id="cat-list" class="bg-white p-4 rounded-xl shadow space-y-2"></div>
        </section>

        <section id="sec-menu" class="hidden space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-bold">èœå–®ç·¨è¼¯</h2><button onclick="openMenuModal()" class="bg-p-green text-white px-6 py-2 rounded-lg">+ æ–°å¢é¤é»</button></div>
            <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <section id="sec-flavors" class="hidden space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-bold">å£å‘³èª¿æ•´è¨­å®š</h2><button onclick="addFlvGroup()" class="bg-amber-600 text-white px-6 py-2 rounded-lg">+ æ–°å¢å£å‘³çµ„</button></div>
            <div id="flv-grid" class="grid gap-4"></div>
        </section>
        
        <section id="sec-settings" class="hidden space-y-6">
            <h2 class="text-2xl font-bold">Logo ä¸Šå‚³</h2>
            <div class="bg-white p-6 rounded-xl max-w-md shadow"><input type="file" id="logo-file" class="mb-4 w-full border p-2"><button onclick="uploadLogo()" class="w-full bg-amber-600 text-white py-2 rounded font-bold">ç¢ºèªä¸Šå‚³</button></div>
        </section>
    </main>

    <div id="menu-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-[100]">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="font-bold text-xl mb-4 text-p-green">ç·¨è¼¯é¤é»ç´°ç¯€</h3>
            <input type="hidden" id="m-id">
            <div class="space-y-3">
                <input type="text" id="m-name" placeholder="é¤é»åç¨±" class="w-full border p-3 rounded-xl">
                <textarea id="m-desc" placeholder="é¤é»ä»‹ç´¹" class="w-full border p-3 rounded-xl"></textarea>
                <div class="grid grid-cols-2 gap-4"><input type="number" id="m-price" placeholder="åƒ¹æ ¼" class="border p-3 rounded-xl"><select id="m-cat" class="border p-3 rounded-xl"></select></div>
                <div class="bg-stone-50 p-4 rounded-xl"><p class="text-xs font-bold mb-2 text-gray-400">å•Ÿç”¨å£å‘³èª¿æ•´ (å‹¾é¸å¾Œå‰å°æœƒå½ˆå‡ºé¸é …)ï¼š</p><div id="m-flv-checks" class="grid grid-cols-2 gap-2 text-sm"></div></div>
                <div class="bg-stone-50 p-4 rounded-xl"><label class="block text-xs font-bold text-gray-400 mb-1">ç…§ç‰‡ä¸Šå‚³</label><input type="file" id="m-img" class="w-full text-xs"></div>
                <label class="flex items-center gap-2 font-bold p-2"><input type="checkbox" id="m-is-set"> å¥—é¤æ¨¡å¼</label>
            </div>
            <div class="flex gap-2 mt-6"><button onclick="closeMenuModal()" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-400">å–æ¶ˆ</button><button onclick="saveItem()" class="flex-1 bg-p-green text-white py-3 rounded-xl font-bold">å„²å­˜è®Šæ›´</button></div>
        </div>
    </div>

    <div id="group-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center p-4 z-[200]">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="font-bold text-xl mb-4 text-p-green">è¨­å®šå¥—é¤é¸é …èˆ‡å£å‘³</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-2"><input type="text" id="g-name" placeholder="çµ„åˆ¥(å¦‚:ä¸»é¤)" class="border p-2 rounded"><input type="number" id="g-limit" placeholder="é¸å¹¾é …" class="border p-2 rounded"></div>
                <div class="bg-yellow-50 p-3 rounded">
                    <p class="text-xs font-bold mb-2 text-amber-800">æ–°å¢é¸é …ä¸¦é—œè¯å£å‘³ï¼š</p>
                    <div class="flex gap-2 mb-2"><input id="opt-name" class="flex-1 border p-2 text-sm" placeholder="èœå"><select id="opt-flv" class="border text-xs w-24"><option value="">ç„¡å£å‘³</option></select></div>
                    <button onclick="addOptToTemp()" class="w-full bg-amber-500 text-white py-1 rounded text-xs font-bold shadow-sm">åŠ å…¥åˆ—è¡¨</button>
                    <div id="temp-opts" class="mt-2 space-y-1"></div>
                </div>
                <button onclick="saveFullGroup()" class="w-full bg-p-green text-white py-3 rounded-xl font-bold shadow-lg">å„²å­˜æ­¤åˆ†çµ„å…§å®¹</button>
            </div>
            <button onclick="closeGroupModal()" class="w-full mt-4 text-gray-400 underline">é—œé–‰è¦–çª—</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
        const _s = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let curItem = null, tempOpts = [], allFlvs = [];

        async function switchTab(t) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`sec-${t}`).classList.remove('hidden');
            if(t === 'menu') loadMenuAdmin(); if(t === 'categories') loadCats(); if(t === 'orders') loadOrders(); if(t === 'flavors') loadFlavorsAdmin();
        }

        async function loadMenuAdmin() {
            const { data } = await _s.from('menu_items').select('*, categories(name)').order('created_at', {ascending:false});
            document.getElementById('menu-grid').innerHTML = data.map(i => `
                <div class="bg-white rounded-2xl shadow-sm border overflow-hidden p-4">
                    <div class="h-32 bg-stone-100 mb-2"><img src="${i.image_url || ''}" class="w-full h-full object-contain"></div>
                    <div class="flex justify-between font-bold mb-2"><span>${i.name}</span><span>$${i.price}</span></div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="editItem('${i.id}')" class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1 rounded border">ç·¨è¼¯ä»‹ç´¹</button>
                        ${i.is_set_menu ? `<button onclick="openGroupModal('${i.id}')" class="text-xs bg-amber-500 text-white px-3 py-1 rounded">âš™ï¸ è¨­å®šå¥—é¤</button>` : ''}
                        <button onclick="deleteItem('${i.id}')" class="text-xs text-red-500 px-3 py-1">åˆªé™¤</button>
                    </div>
                </div>`).join('');
        }

        async function editItem(id) {
            const { data: i } = await _s.from('menu_items').select('*, item_flavor_relation(*)').eq('id', id).single();
            curItem = id;
            document.getElementById('m-id').value = id;
            document.getElementById('m-name').value = i.name;
            document.getElementById('m-price').value = i.price;
            document.getElementById('m-desc').value = i.description || '';
            document.getElementById('m-is-set').checked = i.is_set_menu;
            openMenuModal(true);
            setTimeout(() => {
                i.item_flavor_relation.forEach(r => {
                    const chk = document.querySelector(`.flv-chk[value="${r.flavor_group_id}"]`);
                    if(chk) chk.checked = true;
                });
            }, 500);
        }

        async function saveItem() {
            const id = document.getElementById('m-id').value;
            const file = document.getElementById('m-img').files[0];
            let imgUrl = "";
            if(file) {
                const p = `items/${Date.now()}.png`;
                await _s.storage.from('assets').upload(p, file);
                imgUrl = `${SUPABASE_URL}/storage/v1/object/public/assets/${p}`;
            }

            const payload = {
                name: document.getElementById('m-name').value,
                price: document.getElementById('m-price').value,
                description: document.getElementById('m-desc').value,
                category_id: document.getElementById('m-cat').value,
                is_set_menu: document.getElementById('m-is-set').checked
            };
            if(imgUrl) payload.image_url = imgUrl;

            const { data: saved, error } = id ? await _s.from('menu_items').update(payload).eq('id', id).select() : await _s.from('menu_items').insert([payload]).select();
            
            if(saved) {
                await _s.from('item_flavor_relation').delete().eq('item_id', saved[0].id);
                const rels = Array.from(document.querySelectorAll('.flv-chk:checked')).map(c => ({ item_id: saved[0].id, flavor_group_id: c.value }));
                await _s.from('item_flavor_relation').insert(rels);
                closeMenuModal(); loadMenuAdmin();
            }
        }

        async function openGroupModal(id) {
            curItem = id; tempOpts = [];
            document.getElementById('group-modal').classList.remove('hidden');
            const { data } = await _s.from('flavor_groups').select('*');
            document.getElementById('opt-flv').innerHTML = '<option value="">ç„¡å£å‘³</option>' + data.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
            document.getElementById('temp-opts').innerHTML = "";
        }

        function addOptToTemp() {
            const name = document.getElementById('opt-name').value;
            const fid = document.getElementById('opt-flv').value;
            if(!name) return;
            tempOpts.push({ name, fid });
            document.getElementById('temp-opts').innerHTML += `<div class="text-[10px] bg-stone-100 p-1 rounded border">${name} ${fid ? '(å«å£å‘³)' : ''}</div>`;
            document.getElementById('opt-name').value = "";
        }

        async function saveFullGroup() {
            const { data: g } = await _s.from('set_menu_groups').insert([{ menu_item_id: curItem, group_name: document.getElementById('g-name').value, selection_limit: document.getElementById('g-limit').value }]).select();
            if(g) {
                for(let o of tempOpts) {
                    const { data: opt } = await _s.from('set_menu_options').insert([{ group_id: g[0].id, option_name: o.name }]).select();
                    if(opt && o.fid) await _s.from('option_flavor_relation').insert([{ option_id: opt[0].id, flavor_group_id: o.fid }]);
                }
                alert("å„²å­˜æˆåŠŸ"); closeGroupModal();
            }
        }

        async function loadOrders() {
            const { data } = await _s.from('orders').select('*').order('created_at', {ascending:false});
            document.getElementById('order-list').innerHTML = data.map(o => `
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-emerald-100">
                    <div class="flex justify-between font-bold mb-3"><span>${o.customer_name}</span><span class="text-p-green">$${o.total_price}</span></div>
                    <div class="text-xs text-gray-500 space-y-1">${o.order_content.map(i => `â€¢ ${i.name}`).join('<br>')}</div>
                    <button onclick="updateStatus('${o.id}', 'completed')" class="w-full mt-4 text-xs font-bold py-2 rounded-lg ${o.status==='completed'?'bg-stone-100 text-stone-400':'bg-emerald-50 text-emerald-600'}">${o.status==='completed'?'å·²é»é¤':'æ¨™è¨˜å·²é»é¤'}</button>
                </div>`).join('');
            window.lastOrders = data;
        }

        async function exportXls() {
            const ws = XLSX.utils.json_to_sheet(window.lastOrders.map(o => ({ 'æ™‚é–“': new Date(o.created_at).toLocaleString(), 'å®¢æˆ¶': o.customer_name, 'é›»è©±': o.phone, 'é‡‘é¡': o.total_price, 'é¤é»': o.order_content.map(i=>i.name).join('; ') })));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "è¨‚å–®");
            XLSX.writeFile(wb, `çœŸç è¨‚å–®_${new Date().toLocaleDateString()}.xlsx`);
        }

        async function loadFlavorsAdmin() {
            const { data } = await _s.from('flavor_groups').select('*, flavor_options(*)');
            document.getElementById('flv-grid').innerHTML = data.map(g => `
                <div class="bg-white p-4 rounded-xl shadow border flex justify-between items-center">
                    <div><h4 class="font-bold">${g.name}</h4><p class="text-[10px] text-gray-400">${g.flavor_options.map(o=>o.option_name).join(', ')}</p></div>
                    <button onclick="deleteFlvGroup('${g.id}')" class="text-xs text-red-500">åˆªé™¤</button>
                </div>`).join('');
        }

        async function addFlvGroup() {
            const n = prompt("çµ„å (å¦‚:ç†Ÿåº¦)"); const o = prompt("é¸é … (é€—è™Ÿåˆ†é–‹:å…¨ç†Ÿ,ä¸ƒåˆ†)");
            const { data: g } = await _s.from('flavor_groups').insert([{ name: n }]).select();
            if(g) { await _s.from('flavor_options').insert(o.split(',').map(name => ({ group_id: g[0].id, option_name: name.trim() }))); loadFlavorsAdmin(); }
        }

        async function openMenuModal(isEdit = false) {
            document.getElementById('menu-modal').classList.remove('hidden');
            const { data: cats } = await _s.from('categories').select('*');
            document.getElementById('m-cat').innerHTML = cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const { data: flvs } = await _s.from('flavor_groups').select('*');
            document.getElementById('m-flv-checks').innerHTML = flvs.map(f => `<label class="flex items-center gap-1"><input type="checkbox" class="flv-chk" value="${f.id}"> ${f.name}</label>`).join('');
        }

        async function addCat() { await _s.from('categories').insert([{ name: document.getElementById('new-cat').value }]); document.getElementById('new-cat').value=""; loadCats(); }
        async function loadCats() { const { data } = await _s.from('categories').select('*'); document.getElementById('cat-list').innerHTML = data.map(c => `<div class="flex justify-between p-2 border-b"><span>${c.name}</span><button onclick="deleteCat('${c.id}')" class="text-red-500">åˆª</button></div>`).join(''); }
        async function updateStatus(id, s) { await _s.from('orders').update({ status: s }).eq('id', id); loadOrders(); }
        async function uploadLogo() { const f = document.getElementById('logo-file').files[0]; const p = `logo/store_${Date.now()}.png`; await _s.storage.from('assets').upload(p, f); const url = `${SUPABASE_URL}/storage/v1/object/public/assets/${p}`; await _s.from('store_settings').update({ logo_url: url }).eq('id', 1); alert("Logo æ›´æ–°æˆåŠŸ"); }
        
        function closeMenuModal() { document.getElementById('menu-modal').classList.add('hidden'); }
        function closeGroupModal() { document.getElementById('group-modal').classList.add('hidden'); }
        async function deleteItem(id) { if(confirm('åˆªé™¤ï¼Ÿ')) { await _s.from('menu_items').delete().eq('id', id); loadMenuAdmin(); } }
        async function deleteCat(id) { await _s.from('categories').delete().eq('id', id); loadCats(); }
        async function deleteFlvGroup(id) { await _s.from('flavor_groups').delete().eq('id', id); loadFlavorsAdmin(); }

        switchTab('orders');
    </script>
</body>
</html>
