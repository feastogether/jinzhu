<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çœŸç æ–‡å¿ƒå¾Œå° - æ——è‰¦ç®¡ç†ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --p-green: #004d40; --p-gold: #b89150; --p-cream: #f9f5f0; } 
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; overflow: hidden; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .text-p-green { color: var(--p-green); }
        .bg-p-green { background-color: var(--p-green); }
        
        /* å´é‚Šæ¬„å‹•ç•«èˆ‡æ”¶åˆé‚è¼¯ */
        aside { transition: width 0.35s cubic-bezier(0.4, 0, 0.2, 1); width: 260px; overflow: hidden; box-shadow: 10px 0 30px rgba(0,0,0,0.1); }
        aside.collapsed { width: 85px; }
        aside.collapsed .nav-text { display: none; }
        aside.collapsed .sidebar-header { padding: 1rem 0.5rem; }
        aside.collapsed .sidebar-header img { max-height: 30px; }

        .sidebar-btn-active { background-color: var(--p-green); color: white !important; border-left: 5px solid var(--p-gold); }
        .img-contain, #admin-logo-img, .side-logo { object-fit: contain; image-rendering: -webkit-optimize-contrast; }
        
        /* å…§å®¹å€ç¾åŒ– */
        .order-card-completed { opacity: 0.5; filter: grayscale(0.8); background-color: #f1f5f9 !important; }
        .flavor-selected { border-color: var(--p-gold) !important; background-color: var(--p-green) !important; color: white !important; }
        .opt-selected { border: 2.5px solid var(--p-gold) !important; background-color: #fdf6e9 !important; font-weight: bold; }
        .event-cat-checkbox:checked + label { border-color: var(--p-gold) !important; background-color: #fdf6e9 !important; color: var(--p-green) !important; }

        .input-mini { font-size: 11px; padding: 4px 8px; border-radius: 6px; border: 1px solid #e2e8f0; width: 100%; outline: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        @media print { .no-print { display: none !important; } body { background: white; overflow: auto; } main { overflow: visible; } }
    </style>
</head>
<body class="h-screen flex text-slate-700">

    <aside id="sidebar" class="bg-emerald-950 text-white sticky top-0 h-screen flex flex-col z-[500]">
        <div class="sidebar-header p-8 flex flex-col items-center border-b border-emerald-800/50 mb-4 transition-all">
            <img id="side-logo-img" src="https://www.jinzhu.com.tw/images/Jinzhu_logo.svg" class="side-logo max-h-14 w-full filter brightness-200 drop-shadow-md">
            <button onclick="toggleSidebar()" class="mt-4 bg-emerald-800/50 p-2 rounded-full hover:bg-p-gold transition no-print">
                <span id="collapse-icon" class="text-xs">â—€</span>
            </button>
        </div>
        
        <nav class="space-y-1 flex-1 px-3 overflow-y-auto no-scrollbar">
            <button id="btn-orders" onclick="switchTab('orders')" class="w-full text-left p-4 rounded-xl hover:bg-emerald-800 transition flex items-center gap-4">
                <span class="text-xl">ğŸ“‹</span> <span class="nav-text font-bold text-sm tracking-widest">è¨‚å–®ç›£æ§</span>
            </button>
            <button id="btn-report" onclick="switchTab('report')" class="w-full text-left p-4 rounded-xl hover:bg-emerald-800 transition flex items-center gap-4">
                <span class="text-xl">ğŸ“Š</span> <span class="nav-text font-bold text-sm tracking-widest">å ±è¡¨çµ±è¨ˆ</span>
            </button>
            <button id="btn-campaigns" onclick="switchTab('campaigns')" class="w-full text-left p-4 rounded-xl hover:bg-emerald-800 transition flex items-center gap-4">
                <span class="text-xl">ğŸ—ï¸</span> <span class="nav-text font-bold text-sm tracking-widest">æ´»å‹•ä»£è™Ÿ</span>
            </button>
            <button id="btn-events" onclick="switchTab('events')" class="w-full text-left p-4 rounded-xl hover:bg-emerald-800 transition flex items-center gap-4">
                <span class="text-xl">ğŸ”—</span> <span class="nav-text font-bold text-sm tracking-widest">æ´»å‹•ç¶²å€</span>
            </button>
            <button id="btn-categories" onclick="switchTab('categories')" class="w-full text-left p-4 rounded-xl hover:bg-emerald-800 transition flex items-center gap-4">
                <span class="text-xl">ğŸ—‚ï¸</span> <span class="nav-text font-bold text-sm tracking-widest">åˆ†é¡ç®¡ç†</span>
            </button>
            <button id="btn-menu" onclick="switchTab('menu')" class="w-full text-left p-4 rounded-xl hover:bg-emerald-800 transition flex items-center gap-4">
                <span class="text-xl">ğŸ±</span> <span class="nav-text font-bold text-sm tracking-widest">èœå–®ç·¨è¼¯</span>
            </button>
            <button id="btn-flavors" onclick="switchTab('flavors')" class="w-full text-left p-4 rounded-xl hover:bg-emerald-800 transition flex items-center gap-4">
                <span class="text-xl">ğŸŒ¶ï¸</span> <span class="nav-text font-bold text-sm tracking-widest">å£å‘³å®šç¾©</span>
            </button>
            <button id="btn-settings" onclick="switchTab('settings')" class="w-full text-left p-4 rounded-xl hover:bg-emerald-800 transition flex items-center gap-4">
                <span class="text-xl">âš™ï¸</span> <span class="nav-text font-bold text-sm tracking-widest">ç³»çµ±è¨­å®š</span>
            </button>
            <div class="pt-4 mt-4 border-t border-emerald-800">
                <a href="monitor.html" target="_blank" class="block w-full text-left p-4 rounded-xl hover:bg-emerald-900 transition flex items-center gap-4 text-emerald-300 no-underline shadow-inner">
                    <span class="text-xl">ğŸ–¥ï¸</span> <span class="nav-text font-bold text-sm italic">çœ‹æ¿æ¨¡å¼</span>
                </a>
            </div>
        </nav>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto custom-scrollbar">
        
        <section id="sec-orders" class="space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-3xl font-bold text-p-green font-serif">è¨‚å–®å³æ™‚ç›£æ§</h2><button onclick="exportXls()" class="btn-green px-8 py-2.5 rounded-2xl font-bold shadow-lg">ğŸ“Š å°å‡º Excel</button></div>
            <div class="bg-white p-8 rounded-[2rem] shadow-sm border space-y-4 text-left no-print">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                    <div><label class="block text-xs font-bold text-stone-400 mb-1 uppercase tracking-widest">å¿«é€Ÿæ™‚é–“ç¯„åœ</label><select id="filter-date-preset" onchange="setQuickDate(this.value)" class="w-full border-b p-2 bg-transparent outline-none focus:border-p-gold"><option value="all">ä¸é™æ—¥æœŸ</option><option value="today">ä»Šæ—¥è¨‚å–®</option><option value="week">æœ¬é€±è¨‚å–®</option><option value="custom">è‡ªå®šç¾©æ—¥æœŸ</option></select></div>
                    <div id="custom-date-box" class="hidden"><label class="block text-xs font-bold text-stone-400 mb-1 uppercase tracking-widest">æŒ‡å®šæ—¥æœŸ</label><input type="date" id="filter-date" class="w-full border-b p-2 outline-none focus:border-p-gold"></div>
                    <div><label class="block text-xs font-bold text-stone-400 mb-1 uppercase tracking-widest">æ´»å‹•ä¾†æº</label><select id="filter-campaign" class="w-full border-b p-2 bg-transparent outline-none focus:border-p-gold"><option value="all">å…¨éƒ¨æ´»å‹•</option></select></div>
                    <div><label class="block text-xs font-bold text-stone-400 mb-1 uppercase tracking-widest">è™•ç†ç‹€æ…‹</label><select id="filter-status" class="w-full border-b p-2 bg-transparent outline-none focus:border-p-gold"><option value="all">é¡¯ç¤ºå…¨éƒ¨</option><option value="pending">å°šæœªå®Œæˆ</option><option value="synced">å·²å®Œæˆ</option></select></div>
                </div>
                <div class="flex gap-3"><input type="text" id="filter-search" class="flex-1 border p-3 rounded-xl text-sm" placeholder="å¿«é€Ÿæœå°‹å§“åæˆ–é›»è©±..."><button onclick="loadOrders()" class="bg-stone-800 text-white px-10 py-3 rounded-xl font-bold shadow-md hover:bg-black transition">ç¯©é¸</button><button onclick="resetFilters()" class="text-stone-300 text-xs font-bold underline">é‡ç½®</button></div>
            </div>
            <div id="order-list" class="grid grid-cols-1 xl:grid-cols-2 gap-8"></div>
        </section>

        <section id="sec-report" class="hidden space-y-6">
            <div class="flex justify-between items-end border-b-2 border-p-green pb-4">
                <div class="text-left text-p-green">
                    <h2 class="text-3xl font-black font-serif">ç‡Ÿé‹åˆ†æèˆ‡å‚™æ–™çµ±è¨ˆ</h2>
                    <p id="report-period-display" class="text-p-gold font-bold text-xs mt-1 uppercase">Analysis Dashboard</p>
                </div>
                <div class="flex gap-3 no-print">
                    <button onclick="window.print()" class="bg-white border-2 border-p-green text-p-green px-5 py-2.5 rounded-xl font-black text-xs hover:bg-emerald-50 transition">åˆ—å°è¡¨å–® PDF</button>
                    <button onclick="exportFullReport()" class="btn-green px-5 py-2.5 rounded-xl font-black text-xs shadow-lg">åŒ¯å‡ºä¸‰æ–¹çµ±æ•´ Excel</button>
                </div>
            </div>
            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border no-print text-left grid grid-cols-1 md:grid-cols-4 gap-8">
                <div class="md:col-span-2 space-y-3"><label class="text-[10px] font-black text-stone-400 uppercase tracking-widest">æ—¥æœŸå€é–“ç¶­åº¦</label><div class="flex gap-2"><button onclick="setReportRange('today')" class="flex-1 py-2 bg-stone-100 rounded-lg text-xs font-bold hover:bg-stone-200">ä»Šæ—¥æ•¸æ“š</button><button onclick="setReportRange('month')" class="flex-1 py-2 bg-stone-100 rounded-lg text-xs font-bold hover:bg-stone-200">æœ¬æœˆæ•¸æ“š</button></div><div class="flex items-center gap-2"><input type="date" id="r-start" class="flex-1 border-b p-2 font-bold"><span class="text-stone-300">~</span><input type="date" id="r-end" class="flex-1 border-b p-2 font-bold"></div></div>
                <div class="space-y-3"><label class="text-[10px] font-black text-stone-400 uppercase tracking-widest">æ´»å‹•äº¤å‰ç¯©é¸</label><select id="r-camp" class="w-full border-b p-2 font-black text-sm bg-transparent outline-none focus:border-p-gold"><option value="all">å…¨éƒ¨ä¾†æº (å«ä¸€èˆ¬åŠæ´»å‹•)</option><option value="none">åƒ…é™ä¸€èˆ¬è¨‚å–®</option></select></div>
                <div class="flex items-end"><button onclick="fetchReportData()" class="w-full bg-stone-900 text-white py-4 rounded-2xl font-black shadow-xl hover:bg-black transition active:scale-95">ç”Ÿæˆå…¨é‡æ•¸æ“šåˆ†æ</button></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-5 space-y-8">
                    <div class="bg-white rounded-[2.5rem] border overflow-hidden shadow-sm"><div class="bg-p-green p-5 text-white flex justify-between items-center"><b class="font-serif italic">å¥—é¤é¡åˆ¥çµ„æ•¸çµ±è¨ˆ</b><span id="r-set-total" class="bg-p-gold px-3 py-1 rounded-full text-xs font-black">0 çµ„</span></div><div id="r-set-body" class="p-6 space-y-3 text-left"></div></div>
                    <div class="bg-white rounded-[2.5rem] border overflow-hidden shadow-sm"><div class="bg-stone-800 p-5 text-white flex justify-between items-center"><b class="font-serif italic">å…¨å“é …å‚™æ–™æ¸…å–® (å«é£²æ–™)</b><span id="r-dish-total" class="bg-stone-600 px-3 py-1 rounded-full text-xs font-black">0 é …</span></div><div class="max-h-[60vh] overflow-y-auto custom-scrollbar"><table class="w-full text-left"><tbody id="r-dish-body" class="divide-y divide-stone-100"></tbody></table></div></div>
                </div>
                <div class="lg:col-span-7"><div class="bg-white rounded-[2.5rem] border overflow-hidden shadow-sm h-full"><div class="bg-p-gold p-5 text-white font-bold text-left font-serif italic tracking-widest">è©³ç´°è¨‚å–®å°å¸³æµæ°´å¸³</div><div id="r-detail-body" class="p-8 space-y-10 max-h-[110vh] overflow-y-auto custom-scrollbar"></div></div></div>
            </div>
        </section>

        <section id="sec-campaigns" class="hidden space-y-6"><h2 class="text-2xl font-bold text-p-green font-serif">æ´»å‹•ä»£è™Ÿç®¡ç†</h2><div class="bg-white p-8 rounded-3xl border max-w-md"><div class="flex gap-3 mb-6"><input id="new-campaign" class="border flex-1 p-3 rounded-xl" placeholder="æ–°æ´»å‹•åç¨±"><button onclick="addCampaign()" class="bg-p-green text-white px-6 rounded-xl font-bold shadow-md">æ–°å¢</button></div><div id="campaign-list" class="space-y-2"></div></div></section>
        
        <section id="sec-events" class="hidden space-y-6 text-left"><h2 class="text-3xl font-bold text-p-green font-serif">æ´»å‹•å°ˆå±¬ç¶²å€é…ç½®</h2><div class="grid grid-cols-1 xl:grid-cols-2 gap-8 items-start"><div class="bg-white p-10 rounded-[2.5rem] shadow-sm border space-y-8"><div><label class="block text-xs font-bold text-stone-400 mb-3 uppercase tracking-widest text-left">1. é¸æ“‡æ´»å‹•ä»£è™Ÿ</label><select id="sel-campaign" class="w-full border-b-2 p-3 bg-stone-50 outline-none"></select></div><div><label class="block text-xs font-bold text-stone-400 mb-3 uppercase tracking-widest text-left">2. å‹¾é¸é¡¯ç¤ºåˆ†é¡ (å¯å¤šé¸)</label><div id="event-cat-checkbox-list" class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar"></div></div><button onclick="bindEvent()" class="w-full bg-p-green text-white py-5 rounded-3xl font-black shadow-xl active:scale-95 transition">ç¢ºèªç¶å®šä¸¦ç”¢ç”Ÿæ´»å‹•ç¶²å€</button></div><div class="bg-white p-10 rounded-[2.5rem] shadow-sm border"><h3 class="font-bold text-stone-400 text-sm mb-6 uppercase tracking-widest text-left">é‹ä½œä¸­çš„æ´»å‹•é€£çµ</h3><div id="active-event-list" class="space-y-4"></div></div></div></section>

        <section id="sec-categories" class="hidden space-y-6"><h2 class="text-2xl font-bold text-p-green font-serif">åˆ†é¡ç®¡ç†ä¸­å¿ƒ</h2><div class="bg-white p-8 rounded-3xl border max-w-2xl text-left"><div class="flex gap-3 mb-6"><input id="new-cat" class="border flex-1 p-3 rounded-xl" placeholder="åˆ†é¡åç¨±"><button onclick="addCat()" class="bg-p-green text-white px-8 rounded-xl font-bold shadow-md">æ–°å¢</button></div><table class="w-full text-sm"><thead><tr class="text-stone-400 border-b"><th class="p-4 text-left">æ’åº</th><th class="p-4 text-left">åˆ†é¡åç¨±</th><th class="p-4">é¡¯ç¤ºç‹€æ…‹</th><th class="p-4">æ“ä½œ</th></tr></thead><tbody id="cat-list-table" class="divide-y"></tbody></table></div></section>

        <section id="sec-menu" class="hidden space-y-6 text-left"><div class="flex justify-between items-center"><h2 class="text-3xl font-bold text-p-green font-serif">èœå–®ç·¨è¼¯</h2><button onclick="openMenuModal(false)" class="bg-p-green text-white px-8 py-3 rounded-2xl shadow-xl font-black">+ æ–°å¢é¤é»</button></div><div class="bg-white p-5 rounded-2xl border flex gap-4"><input type="text" id="menu-search" oninput="loadMenu()" class="flex-1 border p-3 rounded-xl" placeholder="æœå°‹èœå..."><select id="menu-cat-filter" onchange="loadMenu()" class="border p-3 rounded-xl"></select></div><div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div></section>

        <section id="sec-flavors" class="hidden space-y-6"><div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-p-green font-serif">å£å‘³æ¨™ç±¤å®šç¾©</h2><button onclick="addFlvGroup()" class="bg-amber-600 text-white px-8 py-3 rounded-2xl font-bold shadow-lg">+ æ–°å¢å£å‘³é¸é …çµ„</button></div><div id="flv-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></section>

        <section id="sec-settings" class="hidden space-y-6 text-left"><h2 class="text-2xl font-bold text-p-green font-serif">ç³»çµ±èˆ‡ Logo è¨­å®š</h2><div class="bg-white p-10 rounded-[3rem] border shadow-sm max-w-xl"><p class="text-xs text-stone-400 mb-6 uppercase font-black tracking-widest text-left">Logo ä¸Šå‚³ç®¡ç† (æ¨è–¦ä½¿ç”¨ SVG å‘é‡æª”)</p><input type="file" id="logo-file" class="w-full border-2 border-dashed p-10 rounded-3xl text-sm mb-6 bg-stone-50"><div id="current-logo-preview" class="hidden mb-8 p-6 bg-emerald-900 rounded-3xl text-center"><img id="admin-logo-img" src="" class="max-h-24 mx-auto brightness-200"></div><button onclick="uploadLogo()" class="w-full bg-p-green text-white py-5 rounded-3xl font-black shadow-2xl active:scale-95 transition">ç¢ºèªæ›´æ–°ç³»çµ± Logo</button></div></section>
    </main>

    <div id="order-edit-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center p-4 z-[600] backdrop-blur-sm text-left">
        <div class="bg-white w-full max-w-6xl rounded-[2.5rem] overflow-hidden flex flex-col max-h-[95vh] shadow-2xl border border-white/20">
            <div class="p-8 bg-p-green text-white flex justify-between items-center"><h3 class="text-2xl font-black font-serif italic">ä¿®æ”¹è¨‚å–®å…§å®¹ä¿®æ­£</h3><button onclick="closeEditModal()" class="w-12 h-12 bg-white/10 rounded-full hover:bg-white/20 transition">âœ•</button></div>
            <div class="flex flex-1 overflow-hidden">
                <div class="w-2/3 border-r p-6 bg-stone-50 flex flex-col overflow-hidden"><div id="edit-cat-nav" class="mb-4 border-b pb-2 custom-scrollbar"></div><div id="edit-menu-grid" class="grid grid-cols-3 gap-4 overflow-y-auto pt-2 custom-scrollbar"></div></div>
                <div class="w-1/3 p-8 flex flex-col bg-white"><h4 class="font-black mb-6 border-b pb-4 text-stone-400 text-xs tracking-widest uppercase italic">ç›®å‰é¸è³¼æ¸…å–®</h4><div id="edit-cart-list" class="flex-1 space-y-4 overflow-y-auto text-sm custom-scrollbar"></div><div class="border-t pt-8 mt-6"><div class="flex justify-between text-2xl font-black text-p-green mb-6 font-serif"><span>ç¸½è¨ˆ</span><span id="edit-total-price">$0</span></div><button onclick="saveOrderChange()" class="w-full bg-p-gold text-white py-5 rounded-3xl font-black shadow-2xl active:scale-95 transition">ç¢ºèªæ›´æ–°è¨‚å–®è³‡æ–™</button></div></div>
            </div>
        </div>
    </div>

    <div id="edit-flavor-popup" class="fixed inset-0 bg-black/70 hidden flex items-center justify-center p-4 z-[700] backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-[2rem] p-10 flex flex-col max-h-[85vh] shadow-2xl text-left"><h4 class="font-black text-xl mb-6 text-p-green font-serif italic" id="edit-pop-title">å£å‘³é¸æ“‡</h4><div id="edit-pop-content" class="space-y-8 overflow-y-auto flex-1 pr-2 no-scrollbar"></div><div class="flex gap-4 mt-8"><button onclick="closeEditPop()" class="flex-1 bg-stone-100 py-4 rounded-2xl font-bold text-stone-400">å–æ¶ˆ</button><button onclick="confirmEditPop()" class="flex-[2] btn-green py-4 rounded-2xl font-black">æ›´æ–°è³‡æ–™</button></div></div>
    </div>

    <div id="set-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center p-4 z-[550] text-left">
        <div class="bg-white w-full max-w-2xl rounded-[3rem] p-10 flex flex-col max-h-[90vh] shadow-2xl"><h3 class="font-black text-2xl mb-6 text-p-green border-b-4 border-p-gold/20 pb-4 font-serif text-center" id="set-modal-title">å¥—é¤åˆ†çµ„å…§å®¹è¨­å®š</h3><div class="grid grid-cols-2 gap-6 mb-6"><div><label class="text-[10px] font-black text-stone-300 block mb-2 uppercase tracking-widest">åˆ†çµ„åç¨±</label><input id="g-name" class="w-full border-b p-3 bg-stone-50 outline-none"></div><div><label class="text-[10px] font-black text-stone-300 block mb-2 uppercase tracking-widest">å¿…é¸æ•¸é‡</label><input id="g-limit" type="number" class="w-full border-b p-3 bg-stone-50 outline-none text-center font-bold"></div></div><div class="bg-stone-50 p-6 rounded-[2rem] border border-stone-200/50 flex-1 flex flex-col overflow-hidden"><input type="text" id="set-item-search" oninput="filterPickerItems()" placeholder="å¿«é€Ÿæœå°‹å–®å“é …ç›®..." class="w-full p-4 border rounded-2xl text-sm mb-4 outline-none focus:border-p-gold"><div id="item-picker-list" class="flex-1 overflow-y-auto grid grid-cols-2 gap-3 pr-2 custom-scrollbar"></div><div class="mt-6 pt-4 border-t flex justify-between items-center"><span id="picker-count" class="text-xs text-stone-400 font-bold">å·²é¸ 0 é …</span><button onclick="addSelectedToPicks()" class="btn-green px-6 py-2 rounded-xl text-xs font-black">+ åŠ å…¥æš«å­˜</button></div></div><div class="mt-6"><div id="temp-pick-display" class="flex flex-wrap gap-2 mb-6"></div><button onclick="saveFullSet()" id="btn-save-group" class="w-full bg-stone-800 text-white py-5 rounded-3xl font-black shadow-xl">ç¢ºèªå„²å­˜åˆ†çµ„</button><button onclick="resetSetForm()" id="btn-cancel-edit" class="hidden w-full text-xs text-stone-400 mt-4 underline text-center">å–æ¶ˆç·¨è¼¯</button></div><button onclick="closeSetModal()" class="mt-6 text-xs text-stone-300 w-full text-center hover:text-stone-500">é—œé–‰</button></div>
    </div>

    <div id="menu-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-[500] text-left">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] p-10 flex flex-col max-h-[90vh] shadow-2xl"><h3 class="font-black text-2xl mb-8 text-p-green border-l-8 border-p-gold pl-4 font-serif">é¤é»åŸºæœ¬è³‡æ–™ç¶­è­·</h3><input type="hidden" id="m-id"><div class="space-y-6 overflow-y-auto pr-2 custom-scrollbar"><input id="m-name" placeholder="è¼¸å…¥é¤é»åç¨±" class="w-full border-b p-4 text-xl font-black text-p-green bg-stone-50 outline-none"><textarea id="m-desc" placeholder="é¤é»æè¿°èˆ‡ä»‹ç´¹..." class="w-full border p-4 rounded-2xl bg-stone-50 h-24 text-sm"></textarea><div class="grid grid-cols-2 gap-6"><input id="m-price" type="number" placeholder="å”®åƒ¹" class="border-b p-4 bg-stone-50 font-black"><select id="m-cat" class="border-b p-4 bg-stone-50 font-bold"></select></div><div class="bg-stone-100 p-6 rounded-3xl"><p class="text-[10px] font-black text-stone-400 mb-4 uppercase tracking-widest">æ¨™ç±¤èˆ‡å£å‘³è¨­å®š</p><div id="flv-checks" class="grid grid-cols-2 gap-3"></div></div><div class="p-4 border-2 border-dashed rounded-3xl bg-stone-50"><input type="file" id="m-img" class="w-full text-xs text-stone-400"></div><label class="flex items-center gap-4 p-5 bg-emerald-50 rounded-3xl font-black text-p-green cursor-pointer"><input type="checkbox" id="m-is-set" class="w-5 h-5 accent-p-green"> å•Ÿç”¨ã€Œå¥—é¤çµ„åˆã€æ¨¡å¼</label></div><div class="flex gap-4 mt-10"><button onclick="closeMenuModal()" class="flex-1 bg-stone-100 py-4 rounded-2xl text-stone-400 font-bold hover:bg-stone-200">å–æ¶ˆ</button><button onclick="saveItem()" class="flex-[2] btn-green py-4 rounded-2xl font-black shadow-lg">å„²å­˜è®Šæ›´</button></div></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
        const _s = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let allMenuItems = [], allCategories = [], curEditOrder = null, editCart = [], curEditItem = null, curEditPopSels = { flavors: {}, groups: {} };
        let reEditIndex = -1, curPicks = [], curItem = null, currentEditingGroupId = null, allCampaigns = [], pickerSelectedItems = [];

        // [å´é‚Šæ¬„åˆ‡æ›]
        function toggleSidebar() {
            const side = document.getElementById('sidebar');
            const icon = document.getElementById('collapse-icon');
            side.classList.toggle('collapsed');
            icon.innerText = side.classList.contains('collapsed') ? 'â–¶' : 'â—€';
        }

        async function switchTab(t) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('sidebar-btn-active'));
            const targetSec = document.getElementById(`sec-${t}`);
            const targetBtn = document.getElementById(`btn-${t}`);
            if(targetSec) targetSec.classList.remove('hidden');
            if(targetBtn) targetBtn.classList.add('sidebar-btn-active');
            
            if(t==='orders') { await loadCampaignOptions(); loadOrders(); }
            if(t==='campaigns') loadCampaigns();
            if(t==='categories') loadCats();
            if(t==='menu') { await loadCats(); loadMenu(); }
            if(t==='flavors') loadFlvs();
            if(t==='settings') loadSettings();
            if(t==='events') loadEventConfigData();
            if(t==='report') initReportTab();
        }

        // --- [å ±è¡¨ä¸­å¿ƒé‚è¼¯] ---
        async function initReportTab() {
            setReportRange('today');
            const { data } = await _s.from('campaign_settings').select('*');
            const select = document.getElementById('r-camp');
            select.innerHTML = '<option value="all">æ‰€æœ‰ä¾†æº</option><option value="none">ä¸€èˆ¬è¨‚å–®</option>';
            if(data) data.forEach(c => select.innerHTML += `<option value="${c.code_name}">${c.code_name}</option>`);
            fetchReportData();
        }

        function setReportRange(type) {
            const start = document.getElementById('r-start'), end = document.getElementById('r-end'), now = new Date();
            if(type === 'today') start.value = end.value = now.toISOString().split('T')[0];
            else { 
                start.value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0]; 
                end.value = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0]; 
            }
        }

        async function fetchReportData() {
            const start = document.getElementById('r-start').value, end = document.getElementById('r-end').value, camp = document.getElementById('r-camp').value;
            document.getElementById('report-period-display').innerText = `æœŸé–“ï¼š${start} ~ ${end}`;
            let query = _s.from('orders').select('*').order('created_at', {ascending: true});
            if(start && end) query = query.gte('created_at', `${start}T00:00:00`).lte('created_at', `${end}T23:59:59`);
            if(camp === 'none') query = query.is('campaign_code', null); else if(camp !== 'all') query = query.eq('campaign_code', camp);
            const { data: orders } = await query; renderAdminReport(orders || []);
        }

        function renderAdminReport(orders) {
            const dishCount = {}, setMenuCount = {}; let orderHtml = "";
            orders.forEach((o, idx) => {
                o.order_content.forEach(item => {
                    const qty = parseInt(item.name.match(/ x(\d+)/)?.[1] || 1);
                    const coreName = item.name.split(' [')[0].replace(/ x\d+/g, "").trim();
                    const isSet = coreName.includes('(') && coreName.includes('ã€');
                    if (isSet) {
                        const setBrand = coreName.split(' (')[0].trim(); 
                        setMenuCount[setBrand] = (setMenuCount[setBrand] || 0) + qty;
                        const subMatches = coreName.match(/\((.*?)\)/);
                        if(subMatches) subMatches[1].split('ã€').forEach(sub => { 
                            const s = sub.trim(); if(s) dishCount[s] = (dishCount[s] || 0) + qty; 
                        });
                    } else dishCount[coreName] = (dishCount[coreName] || 0) + qty;
                });
                orderHtml += `
                <div class="pb-10 border-b border-stone-100 last:border-0 text-left">
                    <div class="flex justify-between items-start mb-4">
                        <span class="text-2xl font-black text-p-green font-serif italic">#${idx+1} ${o.customer_name}</span>
                        <span class="text-[10px] bg-stone-100 text-stone-400 px-3 py-1 rounded-full font-black uppercase">${o.campaign_code||'ä¸€èˆ¬'}</span>
                    </div>
                    <div class="flex gap-4 text-xs font-bold text-p-gold mb-4">${o.phone} | æ¡Œï¼š${o.table_no||'--'} | ${o.adult_count}å¤§${o.kid_count}å°</div>
                    <div class="space-y-1 bg-stone-50/50 p-4 rounded-2xl">${o.order_content.map(i => `<div class="text-[11px] text-stone-600">â€¢ ${i.name}</div>`).join('')}</div>
                </div>`;
            });
            document.getElementById('r-set-body').innerHTML = Object.entries(setMenuCount).map(([n, c]) => `
                <div class="flex justify-between p-3 bg-emerald-50 rounded-xl text-xs"><span class="font-bold text-p-green">${n}</span><span class="font-black text-p-gold">${c} çµ„</span></div>`).join('') || '<p class="text-xs text-center text-stone-300">ç„¡å¥—é¤</p>';
            document.getElementById('r-dish-body').innerHTML = Object.entries(dishCount).sort((a,b)=>b[1]-a[1]).map(([n, c]) => `
                <tr class="hover:bg-stone-50"><td class="p-4 font-bold text-stone-600">${n}</td><td class="p-4 text-right font-black text-p-green text-lg">${c} <small class="text-[10px] text-stone-300">ä»½</small></td></tr>`).join('');
            document.getElementById('r-detail-body').innerHTML = orderHtml || '<p class="py-20 text-center text-stone-300">ç„¡è¨‚å–®æ•¸æ“š</p>';
            document.getElementById('r-set-total').innerText = Object.values(setMenuCount).reduce((a,b)=>a+b,0) + " çµ„";
            document.getElementById('r-dish-total').innerText = Object.keys(dishCount).length + " é …";
            document.getElementById('r-order-total').innerText = orders.length + " ç­†";
            window.lastRpt = { dishCount, setMenuCount, orders };
        }

        function exportFullReport() {
            if(!window.lastRpt) return alert("è«‹å…ˆç”Ÿæˆå ±è¡¨");
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(Object.entries(window.lastRpt.setMenuCount).map(e=>({"å¥—é¤é¡åˆ¥":e[0],"çµ„æ•¸":e[1]}))), "å¥—é¤çµ±è¨ˆ");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(Object.entries(window.lastRpt.dishCount).map(e=>({"å“å":e[0],"éœ€æ±‚ç¸½æ•¸":e[1]}))), "é£Ÿæå‚™æ–™æ¸…å–®");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(window.lastRpt.orders.map(o=>({
                "è¨‚ä½æ—¥æœŸ": o.booking_date, "å®¢æˆ¶": o.customer_name, "é›»è©±": o.phone, "å…§å®¹": o.order_content.map(i=>i.name).join(' / '), "å‚™è¨»": o.note
            }))), "è©³ç´°æµæ°´å¸³");
            XLSX.writeFile(wb, `çœŸç ç‡Ÿé‹åˆ†æå ±è¡¨_${new Date().toLocaleDateString()}.xlsx`);
        }

        // --- [åŸæœ¬çš„æ ¸å¿ƒåŠŸèƒ½] ---
        function setQuickDate(val) { document.getElementById('custom-date-box').classList.toggle('hidden', val !== 'custom'); }
        async function loadCampaignOptions() {
            const { data } = await _s.from('campaign_settings').select('*');
            allCampaigns = data || [];
            document.getElementById('filter-campaign').innerHTML = '<option value="all">å…¨éƒ¨æ´»å‹•</option>' + allCampaigns.map(c => `<option value="${c.code_name}">${c.code_name}</option>`).join('');
        }
        async function loadOrders() {
            const search = document.getElementById('filter-search').value, status = document.getElementById('filter-status').value, preset = document.getElementById('filter-date-preset').value, campaign = document.getElementById('filter-campaign').value;
            let query = _s.from('orders').select('*').order('created_at', {ascending:false});
            if(search) query = query.or(`customer_name.ilike.%${search}%,phone.ilike.%${search}%`);
            if(status !== 'all') query = query.eq('status', status);
            if(campaign !== 'all') query = query.eq('campaign_code', campaign);
            if(preset === 'today') { const d = new Date().toISOString().split('T')[0]; query = query.gte('created_at', `${d}T00:00:00`).lte('created_at', `${d}T23:59:59`); }
            else if(preset === 'week') { const lastWeek = new Date(new Date().setDate(new Date().getDate() - 7)).toISOString(); query = query.gte('created_at', lastWeek); }
            else if(preset === 'custom') { const d = document.getElementById('filter-date').value; if(d) query = query.gte('created_at', `${d}T00:00:00`).lte('created_at', `${d}T23:59:59`); }
            const { data } = await query; window.ordersRef = data || [];
            document.getElementById('order-list').innerHTML = (data || []).map(o => {
                let bTime = ""; if(o.booking_date) { const d = new Date(o.booking_date); bTime = new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().substring(0,16); }
                return `<div class="bg-white p-8 rounded-[2rem] shadow-sm border transition ${o.status==='synced'?'order-card-completed':'border-emerald-200'} text-left">
                    <div class="flex justify-between font-black text-2xl mb-2 text-p-green"><span>${o.customer_name}</span><span class="text-p-gold">$${o.total_price}</span></div>
                    <div class="text-[10px] text-stone-400 mb-6 font-bold tracking-widest uppercase">ä¸‹å–®ï¼š${new Date(o.created_at).toLocaleString()} | ${o.phone}</div>
                    <div class="grid grid-cols-2 gap-4 mb-6 bg-stone-50 p-4 rounded-3xl">
                        <div class="col-span-2"><label class="text-[9px] font-black text-stone-400 uppercase">è¨‚ä½æ™‚é–“ Booking</label><input type="datetime-local" value="${bTime}" onchange="updateOrderData('${o.id}', 'booking_date', this.value)" class="input-mini"></div>
                        <div><label class="text-[9px] font-black text-stone-400 uppercase">æ¡Œè™Ÿ Table</label><input type="text" value="${o.table_no||''}" onchange="updateOrderData('${o.id}', 'table_no', this.value)" class="input-mini"></div>
                        <div><label class="text-[9px] font-black text-stone-400 uppercase">æ´»å‹•ä¾†æº</label><select onchange="updateOrderData('${o.id}', 'campaign_code', this.value)" class="input-mini"><option value="">ç„¡</option>${allCampaigns.map(c => `<option value="${c.code_name}" ${o.campaign_code===c.code_name?'selected':''}>${c.code_name}</option>`).join('')}</select></div>
                    </div>
                    <div class="space-y-1 mb-8 text-sm text-stone-500 border-l-4 border-p-gold/20 pl-4 font-bold">${o.order_content.map(i => `â€¢ ${i.name}`).join('<br>')}</div>
                    <div class="flex gap-3"><button onclick="openEditOrder('${o.id}')" class="flex-1 bg-stone-100 py-4 rounded-2xl font-black text-xs hover:bg-stone-200 transition">ä¿®æ”¹ç´°é …</button><button onclick="toggleSync('${o.id}', '${o.status}')" class="flex-[1.5] ${o.status==='synced'?'bg-slate-300':'bg-emerald-600'} text-white py-4 rounded-2xl text-xs font-black shadow-lg">${o.status==='synced'?'âœ“ å·²å®Œæˆ':'é»é¸æ ¸æ”¶'}</button></div>
                    <button onclick="delOrder('${o.id}')" class="w-full mt-4 py-2 text-red-200 text-[10px] font-bold">æ°¸ä¹…åˆªé™¤</button>
                </div>`;
            }).join('');
        }
        async function updateOrderData(id, field, val) { const obj = {}; if(field==='booking_date'&&val) obj[field]=new Date(val).toISOString(); else obj[field]=val||null; await _s.from('orders').update(obj).eq('id', id); }
        async function toggleSync(id, cur) { await _s.from('orders').update({ status: cur==='synced'?'pending':'synced' }).eq('id', id); loadOrders(); }
        async function delOrder(id) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { await _s.from('orders').delete().eq('id', id); loadOrders(); } }

        // [ä¿®æ”¹ç´°é …æ ¸å¿ƒ]
        async function openEditOrder(id) {
            curEditOrder = window.ordersRef.find(o => o.id === id); editCart = JSON.parse(JSON.stringify(curEditOrder.order_content)); 
            document.getElementById('order-edit-modal').classList.remove('hidden');
            const { data: items } = await _s.from('menu_items').select('*, categories(name), item_flavor_relation(flavor_groups(*, flavor_options(*))), set_menu_groups(*, set_menu_contents(menu_items(*, item_flavor_relation(flavor_groups(*, flavor_options(*))))))').eq('is_hidden', false);
            allMenuItems = items || []; const { data: cats } = await _s.from('categories').select('*').order('sort_order');
            document.getElementById('edit-cat-nav').innerHTML = (cats||[]).map(c => `<button onclick="renderEditMenu('${c.id}')" class="px-6 py-2 bg-white border border-stone-200 rounded-full text-xs font-bold mr-3 hover:border-p-green transition">${c.name}</button>`).join('');
            if(cats.length) renderEditMenu(cats[0].id); refreshEditCart();
        }
        function refreshEditCart() {
            document.getElementById('edit-cart-list').innerHTML = editCart.map((i, idx) => `<div class="flex flex-col bg-stone-50 p-4 rounded-2xl border relative text-left shadow-sm"><div onclick="openEditPop(null, ${idx})" class="cursor-pointer pr-10"><span class="font-black text-sm text-p-green underline decoration-p-gold">${i.name}</span><div class="text-[10px] text-stone-400 mt-2 font-black">$${i.price}</div></div><button onclick="editCart.splice(${idx},1);refreshEditCart();" class="absolute top-4 right-4 text-red-300 font-bold text-xl">âœ•</button></div>`).join('');
            document.getElementById('edit-total-price').innerText = `$${editCart.reduce((sum, item) => sum + Number(item.price), 0)}`;
        }
        function openEditPop(itemId, index = -1) {
            reEditIndex = index; let prevNames = [], prevFlvs = [];
            if (index > -1) {
                const raw = editCart[index].name, baseName = raw.split(" [")[0].split(" (")[0]; curEditItem = allMenuItems.find(i => i.name === baseName);
                const gM = raw.match(/\((.*?)\)/); if (gM) prevNames = gM[1].split("ã€").map(n => n.split(" [")[0]);
                const fM = raw.match(/\[(.*?)\]/); if (fM) prevFlvs = fM[1].split("/");
            } else curEditItem = allMenuItems.find(i => i.id === itemId);
            if (!curEditItem) return; curEditPopSels = { flavors: {}, groups: {} };
            const container = document.getElementById('edit-pop-content'); container.innerHTML = "";
            if (curEditItem.item_flavor_relation?.length > 0) {
                container.innerHTML += curEditItem.item_flavor_relation.map(r => `<div><p class="text-[10px] text-stone-400 mb-3 uppercase font-black tracking-widest">${r.flavor_groups.name}</p><div class="flex flex-wrap gap-2">${r.flavor_groups.flavor_options.map(o => { const isM = prevFlvs.includes(o.option_name); if(isM) curEditPopSels.flavors[r.flavor_groups.id] = o.option_name; return `<div onclick="setEditPopFlv(this, '${r.flavor_groups.id}', '${o.option_name}')" class="px-5 py-2 border rounded-full text-xs font-bold cursor-pointer transition ${isM?'flavor-selected':'bg-stone-50'}">${o.option_name}</div>` }).join('')}</div></div>`).join('');
            }
            if (curEditItem.is_set_menu && curEditItem.set_menu_groups) {
                container.innerHTML += curEditItem.set_menu_groups.map(g => { curEditPopSels.groups[g.id] = []; return `<div><p class="text-[10px] text-p-green font-black mb-3 uppercase tracking-widest italic">${g.group_name}</p><div class="grid grid-cols-2 gap-3">${g.set_menu_contents.map(c => { const isM = prevNames.includes(c.menu_items.name); if(isM) curEditPopSels.groups[g.id].push({ name: c.menu_items.name }); return `<div onclick="setEditPopGroup(this, '${g.id}', '${c.menu_items.name}', ${g.selection_limit})" class="p-4 border rounded-2xl text-[11px] cursor-pointer text-center font-black transition ${isM?'opt-selected':'bg-stone-50'}">${c.menu_items.name}</div>` }).join('')}</div></div>`; }).join('');
            }
            document.getElementById('edit-pop-title').innerText = curEditItem.name; document.getElementById('edit-flavor-popup').classList.remove('hidden');
        }
        function setEditPopFlv(el, gid, name) { Array.from(el.parentElement.children).forEach(c => { c.classList.remove('flavor-selected'); c.classList.add('bg-stone-50'); }); el.classList.add('flavor-selected'); el.classList.remove('bg-stone-50'); curEditPopSels.flavors[gid] = name; }
        function setEditPopGroup(el, gid, name, limit) { if(limit === 1) { Array.from(el.parentElement.children).forEach(s => s.classList.remove('opt-selected')); el.classList.add('opt-selected'); curEditPopSels.groups[gid] = [{ name }]; } else { let s = curEditPopSels.groups[gid]; if(s.some(x => x.name === name)) { s = s.filter(x => x.name !== name); el.classList.remove('opt-selected'); } else if(s.length < limit) { s.push({ name }); el.classList.add('opt-selected'); } curEditPopSels.groups[gid] = s; } }
        function confirmEditPop() { const fn = Object.values(curEditPopSels.flavors).join('/'), gn = Object.values(curEditPopSels.groups).flat().map(x => x.name).join('ã€'); const finalName = `${curEditItem.name}${fn ? ` [${fn}]` : ""}${gn ? ` (${gn})` : ""}`; if (reEditIndex > -1) editCart[reEditIndex] = { name: finalName, price: Number(curEditItem.price) }; else editCart.push({ name: finalName, price: Number(curEditItem.price) }); closeEditPop(); refreshEditCart(); }
        async function saveOrderChange() { const total = editCart.reduce((sum, item) => sum + Number(item.price), 0); await _s.from('orders').update({ order_content: editCart, total_price: total }).eq('id', curEditOrder.id); alert("è¨‚å–®æ›´æ–°æˆåŠŸï¼"); closeEditModal(); loadOrders(); }
        function renderEditMenu(cid) { document.getElementById('edit-menu-grid').innerHTML = allMenuItems.filter(i => i.category_id === cid).map(i => `<div onclick="openEditPop('${i.id}')" class="bg-white p-4 rounded-2xl border border-stone-100 cursor-pointer shadow-sm text-left hover:border-p-gold transition"><div class="font-black text-xs line-clamp-2">${i.name}</div><div class="text-p-gold font-black text-xs mt-3">$${i.price}</div></div>`).join(''); }

        // [æ´»å‹•é…ç½®é‚è¼¯]
        async function loadEventConfigData() {
            const { data: camps } = await _s.from('campaign_settings').select('*'); document.getElementById('sel-campaign').innerHTML = camps.map(c => `<option value="${c.code_name}">${c.code_name}</option>`).join('');
            const { data: cats } = await _s.from('categories').select('*').eq('is_visible', false);
            document.getElementById('event-cat-checkbox-list').innerHTML = (cats || []).map(c => `<div class="relative"><input type="checkbox" id="event-cat-${c.id}" value="${c.id}" class="event-cat-checkbox hidden"><label for="event-cat-${c.id}" class="block border-2 p-4 rounded-2xl cursor-pointer text-sm font-black text-stone-500 transition hover:bg-stone-50">${c.name}</label></div>`).join('');
            loadActiveEvents();
        }
        async function loadActiveEvents() {
            const { data } = await _s.from('categories').select('*').not('campaign_code', 'is', null);
            const groups = data.reduce((acc, cur) => { if (!acc[cur.campaign_code]) acc[cur.campaign_code] = []; acc[cur.campaign_code].push(cur.name); return acc; }, {});
            document.getElementById('active-event-list').innerHTML = Object.keys(groups).map(code => `<div class="bg-stone-50 p-6 rounded-[2rem] border flex justify-between items-center text-left shadow-sm"><div><span class="text-[10px] bg-emerald-100 text-emerald-700 px-3 py-1 rounded-lg font-black uppercase">${code}</span><p class="text-xs text-stone-400 mt-3 font-bold">åŒ…å«åˆ†é¡ï¼š${groups[code].join('ã€')}</p></div><div class="flex gap-4"><button onclick="copyEventLink('${code}')" class="text-blue-600 text-sm font-black underline decoration-dotted">è¤‡è£½é€£çµ</button><button onclick="unbindCampaign('${code}')" class="text-red-300 text-sm font-black">è§£é™¤ç¶å®š</button></div></div>`).join('');
        }
        async function bindEvent() {
            const camp = document.getElementById('sel-campaign').value, checkedCats = Array.from(document.querySelectorAll('.event-cat-checkbox:checked')).map(el => el.value);
            if(!camp || checkedCats.length === 0) return alert("è«‹å‹¾é¸è‡³å°‘ä¸€å€‹åˆ†é¡");
            await _s.from('categories').update({ campaign_code: null }).eq('campaign_code', camp);
            const { error } = await _s.from('categories').update({ campaign_code: camp }).in('id', checkedCats);
            if(!error) { alert("æ´»å‹•ç¶²å€é…ç½®æˆåŠŸï¼"); loadActiveEvents(); document.querySelectorAll('.event-cat-checkbox').forEach(el => el.checked = false); }
        }
        async function unbindCampaign(code) { if(confirm(`ç¢ºå®šè§£é™¤æ´»å‹• ${code} çš„æ‰€æœ‰åˆ†é¡ç¶å®šï¼Ÿ`)) { await _s.from('categories').update({ campaign_code: null }).eq('campaign_code', code); loadActiveEvents(); } }
        function copyEventLink(code) {
            const curUrl = window.location.href, basePath = curUrl.substring(0, curUrl.lastIndexOf('/') + 1); const finalUrl = `${basePath}event.html?code=${encodeURIComponent(code)}`;
            const t = document.createElement("input"); t.value = finalUrl; document.body.appendChild(t); t.select(); document.execCommand("copy"); document.body.removeChild(t); alert("æ´»å‹•å°ˆå±¬ç¶²å€å·²è¤‡è£½ï¼");
        }

        // [åˆ†é¡èˆ‡åŸºç¤ç¶­è­·]
        async function loadCampaigns() { const { data } = await _s.from('campaign_settings').select('*').order('created_at', {ascending: false}); document.getElementById('campaign-list').innerHTML = (data || []).map(c => `<div class="flex justify-between items-center p-4 bg-stone-50 rounded-2xl border font-black text-sm shadow-sm"><span class="text-p-green">${c.code_name}</span><button onclick="delCampaign(${c.id})" class="text-red-400 font-bold px-2 text-lg font-serif">âœ•</button></div>`).join(''); }
        async function addCampaign() { const n = document.getElementById('new-campaign').value.trim(); if(n) await _s.from('campaign_settings').insert([{ code_name: n }]); document.getElementById('new-campaign').value=""; loadCampaigns(); }
        async function delCampaign(id) { if(confirm('åˆªé™¤æ´»å‹•ä»£è™Ÿï¼Ÿ')) { await _s.from('campaign_settings').delete().eq('id', id); loadCampaigns(); } }
        async function loadCats() {
            const { data } = await _s.from('categories').select('*').order('sort_order'); allCategories = data || [];
            document.getElementById('cat-list-table').innerHTML = data.map(c => `<tr class="border-b hover:bg-stone-50 transition text-sm text-left"><td class="p-5"><input type="number" value="${c.sort_order||0}" onchange="updateCatSort('${c.id}',this.value)" class="w-12 border rounded-lg text-xs p-2 text-center font-bold"></td><td class="p-5 font-black text-p-green">${c.name}</td><td class="p-5 text-center"><input type="checkbox" ${c.is_visible?'checked':''} onchange="updateCatVis('${c.id}',this.checked)" class="w-5 h-5 accent-p-green"></td><td class="p-5 text-center"><button onclick="delCat('${c.id}')" class="text-red-300 font-bold hover:text-red-500">åˆªé™¤</button></td></tr>`).join('');
            document.getElementById('m-cat').innerHTML = data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('menu-cat-filter').innerHTML = '<option value="all">æ‰€æœ‰åˆ†é¡é¡¯ç¤º</option>' + data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
        async function updateCatVis(id, b) { await _s.from('categories').update({ is_visible: b }).eq('id', id); loadCats(); }
        async function updateCatSort(id, v) { await _s.from('categories').update({ sort_order: parseInt(v) }).eq('id', id); loadCats(); }
        async function addCat() { const n = document.getElementById('new-cat').value.trim(); if(n) await _s.from('categories').insert([{ name: n, sort_order: 99, is_visible: true }]); loadCats(); }
        async function delCat(id) { if(confirm('åˆªé™¤åˆ†é¡ï¼Ÿ')) { await _s.from('categories').delete().eq('id', id); loadCats(); } }
        async function loadMenu() {
            const search = document.getElementById('menu-search').value.toLowerCase(), catF = document.getElementById('menu-cat-filter').value;
            const { data } = await _s.from('menu_items').select('*, categories(name)').order('created_at', {ascending:false});
            document.getElementById('menu-grid').innerHTML = (data || []).filter(i => i.name.toLowerCase().includes(search) && (catF==='all'||i.category_id===catF)).map(i => `<div class="bg-white rounded-[2rem] border p-6 shadow-sm flex flex-col h-full"><div class="h-36 bg-stone-50 rounded-3xl mb-4 flex items-center justify-center overflow-hidden"><img src="${i.image_url||''}" class="max-h-full img-contain"></div><div class="flex justify-between font-black text-sm"><span>${i.name}</span><span class="text-p-gold">$${i.price}</span></div><div class="flex gap-2 mt-auto pt-6"><button onclick="editItem('${i.id}')" class="flex-1 py-2 bg-stone-100 rounded-xl font-black text-[10px]">ç·¨è¼¯è³‡æ–™</button>${i.is_set_menu?`<button onclick="openSetModal('${i.id}')" class="flex-1 py-2 bg-amber-500 text-white rounded-xl font-black text-[10px]">å¥—é¤è¨­å®š</button>`:''}<button onclick="delItem('${i.id}')" class="px-3 text-red-200">âœ•</button></div></div>`).join('');
        }
        async function openMenuModal(isEdit) { document.getElementById('menu-modal').classList.remove('hidden'); if(!isEdit) { document.getElementById('m-id').value = ""; document.getElementById('m-name').value = ""; document.getElementById('m-price').value = ""; document.getElementById('m-desc').value = ""; document.getElementById('m-is-set').checked = false; } const { data: flvs } = await _s.from('flavor_groups').select('*'); document.getElementById('flv-checks').innerHTML = (flvs || []).map(f => `<label class="flex items-center gap-2 text-[11px] font-bold"><input type="checkbox" class="flv-chk w-4 h-4 accent-p-green" value="${f.id}"> ${f.name}</label>`).join(''); }
        async function editItem(id) { const { data: i } = await _s.from('menu_items').select('*, item_flavor_relation(*)').eq('id', id).single(); document.getElementById('m-id').value = i.id; document.getElementById('m-name').value = i.name; document.getElementById('m-price').value = i.price; document.getElementById('m-desc').value = i.description || ''; document.getElementById('m-is-set').checked = i.is_set_menu; await openMenuModal(true); setTimeout(() => { i.item_flavor_relation.forEach(r => { const c = document.querySelector(`.flv-chk[value="${r.flavor_group_id}"]`); if(c) c.checked=true; }); }, 500); }
        async function saveItem() {
            const id = document.getElementById('m-id').value, file = document.getElementById('m-img').files[0]; let url = "";
            if(file) { const path = `items/${Date.now()}.png`; await _s.storage.from('assets').upload(path, file); url = _s.storage.from('assets').getPublicUrl(path).data.publicUrl; }
            const p = { name: document.getElementById('m-name').value, price: document.getElementById('m-price').value, description: document.getElementById('m-desc').value, category_id: document.getElementById('m-cat').value, is_set_menu: document.getElementById('m-is-set').checked }; if(url) p.image_url = url;
            const { data: saved } = id ? await _s.from('menu_items').update(p).eq('id', id).select() : await _s.from('menu_items').insert([p]).select();
            if (saved) { await _s.from('item_flavor_relation').delete().eq('item_id', saved[0].id); const rels = Array.from(document.querySelectorAll('.flv-chk:checked')).map(c => ({ item_id: saved[0].id, flavor_group_id: c.value })); if (rels.length) await _s.from('item_flavor_relation').insert(rels); closeMenuModal(); loadMenu(); }
        }
        async function delItem(id) { if(confirm('ç¢ºå®šä¸‹æ¶ä¸¦åˆªé™¤æ­¤é¤é»ï¼Ÿ')) { await _s.from('menu_items').delete().eq('id', id); loadMenu(); } }
        async function openSetModal(id) { curItem = id; resetSetForm(); document.getElementById('set-modal').classList.remove('hidden'); const { data } = await _s.from('menu_items').select('*, categories(name)').eq('is_set_menu', false).order('name'); window.allPickerItems = data || []; renderPickerList(data); loadSavedSets(); }
        function renderPickerList(items) {
            const container = document.getElementById('item-picker-list'), grouped = items.reduce((acc, i) => { const cat = i.categories?.name || 'æœªåˆ†é¡'; if (!acc[cat]) acc[cat] = []; acc[cat].push(i); return acc; }, {});
            container.innerHTML = Object.keys(grouped).map(cat => `<div class="col-span-2 mt-4 font-black text-[9px] text-stone-300 border-b uppercase italic tracking-widest">${cat}</div>` + grouped[cat].map(i => `<div id="picker-${i.id}" onclick="togglePickerSelect('${i.id}', '${i.name}')" class="picker-item flex justify-between p-4 border rounded-2xl bg-white cursor-pointer shadow-sm text-xs font-black"><span>${i.name}</span><div class="check-mark hidden font-bold text-p-gold">âœ”</div></div>`).join('')).join('');
        }
        function togglePickerSelect(id, name) { const el = document.getElementById(`picker-${id}`), idx = pickerSelectedItems.findIndex(x => x.id === id); if(idx > -1) { pickerSelectedItems.splice(idx, 1); el?.classList.remove('active'); } else { pickerSelectedItems.push({ id, name }); el?.classList.add('active'); } updatePickerStats(); }
        function updatePickerStats() { document.getElementById('picker-count').innerText = `å·²é¸ ${pickerSelectedItems.length} é …å–®å“`; }
        function addSelectedToPicks() { pickerSelectedItems.forEach(s => { if(!curPicks.some(p => p.id === s.id)) curPicks.push(s); }); pickerSelectedItems = []; renderTempPicks(); document.querySelectorAll('.picker-item').forEach(el => el.classList.remove('active')); updatePickerStats(); }
        function renderTempPicks() { document.getElementById('temp-pick-display').innerHTML = curPicks.map((p, idx) => `<div class="bg-emerald-50 text-emerald-800 px-4 py-2 rounded-xl text-[10px] font-black flex items-center gap-3 border border-emerald-100 shadow-sm">${p.name} <span onclick="curPicks.splice(${idx},1);renderTempPicks();" class="cursor-pointer opacity-30 hover:opacity-100 font-serif">âœ•</span></div>`).join(''); }
        async function saveFullSet() { 
            const n = document.getElementById('g-name').value, l = document.getElementById('g-limit').value; if(!n || !curPicks.length) return alert("è³‡è¨Šä¸é½Šå…¨");
            let gid = currentEditingGroupId; if (gid) { await _s.from('set_menu_groups').update({ group_name: n, selection_limit: l }).eq('id', gid); await _s.from('set_menu_contents').delete().eq('group_id', gid); } 
            else { const { data: g } = await _s.from('set_menu_groups').insert([{ parent_set_id: curItem, group_name: n, selection_limit: l }]).select(); if(g) gid = g[0].id; }
            if(gid) { await _s.from('set_menu_contents').insert(curPicks.map(p => ({ group_id: gid, item_id: p.id }))); resetSetForm(); loadSavedSets(); } 
        }
        async function loadSavedSets() { const { data } = await _s.from('set_menu_groups').select('*, set_menu_contents(menu_items(*))').eq('parent_set_id', curItem); document.getElementById('saved-groups-view').innerHTML = (data || []).map(g => `<div class="p-4 bg-stone-50 border rounded-3xl flex justify-between shadow-inner mb-2 text-left"><div class="flex-1"><b class="text-p-green text-xs font-black italic underline decoration-p-gold">${g.group_name} (é™é¸ ${g.selection_limit})</b><p class="text-[10px] text-gray-400 mt-1">${g.set_menu_contents.map(c => c.menu_items?.name).join('ã€')}</p></div><div class="flex gap-2"><button onclick="editSetGroup('${g.id}')" class="text-p-gold font-black text-xs">ç·¨è¼¯</button><button onclick="delSetGroup('${g.id}')" class="text-red-400 font-black text-xs">âœ•</button></div></div>`).join(''); }
        async function delSetGroup(id) { if(confirm('ç¢ºå®šåˆªé™¤æ­¤åˆ†çµ„ï¼Ÿ')) { await _s.from('set_menu_groups').delete().eq('id', id); loadSavedSets(); } }
        function resetSetForm() { currentEditingGroupId = null; document.getElementById('g-name').value = ""; document.getElementById('g-limit').value = 1; document.getElementById('temp-pick-display').innerHTML = ""; curPicks = []; pickerSelectedItems = []; updatePickerStats(); }

        // [åŸºç¤å®šç¾©èˆ‡ç³»çµ±]
        async function loadFlvs() { const { data } = await _s.from('flavor_groups').select('*, flavor_options(*)'); document.getElementById('flv-grid').innerHTML = (data || []).map(g => `<div class="bg-white p-6 rounded-[2rem] border flex justify-between shadow-sm items-center"><b class="text-p-green font-serif italic">ğŸŒ¶ï¸ ${g.name}</b><button onclick="delFlv('${g.id}')" class="w-10 h-10 rounded-full border text-red-400 font-serif text-xl hover:bg-red-50">âœ•</button></div>`).join(''); }
        async function addFlvGroup() { const n = prompt("è¼¸å…¥é¸é …çµ„åç¨± (å¦‚: è¾£åº¦)"), o = prompt("è¼¸å…¥é¸é …ï¼Œä»¥é€—è™Ÿéš”é–‹ (å¦‚: ä¸è¾£,å°è¾£,ä¸­è¾£)"); if(n && o) { const { data: g } = await _s.from('flavor_groups').insert([{ name: n }]).select(); if(g) await _s.from('flavor_options').insert(o.split(',').map(nm => ({ group_id: g[0].id, option_name: nm.trim() }))); loadFlvs(); } }
        async function delFlv(id) { if(confirm('ç¢ºå®šåˆªé™¤æ­¤å£å‘³çµ„ï¼Ÿ')) { await _s.from('flavor_groups').delete().eq('id', id); loadFlvs(); } }
        async function loadSettings() { const { data } = await _s.from('store_settings').select('*').eq('id', 1).single(); if(data?.logo_url) { document.getElementById('current-logo-preview').classList.remove('hidden'); document.getElementById('admin-logo-img').src = document.getElementById('side-logo-img').src = `${data.logo_url}?t=${Date.now()}`; } }
        async function uploadLogo() {
            const f = document.getElementById('logo-file').files[0]; if(!f) return alert("è«‹é¸å–åœ–ç‰‡");
            const ext = f.name.split('.').pop().toLowerCase(), path = `logo_${Date.now()}.${ext}`, type = ext === 'svg' ? 'image/svg+xml' : f.type;
            const { error } = await _s.storage.from('assets').upload(path, f, { contentType: type, upsert: true });
            if(!error) { const { data } = _s.storage.from('assets').getPublicUrl(path); await _s.from('store_settings').update({ logo_url: data.publicUrl }).eq('id', 1); alert("ç³»çµ± Logo å·²æˆåŠŸæ›´æ–°"); loadSettings(); }
        }

        // [è¼”åŠ© UI å‡½å¼]
        function closeMenuModal() { document.getElementById('menu-modal').classList.add('hidden'); }
        function closeSetModal() { document.getElementById('set-modal').classList.add('hidden'); }
        function closeEditModal() { document.getElementById('order-edit-modal').classList.add('hidden'); }
        function closeEditPop() { document.getElementById('edit-flavor-popup').classList.add('hidden'); }
        function resetFilters() { document.getElementById('filter-search').value=''; document.getElementById('filter-date-preset').value='all'; document.getElementById('filter-status').value='all'; loadOrders(); }
        function exportXls() { 
            const exp = window.ordersRef.map(o => ({ 'å§“å': o.customer_name, 'é›»è©±': o.phone, 'ç¸½é¡': o.total_price, 'æ¡Œè™Ÿ': o.table_no, 'æ´»å‹•ä¾†æº': o.campaign_code, 'æ™‚é–“': o.booking_date })); 
            const ws = XLSX.utils.json_to_sheet(exp); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "è¨‚å–®å ±è¡¨"); XLSX.writeFile(wb, "çœŸç è¨‚å–®æµæ°´è¡¨.xlsx");
        }

        switchTab('orders');
        loadSettings();
    </script>
</body>
</html>
