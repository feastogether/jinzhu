<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çœŸç  ADMIN - æ——è‰¦ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --p-green: #004d40; --p-gold: #b89150; } 
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .bg-p-green { background-color: var(--p-green); }
        .text-p-green { color: var(--p-green); }
        .sidebar-btn-active { background-color: var(--p-green); color: white !important; border-left: 4px solid var(--p-gold); }
        
        /* åœ–ç‰‡èˆ‡ Logo éŠ³åˆ©åŒ–æ¸²æŸ“ */
        .img-contain, #admin-logo-img { 
            object-fit: contain; background: white; 
            image-rendering: -webkit-optimize-contrast; 
        }
        
        #edit-cat-nav { display: flex; overflow-x: auto; white-space: nowrap; padding-bottom: 10px; scrollbar-width: thin; scrollbar-color: var(--p-gold) #f1f1f1; }
        #edit-cat-nav::-webkit-scrollbar { height: 8px; }
        #edit-cat-nav::-webkit-scrollbar-thumb { background: var(--p-gold); border-radius: 10px; }

        .flavor-selected { border-color: var(--p-gold) !important; background-color: var(--p-green) !important; color: white !important; }
        .opt-selected { border: 2.5px solid var(--p-gold) !important; background-color: #fdf6e9 !important; font-weight: bold; }
        .picker-item.active { border-color: var(--p-gold); background-color: #fffbeb; }
        .picker-item.active .check-mark { display: block; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex text-slate-700">

    <aside class="w-64 bg-emerald-950 text-white p-6 sticky top-0 h-screen shadow-2xl flex flex-col">
        <h2 class="text-2xl font-bold mb-10 border-b border-emerald-700 pb-4 text-center tracking-widest font-serif">çœŸç  ADMIN</h2>
        <nav class="space-y-2 flex-1">
            <button id="btn-orders" onclick="switchTab('orders')" class="w-full text-left p-3 rounded-lg hover:bg-emerald-800 transition flex items-center gap-2">ğŸ“‹ è¨‚å–®ç›£æ§</button>
            <button id="btn-categories" onclick="switchTab('categories')" class="w-full text-left p-3 rounded-lg hover:bg-emerald-800 transition flex items-center gap-2">ğŸ—‚ï¸ åˆ†é¡ç®¡ç†</button>
            <button id="btn-menu" onclick="switchTab('menu')" class="w-full text-left p-3 rounded-lg hover:bg-emerald-800 transition flex items-center gap-2">ğŸ± èœå–®ç·¨è¼¯</button>
            <button id="btn-flavors" onclick="switchTab('flavors')" class="w-full text-left p-3 rounded-lg hover:bg-emerald-800 transition flex items-center gap-2">ğŸŒ¶ï¸ å£å‘³å®šç¾©</button>
            <button id="btn-settings" onclick="switchTab('settings')" class="w-full text-left p-3 rounded-lg hover:bg-emerald-800 transition flex items-center gap-2">âš™ï¸ ç³»çµ±è¨­å®š</button>
        </nav>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <section id="sec-orders" class="space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-3xl font-bold text-p-green font-serif">è¨‚å–®ç›£æ§</h2><button onclick="exportXls()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold shadow-lg">ğŸ“Š å°å‡º Excel</button></div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div><label class="block text-xs font-bold text-stone-400 mb-1">æœå°‹å§“å/é›»è©±</label><input type="text" id="filter-search" class="w-full border p-2 rounded-lg"></div>
                <div><label class="block text-xs font-bold text-stone-400 mb-1">æ—¥æœŸ</label><input type="date" id="filter-date" class="w-full border p-2 rounded-lg"></div>
                <div><label class="block text-xs font-bold text-stone-400 mb-1">ç‹€æ…‹</label><select id="filter-status" class="w-full border p-2 rounded-lg"><option value="all">å…¨éƒ¨</option><option value="pending">å¾…è™•ç†</option><option value="synced">å·²å®Œæˆ</option></select></div>
                <div class="flex gap-2"><button onclick="loadOrders()" class="flex-1 bg-p-green text-white py-2 rounded-lg font-bold">ç¯©é¸</button><button onclick="resetFilters()" class="px-4 border py-2 rounded-lg text-stone-400">é‡ç½®</button></div>
            </div>
            <div id="order-list" class="grid grid-cols-1 xl:grid-cols-2 gap-6"></div>
        </section>

        <section id="sec-categories" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-p-green font-serif">åˆ†é¡ç®¡ç†</h2>
            <div class="bg-white p-6 rounded-2xl shadow-sm border max-w-2xl">
                <div class="flex gap-2 mb-6"><input id="new-cat" class="border flex-1 p-3 rounded-xl bg-stone-50" placeholder="æ–°åˆ†é¡åç¨±"><button onclick="addCat()" class="bg-p-green text-white px-6 rounded-xl font-bold">æ–°å¢</button></div>
                <table class="w-full text-left text-sm border-collapse">
                    <thead class="bg-stone-50 text-stone-400 uppercase text-xs"><tr><th class="p-4">æ’åº</th><th class="p-4">åç¨±</th><th class="p-4">ç‹€æ…‹</th><th class="p-4">æ“ä½œ</th></tr></thead>
                    <tbody id="cat-list-table"></tbody>
                </table>
            </div>
        </section>

        <section id="sec-menu" class="hidden space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-3xl font-bold text-p-green font-serif">èœå–®ç·¨è¼¯</h2><button onclick="openMenuModal()" class="bg-p-green text-white px-6 py-2 rounded-lg shadow-lg font-bold">+ æ–°å¢é¤é»</button></div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border flex flex-wrap gap-4 items-end">
                <div class="w-full md:w-64"><label class="block text-xs font-bold text-stone-400 mb-1">æœå°‹èœå</label><input type="text" id="menu-search" oninput="loadMenu()" class="w-full border p-2 rounded-lg" placeholder="è¼¸å…¥é—œéµå­—..."></div>
                <div class="w-full md:w-48"><label class="block text-xs font-bold text-stone-400 mb-1">åˆ†é¡ç¯©é¸</label><select id="menu-cat-filter" onchange="loadMenu()" class="w-full border p-2 rounded-lg"><option value="all">æ‰€æœ‰åˆ†é¡</option></select></div>
            </div>
            <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </section>

        <section id="sec-flavors" class="hidden space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-p-green font-serif">å£å‘³å®šç¾©</h2><button onclick="addFlvGroup()" class="bg-amber-600 text-white px-6 py-2 rounded-xl font-bold shadow-sm">+ æ–°å¢é¸é …çµ„</button></div>
            <div id="flv-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>

        <section id="sec-settings" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-p-green font-serif">ç³»çµ±èˆ‡ Logo è¨­å®š</h2>
            <div class="bg-white p-8 rounded-[2.5rem] border shadow-sm max-w-xl">
                <p class="text-xs text-stone-400 mb-4">æ”¯æ´ SVG (å‘é‡) æˆ– é«˜è§£æ PNG (é€æ˜èƒŒæ™¯)</p>
                <input type="file" id="logo-file" class="w-full border-2 border-dashed p-6 rounded-2xl text-sm mb-4" accept=".svg,.png,.jpg,.jpeg">
                <div id="current-logo-preview" class="hidden mb-4 text-center"><img id="admin-logo-img" src="" class="max-h-20 mx-auto"></div>
                <button onclick="uploadLogo()" class="w-full bg-p-green text-white py-4 rounded-2xl font-bold shadow-lg transition">ç¢ºèªæ›´æ–° Logo</button>
            </div>
        </section>
    </main>

    <div id="set-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center p-4 z-[200]">
        <div class="bg-white w-full max-w-2xl rounded-3xl p-6 shadow-2xl flex flex-col max-h-[90vh]">
            <h3 class="font-bold text-xl mb-4 text-p-green border-b pb-2 font-serif text-center" id="set-modal-title">å¥—é¤åˆ†çµ„è¨­å®š</h3>
            <input type="hidden" id="edit-group-id">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="text-[10px] font-bold text-stone-400 block mb-1 uppercase">åˆ†çµ„åç¨±</label><input id="g-name" placeholder="è¼¸å…¥çµ„å..." class="w-full border p-3 rounded-xl bg-stone-50"></div>
                <div><label class="text-[10px] font-bold text-stone-400 block mb-1 uppercase">å¿…é¸æ•¸é‡</label><input id="g-limit" type="number" value="1" class="w-full border p-3 rounded-xl bg-stone-50 text-center"></div>
            </div>
            <div class="bg-stone-50 p-4 rounded-2xl border flex-1 flex flex-col overflow-hidden">
                <div class="flex justify-between items-center mb-3">
                    <p class="text-xs font-bold text-stone-500 uppercase tracking-widest">å¿«é€Ÿé¸å–å…§å®¹</p>
                    <div class="relative w-1/2"><input type="text" id="set-item-search" oninput="filterPickerItems()" placeholder="æœå°‹èœå..." class="w-full pl-8 pr-4 py-1.5 border rounded-full text-xs focus:ring-1 focus:ring-p-gold outline-none"><span class="absolute left-2.5 top-1.5 text-xs opacity-30">ğŸ”</span></div>
                </div>
                <div id="item-picker-list" class="flex-1 overflow-y-auto grid grid-cols-2 gap-2 pr-2 custom-scrollbar"></div>
                <div class="mt-4 pt-3 border-t flex justify-between items-center">
                    <span id="picker-count" class="text-xs text-stone-400 font-bold">å·²å‹¾é¸ 0 é …</span>
                    <button onclick="addSelectedToPicks()" class="bg-emerald-600 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-md">+ åŠ å…¥æš«å­˜å€</button>
                </div>
            </div>
            <div class="mt-4">
                <p class="text-[10px] font-bold text-stone-400 mb-2 uppercase">å·²é¸é …ç›®ï¼š</p>
                <div id="temp-pick-display" class="flex flex-wrap gap-2 mb-4 max-h-20 overflow-y-auto custom-scrollbar"></div>
                <button onclick="saveFullSet()" id="btn-save-group" class="w-full bg-p-green text-white py-4 rounded-2xl font-bold text-lg shadow-lg">ç¢ºèªå„²å­˜åˆ†çµ„</button>
                <button onclick="resetSetForm()" id="btn-cancel-edit" class="hidden w-full mt-2 text-stone-400 text-xs font-bold">å–æ¶ˆç·¨è¼¯æ¨¡å¼</button>
            </div>
            <div class="border-t pt-4 mt-4 overflow-y-auto max-h-40 custom-scrollbar"><div id="saved-groups-view" class="space-y-2"></div></div>
            <button onclick="closeSetModal()" class="mt-6 text-stone-400 w-full underline text-center font-bold text-sm">å®Œæˆä¸¦é—œé–‰</button>
        </div>
    </div>

    <div id="order-edit-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center p-4 z-[300] backdrop-blur-sm">
        <div class="bg-white w-full max-w-6xl rounded-3xl overflow-hidden shadow-2xl flex flex-col max-h-[95vh]">
            <div class="p-6 bg-p-green text-white flex justify-between items-center"><h3 class="text-xl font-bold font-serif">ä¿®æ”¹è¨‚å–®å…§å®¹</h3><button onclick="closeEditModal()" class="text-2xl">âœ•</button></div>
            <div class="flex flex-1 overflow-hidden">
                <div class="w-2/3 border-r p-4 bg-stone-50 flex flex-col overflow-hidden">
                    <div id="edit-cat-nav" class="mb-2 border-b"></div>
                    <div id="edit-menu-grid" class="grid grid-cols-3 gap-3 overflow-y-auto pt-2 no-scrollbar"></div>
                </div>
                <div class="w-1/3 p-4 flex flex-col bg-white">
                    <h4 class="font-bold mb-4 border-b pb-2 text-stone-400 text-xs tracking-widest uppercase">ç•¶å‰æ¸…å–®</h4>
                    <div id="edit-cart-list" class="flex-1 space-y-2 overflow-y-auto text-sm no-scrollbar"></div>
                    <div class="border-t pt-4 mt-4">
                        <div class="flex justify-between text-xl font-bold text-p-green mb-4"><span>ç¸½è¨ˆ</span><span id="edit-total-price">$0</span></div>
                        <button onclick="saveOrderChange()" class="w-full bg-[#b89150] text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition">ç¢ºèªæ›´æ–°è¨‚å–®</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="menu-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-[100]">
        <div class="bg-white w-full max-w-lg rounded-3xl p-8 shadow-2xl overflow-y-auto max-h-[85vh]">
            <h3 class="font-bold text-xl mb-6 text-p-green border-l-4 border-p-gold pl-3 font-serif">é¤é»åŸºæœ¬è³‡æ–™</h3>
            <input type="hidden" id="m-id">
            <div class="space-y-4">
                <input id="m-name" placeholder="åç¨±" class="w-full border p-3 rounded-xl bg-stone-50 font-bold">
                <textarea id="m-desc" placeholder="æè¿°" class="w-full border p-3 rounded-xl bg-stone-50 h-20"></textarea>
                <div class="grid grid-cols-2 gap-4"><input id="m-price" type="number" placeholder="åƒ¹æ ¼" class="border p-3 rounded-xl bg-stone-50"><select id="m-cat" class="border p-3 rounded-xl bg-stone-50"></select></div>
                <div class="bg-stone-100 p-4 rounded-2xl"><p class="text-[10px] font-bold text-stone-500 mb-2 uppercase">å£å‘³æ¨™ç±¤å‹¾é¸</p><div id="flv-checks" class="grid grid-cols-2 gap-2"></div></div>
                <div class="p-2 border-2 border-dashed rounded-xl border-stone-200"><label class="block text-xs font-bold text-gray-400">ä¸Šå‚³ç›¸ç‰‡</label><input type="file" id="m-img" class="w-full text-xs"></div>
                <label class="flex items-center gap-3 p-4 bg-emerald-50 rounded-2xl cursor-pointer font-bold"><input type="checkbox" id="m-is-set" class="accent-p-green"> é€™æ˜¯ã€Œå¥—é¤çµ„åˆã€æ¨¡å¼</label>
            </div>
            <div class="flex gap-3 mt-8"><button onclick="closeMenuModal()" class="flex-1 bg-gray-100 py-3 rounded-2xl font-bold text-stone-400">å–æ¶ˆ</button><button onclick="saveItem()" class="flex-1 bg-p-green text-white py-3 rounded-2xl font-bold shadow-md">å„²å­˜é¤é»</button></div>
        </div>
    </div>

    <div id="edit-flavor-popup" class="fixed inset-0 bg-black/70 hidden flex items-center justify-center p-4 z-[400] backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl flex flex-col max-h-[85vh]">
            <h4 class="font-bold text-lg mb-4 text-p-green font-serif" id="edit-pop-title">å£å‘³é¸æ“‡</h4>
            <div id="edit-pop-content" class="space-y-6 overflow-y-auto flex-1 pr-2 no-scrollbar"></div>
            <div class="flex gap-3 mt-6"><button onclick="closeEditPop()" class="flex-1 bg-stone-100 py-3 rounded-xl font-bold text-stone-400">å–æ¶ˆ</button><button onclick="confirmEditPop()" class="flex-[2] bg-p-green text-white py-3 rounded-xl font-bold shadow-lg">ç¢ºèªæ›´æ–°</button></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
        const _s = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let allMenuItems = [], allCategories = [], curEditOrder = null, editCart = [], curEditItem = null, curEditPopSels = { flavors: {}, groups: {} };
        let reEditIndex = -1, curPicks = [], curItem = null, currentEditingGroupId = null;

        async function switchTab(t) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('sidebar-btn-active'));
            document.getElementById(`sec-${t}`).classList.remove('hidden');
            document.getElementById(`btn-${t}`).classList.add('sidebar-btn-active');
            if(t==='orders') loadOrders(); 
            if(t==='menu') { await loadCats(); loadMenu(); } 
            if(t==='categories') loadCats(); 
            if(t==='flavors') loadFlvs(); 
            if(t==='settings') loadSettings();
        }

        // --- 1. è¨‚å–®ç®¡ç† ---
        async function loadOrders() {
            const search = document.getElementById('filter-search').value;
            const date = document.getElementById('filter-date').value;
            const status = document.getElementById('filter-status').value;
            let query = _s.from('orders').select('*').order('created_at', {ascending:false});
            if(search) query = query.or(`customer_name.ilike.%${search}%,phone.ilike.%${search}%`);
            if(date) query = query.gte('created_at', `${date}T00:00:00`).lte('created_at', `${date}T23:59:59`);
            if(status !== 'all') query = query.eq('status', status);
            const { data } = await query;
            document.getElementById('order-list').innerHTML = data.map(o => `
                <div class="bg-white p-6 rounded-3xl shadow-sm border ${o.status==='synced'?'opacity-50 grayscale border-stone-100':'border-emerald-200 shadow-emerald-50'}">
                    <div class="flex justify-between font-bold text-xl mb-2"><span class="text-p-green font-serif">${o.customer_name}</span><span class="text-p-gold">$${o.total_price}</span></div>
                    <div class="text-xs text-stone-400 mb-4">${new Date(o.created_at).toLocaleString()} | ${o.phone}</div>
                    <div class="bg-amber-50 p-3 rounded-xl border border-amber-100 mb-4 text-stone-600 text-sm">å‚™è¨»: ${o.note || 'ç„¡'}</div>
                    <div class="space-y-1 mb-6 text-sm text-stone-500 bg-stone-50 p-4 rounded-2xl">${o.order_content.map(i => `â€¢ ${i.name}`).join('<br>')}</div>
                    <div class="flex gap-3"><button onclick="openEditOrder('${o.id}')" class="flex-1 bg-stone-100 py-3 rounded-xl font-bold text-xs">ä¿®æ”¹ç´°é …</button><button onclick="sync('${o.id}')" class="flex-1 bg-p-green text-white py-3 rounded-xl text-xs font-bold">${o.status==='synced'?'å·²åŒæ­¥':'åŒæ­¥ç‹€æ…‹'}</button></div>
                    <button onclick="delOrder('${o.id}')" class="w-full mt-2 py-2 text-red-300 text-[9px] font-bold border border-red-50 rounded-lg">æ°¸ä¹…åˆªé™¤</button>
                </div>`).join('');
            window.ordersRef = data;
        }

        async function openEditOrder(id) {
            curEditOrder = window.ordersRef.find(o => o.id === id);
            editCart = JSON.parse(JSON.stringify(curEditOrder.order_content)); 
            document.getElementById('order-edit-modal').classList.remove('hidden');
            const { data: items } = await _s.from('menu_items').select('*, categories(name), item_flavor_relation(flavor_groups(*, flavor_options(*))), set_menu_groups(*, set_menu_contents(menu_items(*, item_flavor_relation(flavor_groups(*, flavor_options(*))))))').eq('is_hidden', false);
            allMenuItems = items;
            const { data: cats } = await _s.from('categories').select('*').order('sort_order');
            allCategories = cats;
            document.getElementById('edit-cat-nav').innerHTML = cats.map(c => `<button onclick="renderEditMenu('${c.id}')" class="px-5 py-2 bg-white border border-stone-200 rounded-full text-xs font-bold hover:border-p-green transition mr-2">${c.name}</button>`).join('');
            if(cats.length) renderEditMenu(cats[0].id); refreshEditCart();
        }

        function renderEditMenu(cid) {
            document.getElementById('edit-menu-grid').innerHTML = allMenuItems.filter(i => i.category_id === cid).map(i => `<div onclick="openEditPop('${i.id}')" class="bg-white p-3 rounded-xl border border-stone-100 cursor-pointer hover:border-p-gold shadow-sm flex flex-col justify-between"><div class="font-bold text-xs line-clamp-2">${i.name}</div><div class="text-p-gold font-bold text-xs mt-2">$${i.price}</div></div>`).join('');
        }

        function openEditPop(itemId, index = -1) {
            reEditIndex = index;
            if (index > -1) {
                const baseName = editCart[index].name.split(" [")[0].split(" (")[0];
                curEditItem = allMenuItems.find(i => i.name === baseName);
            } else { curEditItem = allMenuItems.find(i => i.id === itemId); }
            if (!curEditItem) return;
            curEditPopSels = { flavors: {}, groups: {} };
            const container = document.getElementById('edit-pop-content');
            container.innerHTML = "";
            if (curEditItem.item_flavor_relation?.length > 0) {
                container.innerHTML += curEditItem.item_flavor_relation.map(r => `<div><p class="text-[10px] text-stone-400 mb-2 uppercase">${r.flavor_groups.name}</p><div class="flex flex-wrap gap-2">${r.flavor_groups.flavor_options.map(o => `<div onclick="setEditPopFlv(this, '${r.flavor_groups.id}', '${o.option_name}')" class="px-4 py-1.5 border border-stone-200 rounded-full text-xs cursor-pointer bg-stone-50 transition">${o.option_name}</div>`).join('')}</div></div>`).join('');
            }
            if (curEditItem.is_set_menu && curEditItem.set_menu_groups) {
                container.innerHTML += curEditItem.set_menu_groups.map(g => {
                    curEditPopSels.groups[g.id] = [];
                    return `<div><p class="text-[10px] text-p-green font-bold mb-2 uppercase">${g.group_name} (å¿…é¸ ${g.selection_limit})</p><div class="grid grid-cols-2 gap-2">${g.set_menu_contents.map(c => `<div onclick="setEditPopGroup(this, '${g.id}', '${c.menu_items.name}', ${g.selection_limit})" class="p-3 bg-stone-50 border rounded-xl text-[11px] cursor-pointer text-center font-bold">${c.menu_items.name}</div>`).join('')}</div></div>`;
                }).join('');
            }
            document.getElementById('edit-pop-title').innerText = curEditItem.name;
            document.getElementById('edit-flavor-popup').classList.remove('hidden');
        }

        function setEditPopFlv(el, gid, name) { Array.from(el.parentElement.children).forEach(c => c.classList.remove('flavor-selected')); el.classList.add('flavor-selected'); curEditPopSels.flavors[gid] = name; }
        function setEditPopGroup(el, gid, name, limit) {
            const sibs = Array.from(el.parentElement.children);
            if(limit === 1) { sibs.forEach(s => s.classList.remove('opt-selected')); el.classList.add('opt-selected'); curEditPopSels.groups[gid] = [{ name }]; }
            else { 
                let s = curEditPopSels.groups[gid];
                if(s.some(x => x.name === name)) { s = s.filter(x => x.name !== name); el.classList.remove('opt-selected'); }
                else if(s.length < limit) { s.push({ name }); el.classList.add('opt-selected'); }
                curEditPopSels.groups[gid] = s;
            }
        }

        function confirmEditPop() {
            const fn = Object.values(curEditPopSels.flavors).join('/');
            const gn = Object.values(curEditPopSels.groups).flat().map(x => x.name).join('ã€');
            const finalName = `${curEditItem.name}${fn ? ` [${fn}]` : ""}${gn ? ` (${gn})` : ""}`;
            if (reEditIndex > -1) { editCart[reEditIndex] = { name: finalName, price: Number(curEditItem.price) }; }
            else { editCart.push({ name: finalName, price: Number(curEditItem.price) }); }
            closeEditPop(); refreshEditCart();
        }

        function refreshEditCart() {
            const container = document.getElementById('edit-cart-list');
            container.innerHTML = editCart.map((i, idx) => `
                <div class="flex flex-col bg-stone-50 p-3 rounded-xl border border-stone-100 mb-2 relative">
                    <div onclick="openEditPop(null, ${idx})" class="cursor-pointer pr-8"><span class="font-bold text-xs text-p-green underline decoration-dotted decoration-p-gold">${i.name}</span><div class="text-[9px] text-stone-400 mt-1">$${i.price} (é»æ“Šä¿®æ”¹)</div></div>
                    <button onclick="editCart.splice(${idx},1);refreshEditCart();" class="absolute top-2 right-2 text-red-300">âœ•</button>
                </div>`).join('');
            document.getElementById('edit-total-price').innerText = `$${editCart.reduce((sum, item) => sum + Number(item.price), 0)}`;
        }

        async function saveOrderChange() {
            const total = editCart.reduce((sum, item) => sum + Number(item.price), 0);
            await _s.from('orders').update({ order_content: editCart, total_price: total }).eq('id', curEditOrder.id);
            alert("è¨‚å–®å·²æ›´æ–°"); closeEditModal(); loadOrders();
        }

        function closeEditPop() { document.getElementById('edit-flavor-popup').classList.add('hidden'); }
        function closeEditModal() { document.getElementById('order-edit-modal').classList.add('hidden'); }
        async function delOrder(id) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { await _s.from('orders').delete().eq('id', id); loadOrders(); } }
        async function sync(id) { await _s.from('orders').update({ status: 'synced' }).eq('id', id); loadOrders(); }

        // --- 2. åˆ†é¡ç®¡ç† (ä¿®å¾©é¡¯ç¤ºéš±è—æ ¸å¿ƒ) ---
        async function loadCats() {
            const { data } = await _s.from('categories').select('*').order('sort_order', { ascending: true });
            allCategories = data;
            const tableBody = document.getElementById('cat-list-table');
            tableBody.innerHTML = data.map(c => `
                <tr class="border-b hover:bg-stone-50 transition">
                    <td class="p-4"><input type="number" value="${c.sort_order || 0}" onchange="updateCatSort('${c.id}', this.value)" class="w-16 border rounded p-1 text-center text-xs outline-none"></td>
                    <td class="p-4 font-bold text-p-green">${c.name}</td>
                    <td class="p-4">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" ${c.is_visible ? 'checked' : ''} onchange="updateCatVis('${c.id}', this.checked)">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-p-green"></div>
                        </label>
                    </td>
                    <td class="p-4"><button onclick="delCat('${c.id}')" class="text-red-400 hover:text-red-600 text-xs">åˆªé™¤</button></td>
                </tr>`).join('');
            document.getElementById('m-cat').innerHTML = data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('menu-cat-filter').innerHTML = '<option value="all">æ‰€æœ‰åˆ†é¡</option>' + data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        async function updateCatVis(id, b) { await _s.from('categories').update({ is_visible: b }).eq('id', id); loadCats(); }
        async function updateCatSort(id, v) { await _s.from('categories').update({ sort_order: parseInt(v) }).eq('id', id); loadCats(); }
        async function addCat() { const n = document.getElementById('new-cat').value; if(n) await _s.from('categories').insert([{ name: n, sort_order: 99, is_visible: true }]); document.getElementById('new-cat').value=""; loadCats(); }
        async function delCat(id) { if(confirm('åˆªé™¤å°‡å½±éŸ¿è©²é¡å“é …é¡¯ç¤ºï¼Œç¢ºå®šï¼Ÿ')) { await _s.from('categories').delete().eq('id', id); loadCats(); } }

        // --- 3. èœå–®åŸºç¤ç·¨è¼¯ ---
        async function loadMenu() {
            const search = document.getElementById('menu-search').value.toLowerCase();
            const catF = document.getElementById('menu-cat-filter').value;
            const { data } = await _s.from('menu_items').select('*, categories(name)').order('created_at', {ascending:false});
            const filtered = data.filter(i => i.name.toLowerCase().includes(search) && (catF === 'all' || i.category_id === catF));
            document.getElementById('menu-grid').innerHTML = filtered.map(i => `
                <div class="bg-white rounded-3xl border p-4 shadow-sm flex flex-col">
                    <div class="h-32 bg-stone-50 rounded-2xl mb-3 flex items-center justify-center overflow-hidden"><img src="${i.image_url || ''}" class="img-contain max-h-full"></div>
                    <div class="flex justify-between font-bold mb-1"><span>${i.name}</span><span class="text-p-gold">$${i.price}</span></div>
                    <div class="flex gap-2 mt-auto pt-4"><button onclick="editItem('${i.id}')" class="flex-1 py-1.5 rounded-lg bg-stone-100 text-xs font-bold">ç·¨è¼¯</button>${i.is_set_menu?`<button onclick="openSetModal('${i.id}')" class="flex-1 py-1.5 rounded-lg bg-amber-500 text-white text-xs font-bold">âš™ï¸ å¥—é¤</button>`:''}<button onclick="delItem('${i.id}')" class="px-2 text-red-200">âœ•</button></div>
                </div>`).join('');
        }

        async function editItem(id) {
            const { data: i } = await _s.from('menu_items').select('*, item_flavor_relation(*)').eq('id', id).single();
            document.getElementById('m-id').value = i.id; document.getElementById('m-name').value = i.name; document.getElementById('m-price').value = i.price; document.getElementById('m-desc').value = i.description || ''; document.getElementById('m-is-set').checked = i.is_set_menu;
            await openMenuModal(true);
            setTimeout(() => { i.item_flavor_relation.forEach(r => { const c = document.querySelector(`.flv-chk[value="${r.flavor_group_id}"]`); if(c) c.checked=true; }); }, 500);
        }

        async function openMenuModal(isEdit) { 
            document.getElementById('menu-modal').classList.remove('hidden'); 
            const { data: flvs } = await _s.from('flavor_groups').select('*');
            document.getElementById('flv-checks').innerHTML = flvs.map(f => `<label class="flex items-center gap-1 text-xs"><input type="checkbox" class="flv-chk" value="${f.id}"> ${f.name}</label>`).join('');
        }

        async function saveItem() {
            const id = document.getElementById('m-id').value; const file = document.getElementById('m-img').files[0]; let url = "";
            if(file) { const p = `items/${Date.now()}.png`; await _s.storage.from('assets').upload(p, file); const { data } = _s.storage.from('assets').getPublicUrl(p); url = data.publicUrl; }
            const p = { name: document.getElementById('m-name').value, price: document.getElementById('m-price').value, description: document.getElementById('m-desc').value, category_id: document.getElementById('m-cat').value, is_set_menu: document.getElementById('m-is-set').checked };
            if(url) p.image_url = url;
            const { data: saved } = id ? await _s.from('menu_items').update(p).eq('id', id).select() : await _s.from('menu_items').insert([p]).select();
            if (saved) {
                const itemId = saved[0].id; await _s.from('item_flavor_relation').delete().eq('item_id', itemId);
                const rels = Array.from(document.querySelectorAll('.flv-chk:checked')).map(c => ({ item_id: itemId, flavor_group_id: c.value }));
                if (rels.length) await _s.from('item_flavor_relation').insert(rels);
                closeMenuModal(); loadMenu();
            }
        }
        async function delItem(id) { if(confirm('ç¢ºå®šåˆªé™¤é¤é»ï¼Ÿ')) { await _s.from('menu_items').delete().eq('id', id); loadMenu(); } }

        // --- 4. å¥—é¤é€²éšç®¡ç† (ç·¨è¼¯ã€é¸å–ã€æ‰¹é‡æ›´æ–°) ---
        async function openSetModal(id) { 
            curItem = id; resetSetForm(); 
            document.getElementById('set-modal').classList.remove('hidden'); 
            const { data } = await _s.from('menu_items').select('*, categories(name)').eq('is_set_menu', false).order('name'); 
            window.allPickerItems = data; renderPickerList(data); loadSavedSets(); 
        }

        function renderPickerList(items) {
            const container = document.getElementById('item-picker-list');
            const grouped = items.reduce((acc, i) => { const cat = i.categories?.name || 'æœªåˆ†é¡'; if (!acc[cat]) acc[cat] = []; acc[cat].push(i); return acc; }, {});
            container.innerHTML = Object.keys(grouped).map(cat => `
                <div class="col-span-2 mt-2 font-black text-[9px] text-stone-300 border-b pb-1 uppercase tracking-widest">${cat}</div>
                ${grouped[cat].map(i => `<div id="picker-${i.id}" onclick="togglePickerSelect('${i.id}', '${i.name}')" class="picker-item flex justify-between p-3 border rounded-xl bg-white cursor-pointer hover:shadow-sm transition text-xs font-bold text-slate-600"><span>${i.name}</span><div class="check-mark hidden text-p-gold">âœ”</div></div>`).join('')}
            `).join('');
            updatePickerStats();
        }

        function filterPickerItems() {
            const kw = document.getElementById('set-item-search').value.toLowerCase();
            renderPickerList(window.allPickerItems.filter(i => i.name.toLowerCase().includes(kw)));
            pickerSelectedItems.forEach(s => { const el = document.getElementById(`picker-${s.id}`); if(el) el.classList.add('active'); });
        }

        function togglePickerSelect(id, name) {
            const el = document.getElementById(`picker-${id}`);
            const idx = pickerSelectedItems.findIndex(x => x.id === id);
            if(idx > -1) { pickerSelectedItems.splice(idx, 1); el?.classList.remove('active'); }
            else { pickerSelectedItems.push({ id, name }); el?.classList.add('active'); }
            updatePickerStats();
        }

        function updatePickerStats() { document.getElementById('picker-count').innerText = `å·²å‹¾é¸ ${pickerSelectedItems.length} é …`; }

        function addSelectedToPicks() {
            pickerSelectedItems.forEach(s => { if(!curPicks.some(p => p.id === s.id)) curPicks.push(s); });
            pickerSelectedItems = []; renderTempPicks();
            document.querySelectorAll('.picker-item').forEach(el => el.classList.remove('active')); updatePickerStats();
        }

        function renderTempPicks() {
            document.getElementById('temp-pick-display').innerHTML = curPicks.map((p, idx) => `<div class="bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full text-[10px] font-bold flex items-center gap-2">${p.name} <span onclick="curPicks.splice(${idx},1);renderTempPicks();" class="cursor-pointer opacity-40">âœ•</span></div>`).join('');
        }

        async function editSetGroup(groupId) {
            currentEditingGroupId = groupId;
            const { data: g } = await _s.from('set_menu_groups').select('*, set_menu_contents(menu_items(*))').eq('id', groupId).single();
            if(g) {
                document.getElementById('g-name').value = g.group_name; document.getElementById('g-limit').value = g.selection_limit;
                document.getElementById('set-modal-title').innerText = "ç·¨è¼¯åˆ†çµ„å…§å®¹";
                document.getElementById('btn-save-group').innerText = "å„²å­˜æ›´æ–°å…§å®¹";
                document.getElementById('btn-cancel-edit').classList.remove('hidden');
                curPicks = g.set_menu_contents.map(c => ({ id: c.menu_items.id, name: c.menu_items.name }));
                renderTempPicks();
                document.getElementById('set-modal').querySelector('div').scrollTo({top:0, behavior:'smooth'});
            }
        }

        function resetSetForm() {
            currentEditingGroupId = null; document.getElementById('g-name').value = ""; document.getElementById('g-limit').value = 1;
            document.getElementById('temp-pick-display').innerHTML = ""; document.getElementById('set-modal-title').innerText = "å¥—é¤åˆ†çµ„è¨­å®š";
            document.getElementById('btn-save-group').innerText = "ç¢ºèªå„²å­˜ä¸¦å»ºç«‹åˆ†çµ„"; document.getElementById('btn-cancel-edit').classList.add('hidden');
            curPicks = []; pickerSelectedItems = []; updatePickerStats();
            document.querySelectorAll('.picker-item').forEach(el => el.classList.remove('active'));
        }

        async function saveFullSet() { 
            const name = document.getElementById('g-name').value;
            const limit = document.getElementById('g-limit').value;
            if(!name || !curPicks.length) return alert("è«‹è¼¸å…¥å®Œæ•´åç¨±èˆ‡é …ç›®");
            let gid = currentEditingGroupId;
            if (gid) {
                await _s.from('set_menu_groups').update({ group_name: name, selection_limit: limit }).eq('id', gid);
                await _s.from('set_menu_contents').delete().eq('group_id', gid);
            } else {
                const { data: g } = await _s.from('set_menu_groups').insert([{ parent_set_id: curItem, group_name: name, selection_limit: limit }]).select();
                if(g) gid = g[0].id;
            }
            if(gid) {
                await _s.from('set_menu_contents').insert(curPicks.map(p => ({ group_id: gid, item_id: p.id }))); 
                resetSetForm(); loadSavedSets();
            } 
        }

        async function loadSavedSets() { 
            const { data } = await _s.from('set_menu_groups').select('*, set_menu_contents(menu_items(*))').eq('parent_set_id', curItem); 
            document.getElementById('saved-groups-view').innerHTML = data.map(g => `<div class="p-3 bg-stone-50 border rounded-xl flex justify-between items-center shadow-inner group"><div class="flex-1"><b class="text-xs text-p-green">${g.group_name} (é™ ${g.selection_limit})</b><p class="text-[10px] text-gray-400 line-clamp-1">${g.set_menu_contents.map(c => c.menu_items?.name).join('ã€')}</p></div><div class="flex gap-2"><button onclick="editSetGroup('${g.id}')" class="text-p-gold text-xs font-bold px-2 py-1 border rounded">ç·¨è¼¯</button><button onclick="delSetGroup('${g.id}')" class="text-red-400 text-xs px-2 py-1 border rounded">åˆªé™¤</button></div></div>`).join(''); 
        }

        async function delSetGroup(id) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { await _s.from('set_menu_groups').delete().eq('id', id); loadSavedSets(); } }

        // --- 5. ç³»çµ±è¨­å®š (SVG é«˜æ¸…å„ªåŒ–) ---
        async function loadSettings() {
            const { data } = await _s.from('store_settings').select('*').eq('id', 1).single();
            if(data?.logo_url) {
                const highResUrl = `${data.logo_url}?t=${Date.now()}`;
                document.getElementById('current-logo-preview').classList.remove('hidden');
                document.getElementById('admin-logo-img').src = highResUrl;
            }
        }

        async function uploadLogo() {
            const f = document.getElementById('logo-file').files[0];
            if(!f) return alert("è«‹å…ˆé¸å–æª”æ¡ˆ");
            const ext = f.name.split('.').pop().toLowerCase();
            const path = `logo_${Date.now()}.${ext}`;
            const type = ext === 'svg' ? 'image/svg+xml' : f.type;
            const { error: upErr } = await _s.storage.from('assets').upload(path, f, { contentType: type, cacheControl: '3600', upsert: true });
            if(upErr) return alert("ä¸Šå‚³å¤±æ•—: " + upErr.message);
            const { data } = _s.storage.from('assets').getPublicUrl(path);
            await _s.from('store_settings').update({ logo_url: data.publicUrl }).eq('id', 1);
            alert("é«˜æ¸… Logo æ›´æ–°æˆåŠŸï¼"); loadSettings();
        }

        function closeMenuModal() { document.getElementById('menu-modal').classList.add('hidden'); }
        function closeSetModal() { document.getElementById('set-modal').classList.add('hidden'); }
        function exportXls() { 
            const exp = window.ordersRef.map(o => ({ 'æ™‚é–“': new Date(o.created_at).toLocaleString(), 'å®¢æˆ¶': o.customer_name, 'é›»è©±': o.phone, 'ç¸½è¨ˆ': o.total_price, 'å‚™è¨»': o.note || '' }));
            const ws = XLSX.utils.json_to_sheet(exp); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "å ±è¡¨"); XLSX.writeFile(wb, `çœŸç å ±è¡¨_${Date.now()}.xlsx`);
        }
        function resetFilters() { document.getElementById('filter-search').value=''; document.getElementById('filter-date').value=''; document.getElementById('filter-status').value='all'; loadOrders(); }
        async function loadFlvs() { const { data } = await _s.from('flavor_groups').select('*, flavor_options(*)'); document.getElementById('flv-grid').innerHTML = data.map(g => `<div class="bg-white p-5 rounded-2xl border flex justify-between"><div><b>ğŸŒ¶ï¸ ${g.name}</b><p class="text-xs text-stone-400">${g.flavor_options.map(o=>o.option_name).join(', ')}</p></div><button onclick="delFlv('${g.id}')" class="text-red-400">âœ•</button></div>`).join(''); }
        async function addFlvGroup() { const n = prompt("çµ„å"); const o = prompt("é¸é …(é€—è™Ÿéš”é–‹)"); if(n && o) { const { data: g } = await _s.from('flavor_groups').insert([{ name: n }]).select(); if(g) await _s.from('flavor_options').insert(o.split(',').map(nm => ({ group_id: g[0].id, option_name: nm.trim() }))); loadFlvs(); } }
        async function delFlv(id) { if(confirm('åˆªï¼Ÿ')) { await _s.from('flavor_groups').delete().eq('id', id); loadFlvs(); } }
        switchTab('orders');
    </script>
</body>
</html>
