<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çœŸç ç®¡ç†å¾Œå° - æ——è‰¦åŠŸèƒ½å…¨æ•´åˆç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --p-green: #004d40; } 
        .bg-p-green { background-color: var(--p-green); }
        .text-p-green { color: var(--p-green); }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex">
    <aside class="w-64 bg-emerald-900 text-white p-6 sticky top-0 h-screen shadow-xl">
        <h2 class="text-xl font-bold mb-10 border-b border-emerald-700 pb-4 text-center tracking-widest">çœŸç  ADMIN</h2>
        <nav class="space-y-2">
            <button onclick="switchTab('orders')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition">ğŸ“‹ è¨‚å–®ç›£æ§</button>
            <button onclick="switchTab('categories')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition">ğŸ—‚ï¸ åˆ†é¡ç®¡ç†</button>
            <button onclick="switchTab('menu')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition">ğŸ± èœå–®ç·¨è¼¯</button>
            <button onclick="switchTab('settings')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition">âš™ï¸ ç³»çµ±è¨­å®š</button>
        </nav>
    </aside>

    <main class="flex-1 p-8">
        <section id="sec-orders" class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-emerald-900">å³æ™‚è¨‚å–®ç®¡ç†</h2>
                <button onclick="exportExcel()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg hover:bg-blue-700 transition">ğŸ“Š å°å‡ºè©³ç´° Excel</button>
            </div>
            
            <div class="bg-white p-4 rounded-xl shadow-sm border flex gap-4 items-end">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸç¯©é¸</label>
                    <input type="date" id="filter-date" class="border p-2 rounded-lg text-sm outline-none focus:ring-1 focus:ring-emerald-500">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ç‹€æ…‹</label>
                    <select id="filter-status" class="border p-2 rounded-lg text-sm outline-none">
                        <option value="all">å…¨éƒ¨ç‹€æ…‹</option>
                        <option value="pending">å¾…è™•ç†</option>
                        <option value="completed">å·²å®Œæˆ</option>
                    </select>
                </div>
                <button onclick="loadOrders()" class="bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-bold">åŸ·è¡Œç¯©é¸</button>
                <button onclick="resetFilters()" class="text-gray-400 text-xs mb-2 underline">æ¸…é™¤ç¯©é¸</button>
            </div>

            <div id="order-list" class="grid gap-4"></div>
        </section>

        <section id="sec-categories" class="hidden space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-emerald-900">èœå–®åˆ†é¡ç®¡ç†</h2>
                <div class="flex gap-2">
                    <input type="text" id="new-cat-name" placeholder="åˆ†é¡åç¨± (å¦‚:ä¸»é¤)" class="border p-2 rounded-lg text-sm">
                    <button onclick="addCategory()" class="bg-p-green text-white px-4 py-2 rounded-lg shadow font-bold">+ æ–°å¢</button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-stone-100 text-sm">
                        <tr><th class="p-4">æ’åº</th><th class="p-4">åˆ†é¡åç¨±</th><th class="p-4">æ“ä½œ</th></tr>
                    </thead>
                    <tbody id="cat-table-body"></tbody>
                </table>
            </div>
        </section>

        <section id="sec-menu" class="hidden space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-emerald-900">é¤é»è©³ç´°è¨­å®š</h2>
                <button onclick="openMenuModal()" class="bg-p-green text-white px-6 py-2 rounded-lg shadow-lg font-bold">+ æ–°å¢é¤é»</button>
            </div>
            <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <section id="sec-settings" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-emerald-900">å“ç‰Œè¦–è¦ºè¨­å®š</h2>
            <div class="bg-white p-6 rounded-xl border max-w-md shadow-sm">
                <label class="block font-bold mb-2">æ›´æ–°å‰å° Logo</label>
                <input type="file" id="logo-file" class="text-sm mb-4">
                <button onclick="uploadLogo()" class="w-full bg-amber-600 text-white py-2 rounded font-bold shadow">ç¢ºèªä¸Šå‚³åœ–ç‰‡</button>
                <div id="logo-preview-area" class="mt-4 hidden border-t pt-4">
                    <p class="text-xs text-gray-400 mb-2">ç›®å‰é è¦½ï¼š</p>
                    <img id="cur-logo" src="" class="h-16 object-contain">
                </div>
            </div>
        </section>
    </main>

    <div id="group-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center p-4 z-[200] backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl">
            <h3 class="font-bold text-xl mb-6 text-p-green border-b pb-2">è¨­å®šå¥—é¤åˆ†çµ„</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="g-name" placeholder="çµ„åˆ¥åç¨± (å¦‚:ä¸»é£Ÿ)" class="border p-3 rounded-xl focus:ring-1 focus:ring-p-green">
                    <input type="number" id="g-limit" placeholder="å¿…é¸æ•¸é‡" class="border p-3 rounded-xl focus:ring-1 focus:ring-p-green">
                </div>
                <textarea id="g-opts" placeholder="é¸é … (é€—è™Ÿéš”é–‹, å¦‚: é›è‚‰,ç‰›è‚‰,è±¬è‚‰)" rows="3" class="w-full border p-3 rounded-xl focus:ring-1 focus:ring-p-green"></textarea>
                <button onclick="saveGroup()" class="w-full bg-amber-500 text-white py-3 rounded-xl font-bold shadow">å„²å­˜æ­¤çµ„åˆ¥</button>
                <div id="group-list-preview" class="space-y-2 pt-4 max-h-40 overflow-y-auto"></div>
            </div>
            <button onclick="closeGroupModal()" class="mt-6 w-full py-3 bg-gray-100 rounded-xl font-bold">é—œé–‰è¨­å®š</button>
        </div>
    </div>

    <div id="menu-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-[100]">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-xl">
            <h3 class="font-bold text-xl mb-4">é¤é»è³‡è¨Šç·¨è¼¯</h3>
            <div class="space-y-3 overflow-y-auto max-h-[70vh] p-1">
                <input type="text" id="m-name" placeholder="é¤é»åç¨±" class="w-full border p-3 rounded-xl">
                <textarea id="m-desc" placeholder="é¤é»ä»‹ç´¹" class="w-full border p-3 rounded-xl" rows="2"></textarea>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="m-price" placeholder="åƒ¹æ ¼" class="w-full border p-3 rounded-xl">
                    <select id="m-cat" class="w-full border p-3 rounded-xl"></select>
                </div>
                <div class="bg-stone-50 p-3 rounded-xl">
                    <label class="block text-xs text-gray-400 mb-1">ä¸Šå‚³åœ–ç‰‡ (å»ºè­°æ­£æ–¹å½¢)</label>
                    <input type="file" id="m-img" class="w-full text-xs">
                </div>
                <label class="flex items-center gap-2 font-bold p-2 cursor-pointer">
                    <input type="checkbox" id="m-is-set" class="w-5 h-5"> é€™æ˜¯å¥—é¤ (éœ€é–‹å•Ÿå¾Œæ‰èƒ½è¨­å®šåˆ†çµ„)
                </label>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeMenuModal()" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">å–æ¶ˆ</button>
                <button onclick="saveMenuItem()" class="flex-1 py-3 bg-p-green text-white rounded-xl font-bold">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
        const _s = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let curItem = null;
        let allCategories = [];

        function switchTab(t) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`sec-${t}`).classList.remove('hidden');
            if(t === 'orders') loadOrders(); 
            if(t === 'categories') loadCategories();
            if(t === 'menu') loadMenuAdmin();
            if(t === 'settings') loadSettings();
        }

        // --- è¨‚å–®èˆ‡ç¯©é¸åŠŸèƒ½ ---
        async function loadOrders() {
            const dateVal = document.getElementById('filter-date').value;
            const statusVal = document.getElementById('filter-status').value;

            let query = _s.from('orders').select('*').order('created_at', {ascending:false});
            
            if(dateVal) {
                query = query.gte('created_at', `${dateVal}T00:00:00`).lte('created_at', `${dateVal}T23:59:59`);
            }
            if(statusVal !== 'all') {
                query = query.eq('status', statusVal);
            }

            const { data } = await query;
            const list = document.getElementById('order-list');
            list.innerHTML = data.map(o => `
                <div class="bg-white p-6 rounded-2xl shadow-sm border ${o.status === 'completed' ? 'opacity-50 grayscale' : 'border-emerald-100'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-xs px-2 py-1 rounded ${o.status === 'completed' ? 'bg-gray-400' : 'bg-emerald-600'} text-white font-bold mb-2 inline-block">${o.status === 'completed' ? 'å·²å®Œæˆ' : 'å¾…è™•ç†'}</span>
                            <h3 class="font-bold text-lg leading-tight">${o.customer_name} <br>
                                <span class="text-sm font-normal text-emerald-800">
                                    (${o.adults}å¤§ / ${o.kids_chair || 0}å…’ç«¥éœ€æ¤… / ${o.toddlers || 0}å­©ç«¥ä¸éœ€æ¤…)
                                </span>
                            </h3>
                            <p class="text-xs text-gray-400 mt-1">${new Date(o.created_at).toLocaleString()} | ${o.phone}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-emerald-800 text-xl">$${o.total_price}</p>
                            ${o.status === 'pending' ? `<button onclick="updateStatus('${o.id}', 'completed')" class="bg-emerald-100 text-emerald-700 px-4 py-2 rounded-full text-xs font-bold mt-3 hover:bg-emerald-200 transition">æ¨™è¨˜å®Œæˆ</button>` : ''}
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-stone-100 text-sm text-gray-600 space-y-1">
                        ${o.order_content.map(i => `<div class="flex justify-between"><span>â€¢ ${i.name}</span><span>$${i.price}</span></div>`).join('')}
                    </div>
                </div>
            `).join('');
            window.allOrders = data;
        }

        function resetFilters() {
            document.getElementById('filter-date').value = '';
            document.getElementById('filter-status').value = 'all';
            loadOrders();
        }

        // --- åˆ†é¡ç®¡ç†å›æ­¸ ---
        async function loadCategories() {
            const { data } = await _s.from('categories').select('*').order('sort_order');
            allCategories = data;
            const body = document.getElementById('cat-table-body');
            body.innerHTML = data.map(c => `
                <tr class="border-b">
                    <td class="p-4 text-sm">${c.sort_order}</td>
                    <td class="p-4 font-bold">${c.name}</td>
                    <td class="p-4 flex gap-2 text-xs">
                        <button onclick="deleteCat('${c.id}')" class="text-red-500 underline">åˆªé™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        async function addCategory() {
            const name = document.getElementById('new-cat-name').value;
            if(!name) return alert("è«‹è¼¸å…¥åç¨±");
            await _s.from('categories').insert([{ name, sort_order: 99 }]);
            document.getElementById('new-cat-name').value = '';
            loadCategories();
        }

        async function deleteCat(id) {
            if(confirm('åˆªé™¤åˆ†é¡å¯èƒ½å°è‡´è©²åˆ†é¡ä¸‹çš„é¤é»ç„¡æ³•é¡¯ç¤ºï¼Œç¢ºå®šï¼Ÿ')) {
                await _s.from('categories').delete().eq('id', id);
                loadCategories();
            }
        }

        // --- Excel å°å‡ºå„ªåŒ– ---
        async function exportExcel() {
            // ç²å–æ‰€æœ‰é¤é»è³‡æ–™ä»¥ä¾¿å°æ‡‰åˆ†é¡
            const { data: menuItems } = await _s.from('menu_items').select('name, categories(name)');
            const menuMap = {};
            menuItems.forEach(item => {
                menuMap[item.name] = item.categories?.name || 'ä¸€èˆ¬';
            });

            const exportData = window.allOrders.map(o => {
                const row = {
                    'é å®šæ™‚é–“': new Date(o.created_at).toLocaleString(),
                    'è¨‚ä½äºº': o.customer_name,
                    'é›»è©±': o.phone,
                    'äººæ•¸(å¤§)': o.adults,
                    'äººæ•¸(å…’-æ¤…)': o.kids_chair || 0,
                    'äººæ•¸(å…’-ä¸æ¤…)': o.toddlers || 0,
                    'ç¸½åƒ¹': o.total_price,
                    'ç‹€æ…‹': o.status === 'pending' ? 'è™•ç†ä¸­' : 'å·²å®Œæˆ'
                };

                // åˆ†æ‹†æ¯ä¸€é“èœï¼Œä¸¦åŠ ä¸Šåˆ†é¡æ¨™ç±¤
                o.order_content.forEach((item, index) => {
                    const catName = menuMap[item.name] || 'å…¶ä»–';
                    row[`å“é … ${index + 1}`] = `[${catName}] ${item.name} ($${item.price})`;
                });

                return row;
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "è¨‚å–®æ˜ç´°");
            XLSX.writeFile(wb, `çœŸç è¨‚å–®è©³ç´°å ±è¡¨_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // --- èœå–®ç®¡ç† ---
        async function loadMenuAdmin() {
            const { data } = await _s.from('menu_items').select('*, categories(name)').order('created_at', {ascending:false});
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = data.map(i => `
                <div class="bg-white rounded-2xl shadow-sm border overflow-hidden flex flex-col">
                    <div class="h-32 bg-white"><img src="${i.image_url || ''}" class="w-full h-full object-contain"></div>
                    <div class="p-4 flex-1">
                        <div class="flex justify-between font-bold"><span>${i.name}</span><span class="text-emerald-700">$${i.price}</span></div>
                        <p class="text-[10px] text-gray-400 mt-1">${i.categories?.name || 'æœªåˆ†é¡'}</p>
                        <div class="mt-4 flex flex-wrap gap-2">
                            ${i.is_set_menu ? `<button onclick="openGroupModal('${i.id}')" class="text-xs bg-amber-500 text-white px-3 py-1.5 rounded-lg shadow-sm">âš™ï¸ è¨­å®šåˆ†çµ„</button>` : ''}
                            <button onclick="toggleHide('${i.id}', ${i.is_hidden})" class="text-xs border px-3 py-1.5 rounded-lg">${i.is_hidden ? 'ğŸ‘ï¸ é¡¯ç¤º' : 'ğŸš« éš±è—'}</button>
                            <button onclick="deleteItem('${i.id}')" class="text-xs text-red-500 bg-red-50 px-3 py-1.5 rounded-lg">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function saveMenuItem() {
            const name = document.getElementById('m-name').value;
            const desc = document.getElementById('m-desc').value;
            const price = document.getElementById('m-price').value;
            const catId = document.getElementById('m-cat').value;
            const isSet = document.getElementById('m-is-set').checked;
            const file = document.getElementById('m-img').files[0];
            let imgUrl = "";
            if(file) {
                const path = `items/${Date.now()}.png`;
                await _s.storage.from('assets').upload(path, file);
                imgUrl = `${SUPABASE_URL}/storage/v1/object/public/assets/${path}`;
            }
            await _s.from('menu_items').insert([{ name, description: desc, price, category_id: catId, is_set_menu: isSet, image_url: imgUrl }]);
            closeMenuModal(); loadMenuAdmin();
        }

        // --- åŸºç¤ç³»çµ±åŠŸèƒ½ ---
        async function openGroupModal(id) {
            curItem = id;
            document.getElementById('group-modal').classList.remove('hidden');
            loadGroups();
        }

        async function loadGroups() {
            const { data } = await _s.from('set_menu_groups').select('*, set_menu_options(*)').eq('menu_item_id', curItem);
            document.getElementById('group-list-preview').innerHTML = data.map(g => `
                <div class="bg-stone-50 p-3 rounded-xl border flex justify-between items-center text-xs">
                    <div><span class="font-bold">${g.group_name} (é™ ${g.selection_limit})</span><br><span class="text-gray-400">${g.set_menu_options.map(o => o.option_name).join(',')}</span></div>
                    <button onclick="deleteGroup('${g.id}')" class="text-red-500">åˆªé™¤</button>
                </div>
            `).join('');
        }

        async function saveGroup() {
            const name = document.getElementById('g-name').value;
            const limit = document.getElementById('g-limit').value;
            const opts = document.getElementById('g-opts').value;
            if(!name || !opts) return;
            const { data: g } = await _s.from('set_menu_groups').insert([{ menu_item_id: curItem, group_name: name, selection_limit: limit }]).select();
            if(g) {
                const optList = opts.split(',').map(o => ({ group_id: g[0].id, option_name: o.trim() }));
                await _s.from('set_menu_options').insert(optList);
                document.getElementById('g-name').value=''; document.getElementById('g-opts').value='';
                loadGroups();
            }
        }

        async function uploadLogo() {
            const file = document.getElementById('logo-file').files[0];
            if(!file) return;
            const path = `logo/store_${Date.now()}.png`;
            await _s.storage.from('assets').upload(path, file);
            const url = `${SUPABASE_URL}/storage/v1/object/public/assets/${path}`;
            await _s.from('store_settings').update({ logo_url: url }).eq('id', 1);
            alert("Logo å·²æˆåŠŸæ›´æ–°");
            loadSettings();
        }

        async function loadSettings() {
            const { data } = await _s.from('store_settings').select('*').eq('id', 1).single();
            if(data?.logo_url) {
                document.getElementById('logo-preview-area').classList.remove('hidden');
                document.getElementById('cur-logo').src = data.logo_url;
            }
        }

        async function updateStatus(id, status) { await _s.from('orders').update({ status }).eq('id', id); loadOrders(); }
        async function toggleHide(id, cur) { await _s.from('menu_items').update({ is_hidden: !cur }).eq('id', id); loadMenuAdmin(); }
        async function deleteItem(id) { if(confirm('ç¢ºå®šåˆªé™¤é¤é»ï¼Ÿ')) { await _s.from('menu_items').delete().eq('id', id); loadMenuAdmin(); } }
        async function deleteGroup(id) { await _s.from('set_menu_groups').delete().eq('id', id); loadGroups(); }
        
        async function openMenuModal() { 
            document.getElementById('menu-modal').classList.remove('hidden'); 
            const { data } = await _s.from('categories').select('*').order('sort_order');
            document.getElementById('m-cat').innerHTML = data.map(c => `<option value="${c.id}">${c.name}</option>`).join(''); 
        }

        function closeMenuModal() { document.getElementById('menu-modal').classList.add('hidden'); }
        function closeGroupModal() { document.getElementById('group-modal').classList.add('hidden'); }

        // åˆå§‹åŒ–
        switchTab('orders');
    </script>
</body>
</html>
