<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çœŸç ç®¡ç†å¾Œå° - æ——è‰¦ä¿®æ­£ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>:root { --p-green: #004d40; } .bg-p-green { background-color: var(--p-green); }</style>
</head>
<body class="bg-slate-100 min-h-screen flex">
    <aside class="w-64 bg-emerald-900 text-white p-6 sticky top-0 h-screen shadow-xl">
        <h2 class="text-xl font-bold mb-10 border-b border-emerald-700 pb-4 text-center">çœŸç  ADMIN</h2>
        <nav class="space-y-2">
            <button onclick="switchTab('orders')" class="w-full text-left p-3 rounded hover:bg-emerald-800">ğŸ“‹ è¨‚å–®ç›£æ§</button>
            <button onclick="switchTab('menu')" class="w-full text-left p-3 rounded hover:bg-emerald-800">ğŸ± èœå–®/ä»‹ç´¹ç·¨è¼¯</button>
            <button onclick="switchTab('flavors')" class="w-full text-left p-3 rounded hover:bg-emerald-800">ğŸŒ¶ï¸ å£å‘³çµ„è¨­å®š</button>
        </nav>
    </aside>

    <main class="flex-1 p-8">
        <section id="sec-orders" class="space-y-6">
            <h2 class="text-2xl font-bold">è¨‚å–®ç›£æ§</h2>
            <div id="order-list" class="grid gap-4"></div>
        </section>

        <section id="sec-menu" class="hidden space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-bold">èœå–®ç·¨è¼¯</h2><button onclick="openMenuModal()" class="bg-p-green text-white px-6 py-2 rounded-lg">+ æ–°å¢é¤é»</button></div>
            <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <section id="sec-flavors" class="hidden space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-bold">å£å‘³çµ„ç®¡ç†</h2><button onclick="addFlavorGroup()" class="bg-amber-600 text-white px-6 py-2 rounded-lg">+ æ–°å¢å£å‘³çµ„</button></div>
            <div id="flavor-grid" class="grid gap-4"></div>
        </section>
    </main>

    <div id="menu-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-[100]">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-xl mb-4" id="modal-title">é¤é»è¨­å®š</h3>
            <input type="hidden" id="m-id">
            <div class="space-y-3">
                <input type="text" id="m-name" placeholder="åç¨±" class="w-full border p-3 rounded-xl">
                <textarea id="m-desc" placeholder="ä»‹ç´¹" class="w-full border p-3 rounded-xl"></textarea>
                <div class="grid grid-cols-2 gap-4"><input type="number" id="m-price" placeholder="åƒ¹æ ¼" class="border p-3 rounded-xl"><select id="m-cat" class="border p-3 rounded-xl"></select></div>
                <div class="bg-gray-50 p-3 rounded-xl"><p class="text-xs font-bold mb-2">å•Ÿç”¨å£å‘³èª¿æ•´ï¼š</p><div id="m-flavor-list" class="flex flex-wrap gap-2"></div></div>
                <label class="flex items-center gap-2 font-bold"><input type="checkbox" id="m-is-set"> å¥—é¤æ¨¡å¼</label>
            </div>
            <div class="flex gap-2 mt-6"><button onclick="closeMenuModal()" class="flex-1 bg-gray-100 py-3 rounded-xl">å–æ¶ˆ</button><button onclick="saveMenuItem()" class="flex-1 bg-p-green text-white py-3 rounded-xl">å„²å­˜</button></div>
        </div>
    </div>

    <div id="group-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center p-4 z-[200]">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="font-bold text-xl mb-4 text-p-green">è¨­å®šå¥—é¤èˆ‡é¸é …å£å‘³</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-2"><input type="text" id="g-name" placeholder="çµ„åˆ¥å" class="border p-2 rounded"><input type="number" id="g-limit" placeholder="é¸å¹¾é …" class="border p-2 rounded"></div>
                <div class="bg-yellow-50 p-3 rounded">
                    <p class="text-xs font-bold mb-1">æ–°å¢é¸é …èˆ‡é—œè¯å£å‘³ï¼š</p>
                    <div class="flex gap-2 mb-2"><input type="text" id="opt-name" class="flex-1 border p-2 text-sm" placeholder="é¸é …åç¨±"><select id="opt-flavor" class="border text-xs"><option value="">ç„¡å£å‘³</option></select></div>
                    <button onclick="addOptionToGroup()" class="w-full bg-amber-500 text-white py-1 rounded text-xs">åŠ å…¥é¸é …</button>
                    <div id="opt-list-preview" class="mt-2 space-y-1"></div>
                </div>
                <button onclick="saveFullGroup()" class="w-full bg-p-green text-white py-3 rounded-xl font-bold">å„²å­˜æ­¤åˆ†çµ„</button>
            </div>
            <button onclick="closeGroupModal()" class="w-full mt-4 text-gray-400">é—œé–‰</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
        const _s = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let curItemId = null, tempOptions = [];

        function switchTab(t) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`sec-${t}`).classList.remove('hidden');
            if(t === 'menu') loadMenuAdmin(); if(t === 'flavors') loadFlavorsAdmin(); if(t === 'orders') loadOrders();
        }

        async function loadMenuAdmin() {
            const { data } = await _s.from('menu_items').select('*, categories(name)').order('created_at', {ascending:false});
            document.getElementById('menu-grid').innerHTML = data.map(i => `
                <div class="bg-white p-4 rounded-xl shadow border">
                    <div class="flex justify-between font-bold"><span>${i.name}</span><span>$${i.price}</span></div>
                    <div class="mt-4 flex gap-2">
                        <button onclick="editItem('${i.id}')" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded">ç·¨è¼¯</button>
                        ${i.is_set_menu ? `<button onclick="openGroupModal('${i.id}')" class="text-xs bg-amber-500 text-white px-2 py-1 rounded">âš™ï¸ è¨­å®šå¥—é¤</button>` : ''}
                        <button onclick="deleteItem('${i.id}')" class="text-xs text-red-500 px-2 py-1 rounded">åˆªé™¤</button>
                    </div>
                </div>`).join('');
        }

        async function editItem(id) {
            const { data: item } = await _s.from('menu_items').select('*, item_flavor_relation(*)').eq('id', id).single();
            curItemId = id;
            document.getElementById('m-id').value = id;
            document.getElementById('m-name').value = item.name;
            document.getElementById('m-price').value = item.price;
            document.getElementById('m-desc').value = item.description || "";
            document.getElementById('m-is-set').checked = item.is_set_menu;
            openMenuModal(true);
        }

        async function saveMenuItem() {
            const id = document.getElementById('m-id').value;
            const payload = {
                name: document.getElementById('m-name').value,
                price: document.getElementById('m-price').value,
                description: document.getElementById('m-desc').value,
                category_id: document.getElementById('m-cat').value,
                is_set_menu: document.getElementById('m-is-set').checked
            };

            let res;
            if(id) res = await _s.from('menu_items').update(payload).eq('id', id).select();
            else res = await _s.from('menu_items').insert([payload]).select();

            if(res.data) {
                const itemId = res.data[0].id;
                await _s.from('item_flavor_relation').delete().eq('item_id', itemId);
                const checks = document.querySelectorAll('.flavor-chk:checked');
                const rels = Array.from(checks).map(c => ({ item_id: itemId, flavor_group_id: c.value }));
                await _s.from('item_flavor_relation').insert(rels);
                closeMenuModal(); loadMenuAdmin();
            }
        }

        async function openGroupModal(id) {
            curItemId = id; tempOptions = [];
            document.getElementById('group-modal').classList.remove('hidden');
            const { data: flavors } = await _s.from('flavor_groups').select('*');
            document.getElementById('opt-flavor').innerHTML = '<option value="">ç„¡å£å‘³</option>' + flavors.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
            document.getElementById('opt-list-preview').innerHTML = "";
        }

        function addOptionToGroup() {
            const name = document.getElementById('opt-name').value;
            const flavorId = document.getElementById('opt-flavor').value;
            const flavorName = document.getElementById('opt-flavor').options[document.getElementById('opt-flavor').selectedIndex].text;
            if(!name) return;
            tempOptions.push({ name, flavorId, flavorName });
            document.getElementById('opt-list-preview').innerHTML += `<div class="text-xs bg-white p-1 border">${name} ${flavorId ? `(${flavorName})` : ''}</div>`;
            document.getElementById('opt-name').value = "";
        }

        async function saveFullGroup() {
            const gName = document.getElementById('g-name').value;
            const limit = document.getElementById('g-limit').value;
            const { data: g } = await _s.from('set_menu_groups').insert([{ menu_item_id: curItemId, group_name: gName, selection_limit: limit }]).select();
            if(g) {
                for(let opt of tempOptions) {
                    const { data: o } = await _s.from('set_menu_options').insert([{ group_id: g[0].id, option_name: opt.name }]).select();
                    if(o && opt.flavorId) {
                        await _s.from('option_flavor_relation').insert([{ option_id: o[0].id, flavor_group_id: opt.flavorId }]);
                    }
                }
                alert("å¥—é¤åˆ†çµ„è¨­å®šå®Œæˆ"); closeGroupModal();
            }
        }

        async function openMenuModal(isEdit = false) {
            document.getElementById('menu-modal').classList.remove('hidden');
            if(!isEdit) { document.getElementById('m-id').value = ""; document.getElementById('m-name').value = ""; }
            const { data: cats } = await _s.from('categories').select('*');
            document.getElementById('m-cat').innerHTML = cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const { data: flavors } = await _s.from('flavor_groups').select('*');
            document.getElementById('m-flavor-list').innerHTML = flavors.map(f => `<label class="text-xs"><input type="checkbox" class="flavor-chk" value="${f.id}"> ${f.name}</label>`).join('');
        }

        function closeMenuModal() { document.getElementById('menu-modal').classList.add('hidden'); }
        function closeGroupModal() { document.getElementById('group-modal').classList.add('hidden'); }
        switchTab('orders');
    </script>
</body>
</html>
