<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>真珠 | 活動預點</title>
    <link rel="stylesheet" href="https://www.jinzhu.com.tw/bootstrap/css/bootstrap.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --p-green: #004d40; --p-gold: #b89150; --p-cream: #f9f5f0; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--p-cream); overflow-x: hidden; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .order-card { margin-top: 80px; background: #fff; border-radius: 2rem; box-shadow: 0 20px 40px rgba(0,0,0,0.08); }
        .img-contain { width: 100%; height: 100%; object-fit: contain; }
        .flavor-selected { border-color: var(--p-gold) !important; background-color: var(--p-green) !important; color: white !important; }
        .opt-selected { border: 2.5px solid var(--p-gold) !important; background-color: #fdf6e9 !important; font-weight: bold; }
        .btn-close-custom { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.4); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 50; }
    </style>
</head>
<body class="pb-24 text-slate-800 text-left">

    <header class="fixed top-0 w-full h-[60px] bg-white flex items-center justify-center shadow-sm z-[100]">
        <img src="https://www.jinzhu.com.tw/images/Jinzhu_logo.svg" style="max-height:35px">
    </header>

    <main class="max-w-xl mx-auto p-4">
        <div class="text-center mt-20 mb-6">
            <h2 id="event-name" class="text-2xl font-black text-p-green font-serif tracking-tight">專屬活動預點</h2>
            <p class="text-p-gold text-xs font-bold tracking-[0.3em] uppercase mt-1">Exclusive Menu</p>
        </div>

        <section id="step-1">
            <div class="order-card p-8 border border-white animate__animated animate__fadeIn">
                <div class="space-y-6">
                    <div><label class="text-[10px] font-bold text-stone-400 block mb-1 uppercase tracking-widest">姓名 Name</label><input type="text" id="custName" placeholder="請輸入訂位姓名" class="w-full border-b py-2 outline-none focus:border-p-green"></div>
                    <div><label class="text-[10px] font-bold text-stone-400 block mb-1 uppercase tracking-widest">電話 Phone</label><input type="tel" id="custPhone" placeholder="請輸入聯絡電話" class="w-full border-b py-2 outline-none focus:border-p-green"></div>
                    <button onclick="startOrder()" class="w-full bg-p-green text-white py-4 rounded-full font-bold shadow-lg mt-4 active:scale-95 transition">確認並進入選單</button>
                </div>
            </div>
        </section>

        <section id="step-2" class="hidden">
            <div id="menu-grid" class="grid grid-cols-1 gap-4"></div>
        </section>
        
        </main>

    <div id="detail-modal" class="fixed inset-0 bg-black/80 z-[110] hidden flex items-end justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md overflow-hidden flex flex-col relative rounded-t-[2rem] max-h-[85vh]">
            <button onclick="closeDetail()" class="btn-close-custom">✕</button>
            <div class="overflow-y-auto flex-1 no-scrollbar">
                <div class="h-48 bg-white flex items-center justify-center p-4"><img id="detail-img" src="" class="img-contain"></div>
                <div class="p-6">
                    <h3 id="detail-title" class="text-xl font-bold text-p-green font-serif"></h3>
                    <div id="flavor-container" class="mt-4 space-y-4"></div>
                    <div id="set-group-container" class="mt-6 space-y-6 border-t pt-6 text-left"></div>
                </div>
            </div>
            <div class="p-4 bg-stone-50 border-t flex items-center gap-3">
                <div class="flex items-center gap-3 bg-white border rounded-xl px-3 py-1">
                    <button onclick="changeQty(-1)" class="text-p-green font-bold">－</button>
                    <span id="item-qty" class="font-bold">1</span>
                    <button onclick="changeQty(1)" class="text-p-green font-bold">＋</button>
                </div>
                <button onclick="closeDetail()" class="flex-1 py-3 border rounded-xl text-stone-400 font-bold text-xs bg-white">取消</button>
                <button id="add-btn" class="flex-[2] bg-p-green text-white py-3 rounded-xl font-bold text-xs">加入清單</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
        const _s = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const urlParams = new URLSearchParams(window.location.search);
        const campaignCode = urlParams.get('code');
        let menuData = [], cart = [], guest = {}, tempItem = null, currentQty = 1;
        let targetCategoryId = null;

        async function init() {
            if(!campaignCode) return alert("無效網址");
            document.getElementById('event-name').innerText = campaignCode + " 限定選單";
            
            // 找出綁定了這個活動的分類
            const { data: cat } = await _s.from('categories').select('id').eq('campaign_code', campaignCode).single();
            if(!cat) return alert("此活動尚未配置菜單");
            targetCategoryId = cat.id;
        }
        init();

        async function startOrder() {
            guest = { name: document.getElementById('custName').value, phone: document.getElementById('custPhone').value };
            if(!guest.name || !guest.phone) return alert("請填寫姓名電話");
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-2').classList.remove('hidden');
            loadEventContent();
        }

        async function loadEventContent() {
            const { data: items } = await _s.from('menu_items')
                .select('*, item_flavor_relation(flavor_groups(*, flavor_options(*))), set_menu_groups(*, set_menu_contents(menu_items(*, item_flavor_relation(flavor_groups(*, flavor_options(*))))))')
                .eq('category_id', targetCategoryId).eq('is_hidden', false);
            
            menuData = items;
            document.getElementById('menu-grid').innerHTML = items.map(i => `
                <div class="bg-white rounded-3xl p-4 shadow-sm flex h-32 gap-4 border" onclick="openDetail('${i.id}')">
                    <div class="w-24 h-full flex-shrink-0"><img src="${i.image_url||''}" class="img-contain"></div>
                    <div class="flex-1 flex flex-col justify-between overflow-hidden">
                        <h3 class="font-bold text-p-green text-base font-serif truncate">${i.name}</h3>
                        <div class="flex justify-between items-end"><span class="text-p-gold font-bold">$${i.price}</span><span class="text-[9px] bg-stone-100 px-3 py-1.5 rounded-full font-bold text-stone-400">選擇</span></div>
                    </div>
                </div>`).join('');
        }

        async function finalSubmit() {
            const { error } = await _s.from('orders').insert([{
                customer_name: guest.name, phone: guest.phone,
                order_content: cart, total_price: cart.reduce((s,i)=>s+i.price,0),
                campaign_code: campaignCode, // 自動同步活動代號
                status: 'pending'
            }]);
            if(!error) alert("成功！");
        }
        // (其餘細節邏輯同 index.html)
    </script>
</body>
</html>
