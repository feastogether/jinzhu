<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>真珠 | 珍藏回憶 · 紀念照下載</title>
    <link rel="stylesheet" href="https://www.jinzhu.com.tw/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://www.jinzhu.com.tw/css/animate.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --p-green: #004d40; --p-gold: #b89150; --p-cream: #f9f5f0; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--p-cream); -webkit-tap-highlight-color: transparent; }
        .font-serif { font-family: 'Noto Serif TC', serif; }

        /* Navbar */
        .navbar-custom { background-color: #ffffff; height: 60px; display: flex; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: fixed; top: 0; width: 100%; z-index: 1000; }
        .navbar-brand img { max-height: 40px; image-rendering: -webkit-optimize-contrast; object-fit: contain; }

        /* 側邊選單 */
        .side-menu { position: fixed; top: 0; right: -320px; width: 320px; height: 100%; background: var(--p-green); z-index: 2000; transition: 0.4s; padding: 70px 0 0; box-shadow: -5px 0 15px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .side-menu.active { right: 0; }
        .menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1500; display: none; }
        .menu-overlay.active { display: block; }
        .menu-link { color: white; font-size: 1.1rem; font-weight: bold; text-decoration: none; display: block; padding: 16px 24px; border-bottom: 1px solid rgba(255,255,255,0.08); transition: background 0.2s; }
        .menu-link:hover { background: rgba(255,255,255,0.07); }
        .menu-link-active { color: var(--p-gold) !important; }

        /* KV */
        .kv-section { height: 100vh; overflow: hidden; position: relative; background: #1a1a1a; }
        .main-title { font-size: 2.2rem; letter-spacing: 0.15em; text-shadow: 0 2px 10px rgba(0,0,0,0.3); font-weight: 700; color: #fff; }

        /* 主卡片 */
        .main-card { margin-top: -180px; position: relative; z-index: 10; background: #fff; border-radius: 2rem; box-shadow: 0 20px 50px rgba(0,0,0,0.1); }

        /* 輸入框 */
        .field-input { width: 100%; border: none; border-bottom: 1.5px solid #e2e8f0; padding: 10px 0; font-size: 15px; font-weight: bold; background: transparent; outline: none; color: #1a2e2b; transition: border-color 0.2s; }
        .field-input:focus { border-color: var(--p-gold); }
        .field-input::placeholder { color: #cbd5e1; font-weight: normal; font-size: 14px; }

        /* 或分隔 */
        .or-divider { display: flex; align-items: center; gap: 8px; color: #d1d5db; font-size: 10px; font-weight: bold; letter-spacing: 0.15em; margin: 16px 0; }
        .or-divider::before, .or-divider::after { content: ''; flex: 1; height: 1px; background: #f1f5f9; }

        /* 搜尋按鈕 */
        .search-btn { width: 100%; background: var(--p-green); color: white; border: none; border-radius: 999px; padding: 15px; font-size: 15px; font-weight: bold; font-family: 'Noto Serif TC', serif; letter-spacing: 0.08em; cursor: pointer; transition: all 0.2s; box-shadow: 0 8px 24px rgba(0,77,64,0.2); margin-top: 8px; }
        .search-btn:active { transform: scale(0.97); }
        .search-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        /* 狀態文字 */
        .status-msg { display: none; text-align: center; padding: 16px 0 4px; font-size: 13px; font-weight: bold; }

        /* 結果區 */
        #result-area { display: none; }
        .result-divider { display: flex; align-items: center; gap: 8px; font-size: 10px; font-weight: bold; letter-spacing: 0.15em; margin: 20px 0 16px; }
        .result-divider::before, .result-divider::after { content: ''; flex: 1; height: 1px; }

        .photo-card { border-radius: 1.5rem; overflow: hidden; border: 1px solid #f1f5f9; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
        .photo-card img { width: 100%; aspect-ratio: 4/3; object-fit: cover; display: block; }

        .download-btn { display: block; width: 100%; background: var(--p-gold); color: white; text-align: center; padding: 13px; font-weight: bold; font-size: 14px; text-decoration: none; border-radius: 999px; transition: opacity 0.2s; box-shadow: 0 6px 16px rgba(184,145,80,0.25); }
        .download-btn:hover { opacity: 0.85; color: white; text-decoration: none; }
        .download-btn:active { opacity: 0.7; }

        /* 分頁點 */
        .photo-dots { display: flex; justify-content: center; gap: 7px; margin-top: 14px; }
        .photo-dot { width: 7px; height: 7px; border-radius: 50%; background: #e2e8f0; cursor: pointer; transition: background 0.2s, transform 0.2s; }
        .photo-dot.active { background: var(--p-gold); transform: scale(1.3); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-20 text-slate-800">

    <!-- Navbar -->
    <header class="navbar-custom px-4 justify-between">
        <a href="https://feastogether.github.io/jinzhu//index01.html" class="flex items-center gap-1 text-p-green text-sm font-bold">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
            返回
        </a>
        <a class="navbar-brand" href="https://feastogether.github.io/jinzhu//index01.html">
            <img id="main-logo" src="https://www.jinzhu.com.tw/images/Jinzhu_logo.svg" alt="logo">
        </a>
        <button onclick="toggleMenu()" class="text-p-green text-2xl px-2">☰</button>
    </header>

    <div id="menu-overlay" class="menu-overlay" onclick="toggleMenu()"></div>

    <!-- 右側選單 -->
    <nav id="side-menu" class="side-menu text-left">
        <button onclick="toggleMenu()" class="absolute top-4 right-4 text-white/50 hover:text-white text-2xl transition">✕</button>
        <a href="https://feastogether.github.io/jinzhu//index01.html" class="menu-link font-serif">首頁 Home</a>
        <a href="query.html"        class="menu-link font-serif">訂單查詢 Tracking</a>
        <a href="photo-search.html" class="menu-link font-serif menu-link-active">紀念照下載 Photos</a>
        <div class="mt-auto px-6 pb-8 text-white/20 text-[10px] uppercase tracking-widest text-center border-t border-white/5 pt-6">
            Jin Zhu Taichung
        </div>
    </nav>

    <!-- KV 背景 -->
    <div class="kv-section">
        <img id="kv-bg" src="" class="absolute inset-0 w-full h-full object-cover opacity-60">
        <div class="absolute inset-0 flex flex-col items-center justify-center text-center px-4">
            <p class="text-white/60 font-serif tracking-[0.35em] text-sm mb-3 animate__animated animate__fadeIn">珍藏回憶</p>
            <h1 class="main-title font-serif animate__animated animate__fadeIn">紀念照片下載</h1>
            <div class="w-10 h-0.5 mt-4 animate__animated animate__fadeIn animate__delay-1s" style="background:var(--p-gold)"></div>
            <p class="text-white/50 tracking-[0.2em] text-xs mt-3 animate__animated animate__fadeIn animate__delay-1s">Photos · Memories · Jin Zhu</p>
        </div>
    </div>

    <!-- 主內容 -->
    <main class="max-w-xl mx-auto px-4 relative z-20">

        <div class="main-card p-8 border border-white animate__animated animate__slideInUp">

            <h2 class="text-xl font-bold text-p-green text-center mb-2 font-serif tracking-widest uppercase">領取您的紀念照</h2>
            <p class="text-[11px] text-stone-400 text-center mb-8 tracking-wide">輸入姓名、電話或訂單號碼擇一即可</p>

            <!-- 單一輸入框 -->
            <div class="mb-6">
                <input id="input-keyword" type="text" class="field-input text-center text-base"
                    placeholder="姓名 ／ 電話 ／ 訂單號碼"
                    onkeydown="if(event.key==='Enter') doSearch()">
            </div>

            <button id="search-btn" class="search-btn" onclick="doSearch()">立即搜尋回憶</button>

            <!-- 搜尋中 -->
            <div id="status-searching" class="status-msg" style="color:#94a3b8">搜尋中⋯</div>

            <!-- 無結果 -->
            <div id="status-empty" class="status-msg" style="color:#f87171">
                找不到相符的紀念照
                <span style="display:block; font-weight:normal; font-size:12px; color:#94a3b8; margin-top:4px">請確認輸入的資料是否正確</span>
            </div>

            <!-- 結果 -->
            <div id="result-area">
                <div class="result-divider" style="color:var(--p-gold)">
                    <span>找到您的紀念照</span>
                </div>
                <div class="result-divider" style="display:none"></div>

                <div class="photo-card mb-5">
                    <img id="photo-img" src="" alt="紀念照">
                    <div class="p-4 pb-5">
                        <p id="photo-name" class="font-bold font-serif text-base mb-0.5" style="color:var(--p-green)"></p>
                        <p id="photo-note" class="text-xs mb-1" style="color:var(--p-gold)"></p>
                        <p id="photo-date" class="text-[10px] text-stone-300 mb-4"></p>
                        <a id="download-btn" href="" download class="download-btn">⬇ &nbsp;點此下載照片</a>
                    </div>
                </div>

                <div id="photo-dots" class="photo-dots"></div>
                <p id="multi-hint" class="text-center text-[10px] text-stone-300 mt-3 hidden">點擊圓點可切換多張照片</p>
            </div>

        </div>

        <p class="text-center text-stone-400 text-[10px] tracking-widest py-10">
            如有問題請致電：<a href="tel:0437027538" class="underline" style="color:var(--p-gold)">04-3702-7538</a>
        </p>

    </main>

    <script>
        const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
        const _s = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let foundPhotos = [];

        async function init() {
            const isMob = window.innerWidth <= 768;
            const { data } = await _s.from('store_settings').select('logo_url').eq('id', 1).single();
            if (data?.logo_url) document.getElementById('main-logo').src = `${data.logo_url}?t=${Date.now()}`;
            document.getElementById('kv-bg').src = isMob
                ? "https://www.jinzhu.com.tw/storage/website/kv/jinzhu20230904143032_Mobile-KV.jpeg"
                : "https://www.jinzhu.com.tw/storage/website/kv/jinzhu20230904143032_PC-KV.jpeg";
        }
        init();

        function toggleMenu() {
            document.getElementById('side-menu').classList.toggle('active');
            document.getElementById('menu-overlay').classList.toggle('active');
        }

        async function doSearch() {
            const kw = document.getElementById('input-keyword').value.trim();

            if (!kw) {
                document.getElementById('input-keyword').focus();
                return;
            }

            setStatus('searching');

            const { data, error } = await _s
                .from('customer_photos')
                .select('*')
                .or(`customer_name.ilike.%${kw}%,phone.ilike.%${kw}%,order_no.ilike.%${kw}%`)
                .order('created_at', { ascending: false });

            if (error || !data || data.length === 0) {
                setStatus('empty');
                return;
            }

            foundPhotos = data;
            setStatus('result');
            showPhoto(0);
            renderDots();
        }

        function showPhoto(idx) {
            const p = foundPhotos[idx];
            document.getElementById('photo-img').src        = p.photo_url;
            document.getElementById('photo-name').innerText = p.customer_name || '您的紀念照';
            document.getElementById('photo-note').innerText = p.note ? `✦ ${p.note}` : '';
            document.getElementById('photo-date').innerText = p.created_at
                ? '拍攝日期：' + new Date(p.created_at).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })
                : '';
            const dl   = document.getElementById('download-btn');
            dl.href     = p.photo_url;
            dl.download = `真珠紀念照_${p.customer_name || (idx + 1)}.jpg`;

            document.querySelectorAll('.photo-dot').forEach((d, i) =>
                d.classList.toggle('active', i === idx));
        }

        function renderDots() {
            const dots = document.getElementById('photo-dots');
            const hint = document.getElementById('multi-hint');
            if (foundPhotos.length <= 1) { dots.innerHTML = ''; hint.classList.add('hidden'); return; }
            hint.classList.remove('hidden');
            dots.innerHTML = foundPhotos.map((_, i) =>
                `<div class="photo-dot ${i === 0 ? 'active' : ''}" onclick="showPhoto(${i})"></div>`
            ).join('');
        }

        function setStatus(state) {
            document.getElementById('status-searching').style.display = state === 'searching' ? 'block' : 'none';
            document.getElementById('status-empty').style.display     = state === 'empty'     ? 'block' : 'none';
            document.getElementById('result-area').style.display      = state === 'result'    ? 'block' : 'none';
            const btn = document.getElementById('search-btn');
            btn.disabled  = state === 'searching';
            btn.innerText = state === 'searching' ? '搜尋中⋯' : '立即搜尋回憶';
        }
    </script>
</body>
</html>
